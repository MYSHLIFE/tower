((function(){var a=Object.prototype.hasOwnProperty,b=function(b,c){function e(){this.constructor=b}for(var d in c)a.call(c,d)&&(b[d]=c[d]);return e.prototype=c.prototype,b.prototype=new e,b.__super__=c.prototype,b},c=Array.prototype.slice;Metro.Store=function(){function a(a){a==null&&(a={}),this.name=a.name,this.className=a.className||Metro.namespaced(Metro.Support.String.camelize(Metro.Support.String.singularize(this.name)))}return b(a,Metro.Object),a.defaultLimit=100,a.atomicModifiers={$set:"$set",$unset:"$unset",$push:"$push",$pushAll:"$pushAll",$pull:"$pull",$pullAll:"$pullAll"},a.reservedOperators={_sort:"_sort",_limit:"_limit"},a.queryOperators={">=":"$gte",$gte:"$gte",">":"$gt",$gt:"$gt","<=":"$lte",$lte:"$lte","<":"$lt",$lt:"$lt",$in:"$in",$nin:"$nin",$any:"$any",$all:"$all","=~":"$regex",$m:"$regex",$regex:"$regex","!~":"$nm",$nm:"$nm","=":"$eq",$eq:"$eq","!=":"$neq",$neq:"$neq",$null:"$null",$notNull:"$notNull"},a.booleans={"true":!0,"true":!0,TRUE:!0,1:!0,1:!0,1:!0,"false":!1,"false":!1,FALSE:!1,0:!1,0:!1,0:!1},a.prototype.serialize=function(a){var b,c,d;for(b=0,d=a.length;b<d;b++)c=a[b],a[b]=this.serializeModel(c);return a},a.prototype.deserialize=function(a){var b,c,d;for(b=0,d=a.length;b<d;b++)c=a[b],a[b]=this.deserializeModel(c);return a},a.prototype.serializeModel=function(a){var b;return b=Metro.constant(this.className),new b(a)},a.prototype.deserializeModel=function(a){return a.attributes},a.prototype.find=function(){var a,b,d,e,f;return b=4<=arguments.length?c.call(arguments,0,f=arguments.length-3):(f=0,[]),e=arguments[f++],d=arguments[f++],a=arguments[f++],b.length===1?(e.id=b[0],this.findOne(e,d,a)):(e.id={$in:b},this.all(e,d,a))},a.prototype.first=function(a,b,c){return this.findOne(a,b,c)},a.prototype.last=function(a,b,c){return this.findOne(a,b,c)},a.prototype.build=function(a,b,c){var d;return d=this.serializeModel(a),c&&c.call(this,null,d),d},a.prototype.update=function(){var a,b,d,e,f,g;return b=5<=arguments.length?c.call(arguments,0,g=arguments.length-4):(g=0,[]),f=arguments[g++],e=arguments[g++],d=arguments[g++],a=arguments[g++],e.id={$in:b},this.updateAll(f,e,d,a)},a.prototype["delete"]=function(){var a,b,d,e,f;return b=4<=arguments.length?c.call(arguments,0,f=arguments.length-3):(f=0,[]),e=arguments[f++],d=arguments[f++],a=arguments[f++],e.id=b.length===1?b[0]:{$in:b},this.deleteAll(e,d,a)},a.prototype.schema=function(){return Metro.constant(this.className).schema()},a}(),Metro.Store.Memory=function(){function a(b){a.__super__.constructor.call(this,b),this.records={},this.lastId=0}return b(a,Metro.Store),a}(),Metro.Store.Memory.Finders={all:function(a,b,c){var d,e,f,g,h,i,j;h=[],g=this.records,i=this;if(Metro.Support.Object.isPresent(a)){j=b.sort,e=b.limit||Metro.Store.defaultLimit;for(d in g)f=g[d],this.matches(f,a)&&h.push(f);j&&(h=this.sort(h,j)),e&&(h=h.slice(0,e-1+1||9e9))}else for(d in g)f=g[d],h.push(f);return c&&c.call(i,null,h),h},first:function(a,b,c){var d;return d=null,this.all(a,b,function(a,b){d=b[0];if(c)return c.call(this,a,d)}),d},last:function(a,b,c){var d;return d=null,this.all(a,b,function(a,b){d=b[b.length-1];if(c)return c.call(this,a,d)}),d},count:function(a,b,c){var d;return d=0,this.all(a,b,function(a,b){d=b.length;if(c)return c.call(this,a,d)}),d},sort:function(){var a;return(a=Metro.Support.Array).sortBy.apply(a,arguments)}},Metro.Store.Memory.Persistence={create:function(a,b,c){var d,e;return(e=a.id)==null&&(a.id=this.generateId()),d=this.serializeModel(a),this.records[a.id]=d,c&&c.call(this,null,d),d},updateAll:function(a,b,c,d){var e;return e=this,this.all(b,c,function(b,c){var f,g,h,i,j;if(!b)for(f=0,j=c.length;f<j;f++){h=c[f];for(g in a)i=a[g],e._updateAttribute(h.attributes,g,i)}if(d)return d.call(this,b,c)})},deleteAll:function(a,b,c){var d;return d=this.records,Metro.Support.Object.isBlank(a)?this.clear(c):this.all(a,function(a,b){var e,f,g;if(!a)for(f=0,g=b.length;f<g;f++)e=b[f],d.splice(d.indexOf(e),1);if(c)return c.call(this,a,b)})},clear:function(a){return this.records={},a&&a.call(this,error,records),this.records}},Metro.Store.Memory.Serialization={matches:function(a,b){var c,d,e,f,g,h;f=this,g=!0,e=this.schema();for(c in b){h=b[c];if(!!Metro.Store.reservedOperators[c])continue;d=a[c],Metro.Support.Object.isRegExp(h)?g=d.match(h):typeof h=="object"?g=f._matchesOperators(a,d,h):(typeof h=="function"&&(h=h.call(a)),g=d===h);if(!g)return!1}return!0},generateId:function(){return this.lastId++},_updateAttribute:function(a,b,c){var d;return d=this.schema()[b],d&&d.type==="Array"&&!Metro.Support.Object.isArray(c)?(a[b]||(a[b]=[]),a[b].push(c)):this._atomicModifier(b)?this["_"+b.replace("$","")+"AtomicUpdate"](a,c):a[b]=c},_atomicModifier:function(a){return!!this.constructor.atomicModifiers[a]},_pushAtomicUpdate:function(a,b){var c,d;for(c in b)d=b[c],a[c]||(a[c]=[]),a[c].push(d);return a},_pullAtomicUpdate:function(a,b){var c,d,e,f,g,h;for(f in b){h=b[f],d=a[f];if(d)for(e=0,g=h.length;e<g;e++)c=h[e],d.splice(d.indexOf(c),1)}return a},_matchesOperators:function(a,b,c){var d,e,f,g,h;g=!0,f=this;for(d in c){h=c[d];if(!(e=Metro.Store.queryOperators[d]))return b===c;typeof h=="function"&&(h=h.call(a));switch(e){case"$gt":g=f._isGreaterThan(b,h);break;case"$gte":g=f._isGreaterThanOrEqualTo(b,h);break;case"$lt":g=f._isLessThan(b,h);break;case"$lte":g=f._isLessThanOrEqualTo(b,h);break;case"$eq":g=f._isEqualTo(b,h);break;case"$neq":g=f._isNotEqualTo(b,h);break;case"$regex":g=f._isMatchOf(b,h);break;case"$nm":g=f._isNotMatchOf(b,h);break;case"$any":g=f._anyIn(b,h);break;case"$all":g=f._allIn(b,h)}if(!g)return!1}return!0},_isGreaterThan:function(a,b){return a&&a>b},_isGreaterThanOrEqualTo:function(a,b){return a&&a>=b},_isLessThan:function(a,b){return a&&a<b},_isLessThanOrEqualTo:function(a,b){return a&&a<=b},_isEqualTo:function(a,b){return a===b},_isNotEqualTo:function(a,b){return a!==b},_isMatchOf:function(a,b){return typeof a=="string"?!!a.match(b):!!a.exec(b)},_isNotMatchOf:function(a,b){return typeof a=="string"?!a.match(b):!a.exec(b)},_anyIn:function(a,b){var c,d,e;for(d=0,e=b.length;d<e;d++){c=b[d];if(a.indexOf(c)>-1)return!0}return!1},_allIn:function(a,b){var c,d;for(c=0,d=array.length;c<d;c++){b=array[c];if(a.indexOf(b)===-1)return!1}return!0}},Metro.Store.Memory.include(Metro.Store.Memory.Finders),Metro.Store.Memory.include(Metro.Store.Memory.Persistence),Metro.Store.Memory.include(Metro.Store.Memory.Serialization)})).call(this)