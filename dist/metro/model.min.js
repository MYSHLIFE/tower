((function(){var a=Array.prototype.slice;Metro.Model=function(){function a(a){var b,c,d,e,f,g;a==null&&(a={}),b={},d=this.constructor.keys();for(e in a)g=a[e],b[e]=g;for(f in d)c=d[f],a.hasOwnProperty(f)||b[f]||(b[f]=c.defaultValue(this));this.attributes=this.typeCastAttributes(b),this.changes={}}return a.initialize=function(){return Metro.Support.Dependencies.load(""+Metro.root+"/app/models")},a.teardown=function(){return delete this._store},a.store=function(){return this._store||(this._store=new Metro.Store.Memory)},a}(),Metro.Model.Scope=function(){function a(a){this.sourceClassName=a,this.conditions=[]}return a.prototype.where=function(){return this.conditions.push(["where",arguments]),this},a.prototype.order=function(){return this.conditions.push(["order",arguments]),this},a.prototype.limit=function(){return this.conditions.push(["limit",arguments]),this},a.prototype.select=function(){return this.conditions.push(["select",arguments]),this},a.prototype.joins=function(){return this.conditions.push(["joins",arguments]),this},a.prototype.includes=function(){return this.conditions.push(["includes",arguments]),this},a.prototype.within=function(){return this.conditions.push(["within",arguments]),this},a.prototype.all=function(a){return this.store().all(this.query(),a)},a.prototype.first=function(a){return this.store().first(this.query(),a)},a.prototype.last=function(a){return this.store().last(this.query(),a)},a.prototype.sourceClass=function(){return global[this.sourceClassName]},a.prototype.store=function(){return global[this.sourceClassName].store()},a.prototype.query=function(){var a,b,c,d,e,f,g,h;b=this.conditions,e={};for(g=0,h=b.length;g<h;g++){a=b[g];switch(a[0]){case"where":c=a[1][0];for(d in c)f=c[d],e[d]=f;break;case"order":e._sort=a[1][0]}}return e},a}(),Metro.Model.Association=function(){function a(a,b){this.owner=a,this.reflection=b}return a.include(Metro.Model.Scope),a.prototype.targetClass=function(){return global[this.reflection.targetClassName]},a.prototype.scoped=function(){return(new Metro.Model.Scope(this.reflection.targetClassName)).where(this.conditions())},a.prototype.conditions=function(){var a;return a={},this.owner.id&&this.reflection.foreignKey&&(a[this.reflection.foreignKey]=this.owner.id),a},a.delegates("where","find","all","first","last","store",{to:"scoped"}),a}(),Metro.Model.Associations=function(){function a(){}return a.hasOne=function(a,b){b==null&&(b={})},a.hasMany=function(a,b){var c;return b==null&&(b={}),b.foreignKey=""+Metro.Support.String.underscore(this.name)+"Id",this.reflections()[a]=c=new Metro.Model.Reflection("hasMany",this.name,a,b),Object.defineProperty(this.prototype,a,{enumerable:!0,configurable:!0,get:function(){return this._getHasManyAssociation(a)},set:function(b){return this._setHasManyAssociation(a,b)}}),c},a.belongsTo=function(a,b){var c;return b==null&&(b={}),this.reflections()[a]=c=new Metro.Model.Association("belongsTo",this.name,a,b),Object.defineProperty(this.prototype,a,{enumerable:!0,configurable:!0,get:function(){return this._getBelongsToAssocation(a)},set:function(b){return this._setBelongsToAssocation(a,b)}}),this.keys()[""+a+"Id"]=new Metro.Model.Attribute(""+a+"Id",b),Object.defineProperty(this.prototype,""+a+"Id",{enumerable:!0,configurable:!0,get:function(){return this._getBelongsToAssocationId(""+a+"Id")},set:function(b){return this._setBelongsToAssocationId(""+a+"Id",b)}}),c},a.reflections=function(){return this._reflections||(this._reflections={})},a.prototype._getHasManyAssociation=function(a){return this.constructor.reflections()[a].association(this.id)},a.prototype._setHasManyAssociation=function(a,b){return this.constructor.reflections()[a].association(this.id).destroyAll()},a.prototype._getBelongsToAssocationId=function(a){return this.attributes[a]},a.prototype._setBelongsToAssocationId=function(a,b){return this.attributes[a]=b},a.prototype._getBelongsToAssocation=function(a){var b;return b=this._getBelongsToAssocationId(a),b?global[this.reflections()[a].targetClassName].where({id:this.id}).first():null},a.prototype._setBelongsToAssocation=function(a,b){var c;return c=this._getBelongsToAssocationId(a),c?global[this.reflections()[a].targetClassName].where({id:this.id}).first():null},a}(),Metro.Model.Attribute=function(){function a(a,b){b==null&&(b={}),this.name=a,this.type=b.type||"string",this._default=b["default"],this.typecastMethod=function(){switch(this.type){case Array:case"array":return this._typecastArray;case Date:case"date":case"time":return this._typecastDate;case Number:case"number":case"integer":return this._typecastInteger;case"float":return this._typecastFloat;default:return this._typecastString}}.call(this)}return a.prototype.typecast=function(a){return this.typecastMethod.call(this,a)},a.prototype._typecastArray=function(a){return a},a.prototype._typecastString=function(a){return a},a.prototype._typecastDate=function(a){return a},a.prototype._typecastInteger=function(a){return a===null||a===void 0?null:parseInt(a)},a.prototype._typecastFloat=function(a){return a===null||a===void 0?null:parseFloat(a)},a.prototype.defaultValue=function(a){var b;b=this._default;switch(typeof b){case"function":return b.call(a);default:return b}},a}(),Metro.Model.Attributes=function(){function a(){}return a.key=function(a,b){return b==null&&(b={}),this.keys()[a]=new Metro.Model.Attribute(a,b),Object.defineProperty(this.prototype,a,{enumerable:!0,configurable:!0,get:function(){return this.getAttribute(a)},set:function(b){return this.setAttribute(a,b)}}),this},a.keys=function(){return this._keys||(this._keys={})},a.attributeDefinition=function(a){var b;b=this.keys()[a];if(!b)throw new Error("Attribute '"+a+"' does not exist on '"+this.name+"'");return b},a.prototype.typeCast=function(a,b){return this.constructor.attributeDefinition(a).typecast(b)},a.prototype.typeCastAttributes=function(a){var b,c;for(b in a)c=a[b],a[b]=this.typeCast(b,c);return a},a.prototype.getAttribute=function(a){var b;return(b=this.attributes)[a]||(b[a]=this.constructor.keys()[a].defaultValue(this))},a.hasOwnProperty("get")||a.alias("get","getAttribute"),a.prototype.setAttribute=function(a,b){var c;return c=this._trackChangedAttribute(a,b),this.attributes[a]=b},a.hasOwnProperty("set")||a.alias("set","setAttribute"),a}(),Metro.Model.Dirty=function(){function a(){}return a.prototype.isDirty=function(){var a,b;b=this.changes();for(a in b)return!0;return!1},a.prototype.changes=function(){return this._changes||(this._changes={})},a.prototype._trackChangedAttribute=function(a,b){var c,d,e;return c=(e=this.changes)[a]||(e[a]=[]),d=c[0]||(c[0]=this.attributes[a]),c[1]=b,c[0]===c[1]&&(c=null),c?this.changes[a]=c:delete this.changes[a],d},a}(),Metro.Model.Persistence=function(){function a(){}return a.create=function(a){var b;return b=new this(a),this.store().create(b),b},a.update=function(){},a.deleteAll=function(){return this.store().clear()},a.prototype.isNew=function(){return!attributes.id},a.prototype.save=function(a){return runCallbacks(function(){})},a.prototype.update=function(a){},a.prototype.reset=function(){},a.alias("reload","reset"),a.prototype.updateAttribute=function(a,b){},a.prototype.updateAttributes=function(a){},a.prototype.increment=function(a,b){b==null&&(b=1)},a.prototype.decrement=function(a,b){b==null&&(b=1)},a.prototype.reload=function(){},a.prototype["delete"]=function(){},a.prototype.destroy=function(){},a.prototype.createOrUpdate=function(){},a.prototype.isDestroyed=function(){},a.prototype.isPersisted=function(){},a}(),Metro.Model.Reflection=function(){function a(a,b,c,d){d==null&&(d={}),this.type=a,this.sourceClassName=b,this.targetClassName=d.className||Metro.Support.String.camelize(Metro.Support.String.singularize(c)),this.foreignKey=d.foreignKey}return a.prototype.targetClass=function(){return global[this.targetClassName]},a.prototype.association=function(a){return new Metro.Model.Association(a,this)},a}(),Metro.Model.Scopes=function(){function a(){}return a.scope=function(a,b){return this[a]=b instanceof Metro.Model.Scope?b:this.where(b)},a.where=function(){var a;return(a=this.scoped()).where.apply(a,arguments)},a.order=function(){var a;return(a=this.scoped()).order.apply(a,arguments)},a.limit=function(){var a;return(a=this.scoped()).limit.apply(a,arguments)},a.select=function(){var a;return(a=this.scoped()).select.apply(a,arguments)},a.joins=function(){var a;return(a=this.scoped()).joins.apply(a,arguments)},a.includes=function(){var a;return(a=this.scoped()).includes.apply(a,arguments)},a.within=function(){var a;return(a=this.scoped()).within.apply(a,arguments)},a.scoped=function(){return new Metro.Model.Scope(this.name)},a.all=function(a){return this.store().all(a)},a.first=function(a){return this.store().first(a)},a.last=function(a){return this.store().last(a)},a.find=function(a,b){return this.store().find(a,b)},a.count=function(a){return this.store().count(a)},a.exists=function(a){return this.store().exists(a)},a}(),Metro.Model.Serialization=function(){function a(){}return a.prototype.toXML=function(){},a.prototype.toJSON=function(){return JSON.stringify(this.attributes)},a.prototype.toObject=function(){},a.prototype.clone=function(){},a.fromJSON=function(a){var b,c,d,e;d=JSON.parse(a),d instanceof Array||(d=[d]);for(b=0,e=d.length;b<e;b++)c=d[b],d[b]=new this(c);return d},a}(),Metro.Model.Validation=function(){function a(a,b){this.name=a,this.value=b,this.attributes=Array.prototype.slice.call(arguments,2,arguments.length),this.validationMethod=function(){switch(a){case"presence":return this.validatePresence;case"min":return this.validateMinimum;case"max":return this.validateMaximum;case"count":case"length":return this.validateLength;case"format":return typeof this.value=="string"&&(this.value=new RegExp(this.value)),this.validateFormat}}.call(this)}return a.prototype.validate=function(a){var b,c,d,e,f;c=!0,f=this.attributes;for(d=0,e=f.length;d<e;d++)b=f[d],this.validationMethod(a,b)||(c=!1);return c},a.prototype.validatePresence=function(a,b){return a[b]?!0:(a.errors().push({attribute:b,message:Metro.Support.I18n.t("metro.model.errors.validation.presence",{attribute:b})}),!1)},a.prototype.validateMinimum=function(a,b){var c;return c=a[b],typeof c=="number"&&c>=this.value?!0:(a.errors().push({attribute:b,message:Metro.Support.I18n.t("metro.model.errors.validation.minimum",{attribute:b,value:c})}),!1)},a.prototype.validateMaximum=function(a,b){var c;return c=a[b],typeof c=="number"&&c<=this.value?!0:(a.errors().push({attribute:b,message:""+b+" must be a maximum of "+this.value}),!1)},a.prototype.validateLength=function(a,b){var c;return c=a[b],typeof c!="number"||c!==this.value?(a.errors().push({attribute:b,message:""+b+" must be equal to "+this.value}),!1):!0},a.prototype.validateFormat=function(a,b){var c;return c=a[b],this.value.exec(c)?!0:(a.errors().push({attribute:b,message:""+b+" must be match the format "+this.value.toString()}),!1)},a}(),Metro.Model.Validations=function(){function b(){b.__super__.constructor.apply(this,arguments)}return b.validates=function(){var b,c,d,e,f,g;b=Array.prototype.slice.call(arguments,0,arguments.length),d=b.pop(),typeof d!="object"&&Metro.throw_error("missing_options",""+this.name+".validates"),e=this.validators(),g=[];for(c in d)f=d[c],g.push(e.push(function(a,b,c){c.prototype=a.prototype;var d=new c,e=a.apply(d,b);return typeof e=="object"?e:d}(Metro.Model.Validation,[c,f].concat(a.call(b)),function(){})));return g},b.validators=function(){return this._validators||(this._validators=[])},b.prototype.validate=function(){var a,b,c,d,e,f;a=this,d=this.constructor.validators(),b=!0,this.errors().length=0;for(e=0,f=d.length;e<f;e++)c=d[e],c.validate(a)||(b=!1);return b},b.prototype.errors=function(){return this._errors||(this._errors=[])},b}(),Metro.Model.include(Metro.Model.Persistence),Metro.Model.include(Metro.Model.Scopes),Metro.Model.include(Metro.Model.Serialization),Metro.Model.include(Metro.Model.Associations),Metro.Model.include(Metro.Model.Validations),Metro.Model.include(Metro.Model.Dirty),Metro.Model.include(Metro.Model.Attributes)})).call(this)