((function(){var a,b,c,d,e,f,g,h,i,j=Object.prototype.hasOwnProperty,k=function(a,b){function d(){this.constructor=a}for(var c in b)j.call(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a},l=Array.prototype.slice;Metro.Model=function(){function a(a){var b,c,d,e,f,g;a==null&&(a={}),d=this.constructor.fields(),b={};for(e in a)g=a[e],b[e]=g;for(f in d)c=d[f],a.hasOwnProperty(f)||b[f]||(b[f]=c.defaultValue(this));this.attributes=b,this.changes={},this.errors={},this.readonly=!1}return k(a,Metro.Object),a}(),Metro.Model.Scope=function(){function f(a){a==null&&(a={}),this.model=a.model,this.criteria=a.criteria||new Metro.Model.Criteria}var a,b,c,d,e;k(f,Metro.Object),f.scopes=["where","order","asc","desc","limit","offset","select","joins","includes","excludes","paginate","within"],f.finders=["find","all","first","last","count"],f.builders=["build","create","update","updateAll","delete","deleteAll","destroy","destroyAll"],e=f.scopes,b=function(a){return this.prototype[a]=function(){var b;return(b=this.criteria)[a].apply(b,arguments),this}};for(c=0,d=e.length;c<d;c++)a=e[c],b.call(f,a);return f.prototype.find=function(){var a,b,c,d;return b=2<=arguments.length?l.call(arguments,0,c=arguments.length-1):(c=0,[]),a=arguments[c++],(d=this.store()).find.apply(d,l.call(b).concat([this.criteria.query],[this.criteria.options],[a]))},f.prototype.all=function(a){return this.store().all(this.criteria.query,this.criteria.options,a)},f.prototype.first=function(a){return this.store().first(this.criteria.query,this.criteria.options,a)},f.prototype.last=function(a){return this.store().last(this.criteria.query,this.criteria.options,a)},f.prototype.count=function(a){return this.store().count(this.criteria.query,this.criteria.options,a)},f.prototype.build=function(a,b){return this.store().build(Metro.Support.Object.extend(this.criteria.query,a),this.criteria.options,b)},f.prototype.create=function(a,b){return this.store().create(Metro.Support.Object.extend(this.criteria.query,a),this.criteria.options,b)},f.prototype.update=function(){var a,b,c,d,e;return b=3<=arguments.length?l.call(arguments,0,d=arguments.length-2):(d=0,[]),c=arguments[d++],a=arguments[d++],(e=this.store()).update.apply(e,l.call(b).concat([c],[this.criteria.query],[this.criteria.options],[a]))},f.prototype.updateAll=function(a,b){return this.store().updateAll(a,this.criteria.query,this.criteria.options,b)},f.prototype["delete"]=function(){var a,b,c,d;return b=2<=arguments.length?l.call(arguments,0,c=arguments.length-1):(c=0,[]),a=arguments[c++],(d=this.store())["delete"].apply(d,l.call(b).concat([this.criteria.query],[this.criteria.options],[a]))},f.prototype.deleteAll=function(a){return this.store().deleteAll(this.criteria.query,this.criteria.options,a)},f.prototype.destroy=function(){var a,b,c,d;return b=2<=arguments.length?l.call(arguments,0,c=arguments.length-1):(c=0,[]),a=arguments[c++],(d=this.store())["delete"].apply(d,l.call(b).concat([this.criteria.query],[this.criteria.options],[a]))},f.prototype.destroyAll=function(a){return this.store().deleteAll(this.criteria.query,this.criteria.options,a)},f.prototype.store=function(){return this.model.store()},f.prototype.clone=function(){return new this({model:this.model,criteria:this.criteria.clone()})},f}(),Metro.Model.Callbacks={},Metro.Model.Criteria=function(){function a(a,b){a==null&&(a={}),b==null&&(b={}),this.query=a,this.options=b}return a.prototype._mergeQuery=function(a){return a==null&&(a={}),Metro.Support.Object.extend(this.query,a)},a.prototype._mergeOptions=function(a){return a==null&&(a={}),Metro.Support.Object.extend(this.options,a)},a.prototype.where=function(a){return this._mergeQuery(a)},a.prototype.order=function(a,b){return b==null&&(b="asc"),this._mergeOptions({sort:[a,b]})},a.prototype.offset=function(a){return this._mergeOptions({offset:a})},a.prototype.limit=function(a){return this._mergeOptions({limit:a})},a.prototype.select=function(){return this._mergeOptions({fields:Metro.Support.Array.args(arguments)})},a.prototype.joins=function(){return this._mergeOptions({joins:Metro.Support.Array.args(arguments)})},a.prototype.includes=function(){return this._mergeOptions({includes:Metro.Support.Array.args(arguments)})},a.prototype.paginate=function(a){var b,c;return b=a.perPage||a.limit,c=a.page||0,this.limit(b),this.offset(c*b)},a.prototype.within=function(a){return this},a.prototype.clone=function(){return new this(Metro.Support.Object.cloneHash(this.query),Metro.Support.Object.cloneHash(this.options))},a}(),Metro.Model.Dirty={isDirty:function(){return Metro.Support.Object.isPresent(this.changes)},_attributeChange:function(a,b){var c,d,e;return c=(e=this.changes)[a]||(e[a]=[]),d=c[0]||(c[0]=this.attributes[a]),c[1]=b,c[0]===c[1]&&(c=null),c?this.changes[a]=c:delete this.changes[a],d},toUpdates:function(){var a,b,c,d,e;d={},b=this.attributes,e=this.changes;for(c in e)a=e[c],d[c]=b[c];return d}},Metro.Model.Metadata={ClassMethods:{baseClass:function(){return this.__super__&&this.__super__.constructor.baseClass&&this.__super__.constructor!==Metro.Model?this.__super__.constructor.baseClass():this},stiName:function(){},toParam:function(){return Metro.Support.String.parameterize(this.className())}},toLabel:function(){return this.className()},toPath:function(){return this.constructor.toParam()+"/"+this.toParam()},toParam:function(){return this.get("id").toString()}},Metro.Model.Inheritance={_computeType:function(){}},Metro.Model.Relation=function(){function a(a,b,c,d){var e,f;c==null&&(c={});for(e in c)f=c[e],this[e]=f;this.owner=a,this.name=b,this.targetClassName=c.type||c.className||Metro.namespaced(Metro.Support.String.camelize(b)),this.dependent||(this.dependent=!1),this.counterCache||(this.counterCache=!1),this.hasOwnProperty("cache")||(this.cache=!1),this.hasOwnProperty("readOnly")||(this.readOnly=!1),this.hasOwnProperty("validate")||(this.validate=!1),this.hasOwnProperty("autoSave")||(this.autoSave=!1),this.hasOwnProperty("touch")||(this.touch=!1),this.inverseOf||(this.inverseOf=void 0),this.hasOwnProperty("polymorphic")||(this.polymorphic=!1),this.hasOwnProperty("default")||(this["default"]=!1)}return k(a,Metro.Object),a.prototype.scoped=function(a){return new this.constructor.Scope({model:Metro.constant(this.targetClassName),owner:a,relation:this})},a.Scope=function(){function a(b){b==null&&(b={}),a.__super__.constructor.apply(this,arguments),this.owner=b.owner,this.relation=b.relation,this.foreignKey=this.relation.foreignKey}return k(a,Metro.Model.Scope),a.prototype.constructable=function(){return!this.relation.polymorphic},a}(),a}(),Metro.Model.Relation.BelongsTo=function(){function a(b,c,d){var e;d==null&&(d={}),a.__super__.constructor.call(this,b,c,d),b.field(""+c+"Id",{type:"Id"}),b.prototype[c]=function(a){return this.relation(c).first(a)},e=this,b.prototype["build"+Metro.Support.String.camelize(c)]=function(a,b){return this.buildRelation(c,a,b)},b.prototype["create"+Metro.Support.String.camelize(c)]=function(a,b){return this.createRelation(c,a,b)}}return k(a,Metro.Model.Relation),a.Scope=function(){function b(){b.__super__.constructor.apply(this,arguments)}return k(b,a.Scope),b}(),a}(),Metro.Model.Relation.HasMany=function(){function a(b,c,d){d==null&&(d={}),a.__super__.constructor.call(this,b,c,d),b.prototype[c]=function(){return this.relation(c)},this.foreignKey=d.foreignKey||Metro.Support.String.camelize(""+b.name+"Id",!0),this.cache&&(typeof this.cache=="string"?(this.cache=!0,this.cacheKey=this.cacheKey):this.cacheKey=Metro.Support.String.singularize(c)+"Ids",this.owner.field(this.cacheKey,{type:"Array","default":[]}))}return k(a,Metro.Model.Relation),a.Scope=function(){function b(a){var c,d;a==null&&(a={}),b.__super__.constructor.apply(this,arguments),d=this.owner.get("id"),this.foreignKey&&d!==void 0&&(c={},c[this.foreignKey]=d,this.where(c))}return k(b,a.Scope),b.prototype.create=function(a,b){var c,d;return d=this,c=this.relation,this.store().create(Metro.Support.Object.extend(this.criteria.query,a),this.criteria.options,function(a,e){var f;if(!a){if(c&&c.cache)return f={},f[c.cacheKey]=e.get("id"),d.owner.updateAttributes({$push:f},b);if(b)return b.call(this,a,e)}else if(b)return b.call(this,a,e)})},b}(),a}(),Metro.Model.Relation.HasOne=function(){function a(){a.__super__.constructor.apply(this,arguments)}return k(a,Metro.Model.Relation),a}(),Metro.Model.Relations={ClassMethods:{hasOne:function(a,b){return this.relations()[a]=new Metro.Model.Relation.HasOne(this,a,b)},hasMany:function(a,b){return this.relations()[a]=new Metro.Model.Relation.HasMany(this,a,b)},belongsTo:function(a,b){return this.relations()[a]=new Metro.Model.Relation.BelongsTo(this,a,b)},relations:function(){return this._relations||(this._relations={})},relation:function(a){var b;b=this.relations()[a];if(!b)throw new Error("Relation '"+a+"' does not exist on '"+this.name+"'");return b}},InstanceMethods:{relation:function(a){return this.constructor.relation(a).scoped(this)},buildRelation:function(a,b,c){return this.relation(a).build(b,c)},createRelation:function(a,b,c){return this.relation(a).create(b,c)}}},Metro.Model.Field=function(){function a(a,b,c){var d;c==null&&(c={}),this.owner=a,this.name=d=b,this.type=c.type||"string",this._default=c["default"],this._encode=c.encode,this._decode=c.decode,Metro.accessors&&Object.defineProperty(this.owner.prototype,b,{enumerable:!0,configurable:!0,get:function(){return this.get(d)},set:function(a){return this.set(d,a)}})}return a.prototype.defaultValue=function(a){var b;return b=this._default,Metro.Support.Object.isArray(b)?b.concat():Metro.Support.Object.isHash(b)?Metro.Support.Object.extend({},b):typeof b=="function"?b.call(a):b},a.prototype.encode=function(a,b){return this.code(this._encode,a,b)},a.prototype.decode=function(a,b){return this.code(this._decode,a,b)},a.prototype.code=function(a,b,c){switch(a){case"string":return c[a].call(c[a],b);case"function":return a.call(_encode,b);default:return b}},a}(),Metro.Model.Versioning={},Metro.Model.Fields={ClassMethods:{field:function(a,b){return this.fields()[a]=new Metro.Model.Field(this,a,b)},fields:function(){return this._fields||(this._fields={})},schema:function(){return this.fields()}},InstanceMethods:{get:function(a){return this.has(a)||(this.attributes[a]=this.constructor.fields()[a].defaultValue(this)),this.attributes[a]},set:function(a,b){var c;return c=this._attributeChange(a,b),this.attributes[a]=b,this.fire("change",{beforeValue:c,value:b}),b},has:function(a){return this.attributes.hasOwnProperty(a)}}},Metro.Model.Persistence={ClassMethods:{load:function(a){var b,c,d,e,f;Metro.Support.Object.isArray(a)||(a=[a]),d=this.store().records;for(e=0,f=a.length;e<f;e++)b=a[e],c=b instanceof Metro.Model?b:new this(b),d[c.id]=c;return d},create:function(a,b){return this.scoped().create(a,b)},update:function(){var a,b,c,d,e;return b=3<=arguments.length?l.call(arguments,0,d=arguments.length-2):(d=0,[]),c=arguments[d++],a=arguments[d++],(e=this.scoped()).update.apply(e,l.call(b).concat([c],[a]))},updateAll:function(a,b,c){return this.scoped().updateAll(a,b,c)},destroy:function(a,b){return this.scoped().destroy(a,b)},deleteAll:function(){return this.scoped().deleteAll()},store:function(a){return!a&&this._store?this._store:(typeof a=="object"?(this._store||(this._store=new this.defaultStore({name:this.collectionName(),className:Metro.namespaced(this.name)})),Metro.Support.Object.extend(this._store,a)):a&&(this._store=a),this._store||(this._store=new this.defaultStore({name:this.collectionName(),className:Metro.namespaced(this.name)})),this._store)},defaultStore:Metro.Store.Memory,collectionName:function(){return Metro.Support.String.camelize(Metro.Support.String.pluralize(this.name),!0)},resourceName:function(){return Metro.Support.String.camelize(this.name,!0)},clone:function(a){}},InstanceMethods:{isNew:function(){return!this.attributes.id},save:function(a){return this.isNew()?this._create(a):this._update(this.toUpdates(),a)},_update:function(a,b){var c=this;return this.constructor.update(this.id,a,function(a){a||(c.changes={});if(b)return b.call(c,a)}),this},_create:function(a){var b=this;return this.constructor.create(this.attributes,function(c,d){if(c)throw c;b.changes={};if(a)return a.call(b,c)}),this},updateAttributes:function(a,b){return this._update(a,b)},"delete":function(a){var b=this;return this.isNew()?a&&a.apply(null,this):this.constructor.destroy({id:this.id},function(c){c||delete b.attributes.id;if(a)return a.apply(b,c)}),this},destroy:function(a){return this["delete"](function(b){if(b)throw b;if(a)return a.apply(b,this)})},isPersisted:function(){return!!this.isNew()},toObject:function(){return this.attributes},clone:function(){},reset:function(){},reload:function(){},toggle:function(a){}}},Metro.Model.Atomic={ClassMethods:{inc:function(a,b){b==null&&(b=1)}},inc:function(a,b){b==null&&(b=1)}},Metro.Model.Scopes={ClassMethods:{scope:function(a,b){return this[a]=b instanceof Metro.Model.Scope?b:this.where(b)},scoped:function(){var a;return a=new Metro.Model.Scope({model:this}),this.baseClass().name!==this.name&&a.where({type:this.name}),a}}},h=Metro.Model.Scope.scopes,b=function(a){return Metro.Model.Scopes.ClassMethods[a]=function(){var b;return(b=this.scoped())[a].apply(b,arguments)}};for(d=0,f=h.length;d<f;d++)a=h[d],b(a);i=Metro.Model.Scope.finders,c=function(a){return Metro.Model.Scopes.ClassMethods[a]=function(){var b;return(b=this.scoped())[a].apply(b,arguments)}};for(e=0,g=i.length;e<g;e++)a=i[e],c(a);Metro.Model.NestedAttributes={ClassMethods:{acceptsNestedAttributesFor:function(){}},assignNestedAttributesForOneToOneAssociation:function(a,b,c){c==null&&(c={})},assignNestedAttributesForCollectionAssociation:function(a,b,c){c==null&&(c={})}},Metro.Model.Serialization={ClassMethods:{fromJSON:function(a){var b,c,d,e;d=JSON.parse(a),d instanceof Array||(d=[d]);for(b=0,e=d.length;b<e;b++)c=d[b],d[b]=new this(c);return d},fromForm:function(a){},fromXML:function(a){},toJSON:function(a,b){return b==null&&(b={}),JSON.stringify(a)}},toXML:function(){},toJSON:function(a){return JSON.stringify(this._serializableHash(a))},toObject:function(){return this.attributes},clone:function(){return new this.constructor(Metro.Support.Object.clone(this.attributes))},_serializableHash:function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v;a==null&&(a={}),n={},b=Metro.Support.Object.keys(this.attributes);if(j=a.only)b=_.union(Metro.Support.Object.toArray(j),b);else if(c=a.except)b=_.difference(Metro.Support.Object.toArray(c),b);for(p=0,r=b.length;p<r;p++)i=b[p],n[i]=this._readAttributeForSerialization(i);if(h=a.methods){g=Metro.Support.Object.toArray(h);for(q=0,s=h.length;q<s;q++)i=h[q],n[i]=this[i]()}if(f=a.include){f=Metro.Support.Object.toArray(f);for(v=0,t=f.length;v<t;v++){e=f[v],Metro.Support.Object.isHash(e)||(o={},o[e]={},e=o,o=void 0);for(i in e){k=e[i],m=this[i]().all();for(d=0,u=m.length;d<u;d++)l=m[d],m[d]=l._serializableHash(k);n[i]=m}}}return n},_readAttributeForSerialization:function(a,b){return b==null&&(b="json"),this[a]}},Metro.Model.States={},Metro.Model.Validator=function(){function a(a,b,c){this.name=a,this.value=b,this.attributes=c}return a.create=function(a,b,c){switch(a){case"presence":return new this.Presence(a,b,c);case"count":case"length":case"min":case"max":return new this.Length(a,b,c);case"format":return new this.Format(a,b,c)}},a.prototype.validateEach=function(a,b){var c,d,e,f,g;d=!0,g=this.attributes;for(e=0,f=g.length;e<f;e++)c=g[e],this.validate(a,c,b)||(d=!1);return d},a}(),Metro.Model.Validator.Format=function(){function a(b,c){a.__super__.constructor.call(this,b,c),this.value=typeof b=="string"?new RegExp(b):b}return a.prototype.validate=function(a,b,c){var d;return d=a[b],this.value.exec(d)?!0:(c[b]||(c[b]=[]),c[b].push(Metro.t("model.errors.format",{attribute:b,value:this.value.toString()})),!1)},a}(),Metro.Model.Validator.Length=function(){function a(b,c,d){a.__super__.constructor.apply(this,arguments),this.validate=function(){switch(b){case"min":return this.validateMinimum;case"max":return this.validateMaximum;default:return this.validateLength}}.call(this)}return k(a,Metro.Model.Validator),a.prototype.validateMinimum=function(a,b,c){var d;return d=a[b],typeof d=="number"&&d>=this.value?!0:(c[b]||(c[b]=[]),c[b].push(Metro.t("model.errors.minimum",{attribute:b,value:this.value})),!1)},a.prototype.validateMaximum=function(a,b,c){var d;return d=a[b],typeof d=="number"&&d<=this.value?!0:(c[b]||(c[b]=[]),c[b].push(Metro.t("model.errors.maximum",{attribute:b,value:this.value})),!1)},a.prototype.validateLength=function(a,b,c){var d;return d=a[b],typeof d!="number"||d!==this.value?(c[b]||(c[b]=[]),c[b].push(Metro.t("model.errors.length",{attribute:b,value:this.value})),!1):!0},a}(),Metro.Model.Validator.Presence=function(){function a(){a.__super__.constructor.apply(this,arguments)}return k(a,Metro.Model.Validator),a.prototype.validate=function(a,b,c){return Metro.Support.Object.isPresent(a[b])?!0:(c[b]||(c[b]=[]),c[b].push(Metro.t("model.errors.presence",{attribute:b})),!1)},a}(),Metro.Model.Validator.Uniqueness=function(){function a(){a.__super__.constructor.apply(this,arguments)}return k(a,Metro.Model.Validator),a.prototype.validate=function(a,b,c){return!0},a}(),Metro.Model.Validations={ClassMethods:{validate:function(){var a,b,c,d,e,f;a=Metro.Support.Array.args(arguments),c=a.pop(),typeof c!="object"&&Metro.raise("missing_options",""+this.name+".validates"),d=this.validators(),f=[];for(b in c)e=c[b],f.push(d.push(Metro.Model.Validator.create(b,e,a)));return f},validators:function(){return this._validators||(this._validators=[])}},validate:function(){var a,b,c,d,e,f;d=this.constructor.validators(),b=!0,a=this.errors={};for(e=0,f=d.length;e<f;e++)c=d[e],c.validateEach(this,a)||(b=!1);return b}},Metro.Model.Timestamp={CreatedAt:{},UpdatedAt:{}},Metro.Model.include(Metro.Model.Persistence),Metro.Model.include(Metro.Model.Atomic),Metro.Model.include(Metro.Model.Versioning),Metro.Model.include(Metro.Model.Metadata),Metro.Model.include(Metro.Model.Dirty),Metro.Model.include(Metro.Model.Criteria),Metro.Model.include(Metro.Model.Scopes),Metro.Model.include(Metro.Model.States),Metro.Model.include(Metro.Model.Inheritance),Metro.Model.include(Metro.Model.Serialization),Metro.Model.include(Metro.Model.NestedAttributes),Metro.Model.include(Metro.Model.Relations),Metro.Model.include(Metro.Model.Validations),Metro.Model.include(Metro.Model.Callbacks),Metro.Model.include(Metro.Model.Fields)})).call(this)