((function(){var a=Object.prototype.hasOwnProperty,b=function(b,c){function e(){this.constructor=b}for(var d in c)a.call(c,d)&&(b[d]=c[d]);return e.prototype=c.prototype,b.prototype=new e,b.__super__=c.prototype,b};Metro.Model=function(){function a(a){var b,c,d,e,f,g;a==null&&(a={}),d=this.constructor.keys(),b={};for(e in a)g=a[e],b[e]=this.typecast(e,g);for(f in d)c=d[f],a.hasOwnProperty(f)||b[f]||(b[f]=this.typecast(f,c.defaultValue(this)));this.attributes=b,this.changes={},this.associations={},this.errors=[]}return b(a,Metro.Object),a.prototype.toLabel=function(){return this.className()},a.prototype.toPath=function(){return this.constructor.toParam()+"/"+this.toParam()},a.prototype.toParam=function(){return this.get("id").toString()},a.toParam=function(){return Metro.Support.String.parameterize(this.className())},a}(),Metro.Model.Scope=function(){function a(a){this.sourceClassName=a,this.conditions=[]}return a.prototype.where=function(){return this.conditions.push(["where",arguments]),this},a.prototype.order=function(){return this.conditions.push(["order",arguments]),this},a.prototype.limit=function(){return this.conditions.push(["limit",arguments]),this},a.prototype.select=function(){return this.conditions.push(["select",arguments]),this},a.prototype.joins=function(){return this.conditions.push(["joins",arguments]),this},a.prototype.includes=function(){return this.conditions.push(["includes",arguments]),this},a.prototype.within=function(){return this.conditions.push(["within",arguments]),this},a.prototype.all=function(a){return this.store().all(this.query(),a)},a.prototype.first=function(a){return this.store().first(this.query(),a)},a.prototype.last=function(a){return this.store().last(this.query(),a)},a.prototype.store=function(){return Metro.constant(this.sourceClassName).store()},a.prototype.query=function(){var a,b,c,d,e,f,g,h;b=this.conditions,e={};for(g=0,h=b.length;g<h;g++){a=b[g];switch(a[0]){case"where":c=a[1][0];for(d in c)f=c[d],e[d]=f;break;case"order":e._sort=a[1][0]}}return e},a}(),Metro.Model.Association=function(){function a(a,b,c){c==null&&(c={}),Metro.accessors&&Metro.Support.Object.defineProperty(a.prototype,b,{enumerable:!0,configurable:!0,get:function(){return this.association(b)},set:function(a){return this.association(b).set(a)}}),this.owner=a,this.name=b,this.targetClassName=Metro.namespaced(c.className||Metro.Support.String.camelize(b))}return b(a,Metro.Object),a.prototype.scoped=function(a){return(new Metro.Model.Scope(this.targetClassName)).where(this.conditions(a))},a.prototype.conditions=function(a){var b;return b={},this.foreignKey&&a.id&&(b[this.foreignKey]=a.id),b},a.delegate("where","find","all","first","last","store",{to:"scoped"}),a}(),require("./association/belongsTo"),require("./association/hasMany"),require("./association/hasOne"),Metro.Model.Associations={ClassMethods:{associations:function(){return this._associations||(this._associations={})},association:function(a){var b;b=this.associations()[a];if(!b)throw new Error("Reflection for '"+a+"' does not exist on '"+this.name+"'");return b},hasOne:function(a,b){b==null&&(b={})},hasMany:function(a,b){return b==null&&(b={}),this.associations()[a]=new Metro.Model.Association.HasMany(this,a,b)},belongsTo:function(a,b){var c;return b==null&&(b={}),this.associations()[a]=c=new Metro.Model.Association.BelongsTo(this,a,b),this.key(""+a+"Id"),c}},InstanceMethods:{association:function(a){var b;return(b=this.associations)[a]||(b[a]=this.constructor.association(a).scoped(this))}}},Metro.Model.Attribute=function(){function a(a,b){b==null&&(b={}),this.name=a,this.type=b.type||"string",this._default=b["default"],this.typecastMethod=function(){switch(this.type){case Array:case"array":return this._typecastArray;case Date:case"date":case"time":return this._typecastDate;case Number:case"number":case"integer":return this._typecastInteger;case"float":return this._typecastFloat;default:return this._typecastString}}.call(this)}return a.prototype.typecast=function(a){return this.typecastMethod.call(this,a)},a.prototype._typecastArray=function(a){return a},a.prototype._typecastString=function(a){return a},a.prototype._typecastDate=function(a){return a},a.prototype._typecastInteger=function(a){return a===null||a===void 0?null:parseInt(a)},a.prototype._typecastFloat=function(a){return a===null||a===void 0?null:parseFloat(a)},a.prototype.defaultValue=function(a){var b;b=this._default;switch(typeof b){case"function":return b.call(a);default:return b}},a}(),Metro.Model.Attributes={ClassMethods:{key:function(a,b){return b==null&&(b={}),this.keys()[a]=new Metro.Model.Attribute(a,b),Metro.accessors&&Object.defineProperty(this.prototype,a,{enumerable:!0,configurable:!0,get:function(){return this.get(a)},set:function(b){return this.set(a,b)}}),this},keys:function(){return this._keys||(this._keys={})},attribute:function(a){var b;b=this.keys()[a];if(!b)throw new Error("Attribute '"+a+"' does not exist on '"+this.name+"'");return b}},InstanceMethods:{typecast:function(a,b){return this.constructor.attribute(a).typecast(b)},get:function(a){var b;return(b=this.attributes)[a]||(b[a]=this.constructor.attribute(a).defaultValue(this))},set:function(a,b){return this._attributeChange(a,b),this.attributes[a]=b,b},toUpdates:function(){var a,b,c,d,e;d={},b=this.attributes,e=this.changes;for(c in e)a=e[c],d[c]=b[c];return d}}},Metro.Model.Persistence={ClassMethods:{create:function(a,b){return this.store().create(new this(a),b)},update:function(a,b,c){return this.store().update(a,b,c)},destroy:function(a,b){return this.store().destroy(a,b)},updateAll:function(){},deleteAll:function(){return this.store().clear()},store:function(a){return a&&(this._store=a),this._store||(this._store=new Metro.Store.Memory)}},InstanceMethods:{isNew:function(){return!attributes.id},save:function(a){return this.isNew()?this._create(a):this._update(a)},_update:function(a){return this.constructor.update(this.toUpdates(),a)},_create:function(a){return this.constructor.create(this.toUpdates(),a)},reset:function(){},updateAttribute:function(a,b){},updateAttributes:function(a){return this.constructor.update(a,callback)},increment:function(a,b){b==null&&(b=1)},decrement:function(a,b){b==null&&(b=1)},reload:function(){},"delete":function(){},destroy:function(){},isDestroyed:function(){},isPersisted:function(){return!!this.isNew()},toObject:function(){return this.attributes},isDirty:function(){return Metro.Support.Object.isPresent(this.changes)},_attributeChange:function(a,b){var c,d,e;return c=(e=this.changes)[a]||(e[a]=[]),d=c[0]||(c[0]=this.attributes[a]),c[1]=b,c[0]===c[1]&&(c=null),c?this.changes[a]=c:delete this.changes[a],d}}},Metro.Model.Scopes={ClassMethods:{scope:function(a,b){return this[a]=b instanceof Metro.Model.Scope?b:this.where(b)},where:function(){var a;return(a=this.scoped()).where.apply(a,arguments)},order:function(){var a;return(a=this.scoped()).order.apply(a,arguments)},limit:function(){var a;return(a=this.scoped()).limit.apply(a,arguments)},select:function(){var a;return(a=this.scoped()).select.apply(a,arguments)},joins:function(){var a;return(a=this.scoped()).joins.apply(a,arguments)},includes:function(){var a;return(a=this.scoped()).includes.apply(a,arguments)},within:function(){var a;return(a=this.scoped()).within.apply(a,arguments)},scoped:function(){return new Metro.Model.Scope(Metro.namespaced(this.name))},all:function(a){return this.store().all(a)},first:function(a){return this.store().first(a)},last:function(a){return this.store().last(a)},find:function(a,b){return this.store().find(a,b)},count:function(a){return this.store().count(a)},exists:function(a){return this.store().exists(a)}}},Metro.Model.Serialization={ClassMethods:{fromJSON:function(a){var b,c,d,e;d=JSON.parse(a),d instanceof Array||(d=[d]);for(b=0,e=d.length;b<e;b++)c=d[b],d[b]=new this(c);return d},fromForm:function(a){}},toXML:function(){},toJSON:function(){return JSON.stringify(this.attributes)},toObject:function(){return this.attributes},clone:function(){return new this.constructor(Metro.Support.Object.clone(this.attributes))}},Metro.Model.Validator=function(){function a(a,b,c){this.name=a,this.value=b,this.attributes=c}return a.create=function(a,b,c){switch(a){case"presence":return new this.Presence(a,b,c);case"count":case"length":case"min":case"max":return new this.Length(a,b,c);case"format":return new this.Format(a,b,c)}},a.prototype.validateEach=function(a,b){var c,d,e,f,g;d=!0,g=this.attributes;for(e=0,f=g.length;e<f;e++)c=g[e],this.validate(a,c,b)||(d=!1);return d},a}(),require("./validator/format"),require("./validator/length"),require("./validator/presence"),require("./validator/uniqueness"),Metro.Model.Validations={ClassMethods:{validate:function(){var a,b,c,d,e,f;a=Metro.Support.Array.args(arguments),c=a.pop(),typeof c!="object"&&Metro.raise("missing_options",""+this.name+".validates"),d=this.validators(),f=[];for(b in c)e=c[b],f.push(d.push(Metro.Model.Validator.create(b,e,a)));return f},validators:function(){return this._validators||(this._validators=[])}},validate:function(){var a,b,c,d,e,f;d=this.constructor.validators(),b=!0,a=this.errors,a.length=0;for(e=0,f=d.length;e<f;e++)c=d[e],c.validateEach(this,a)||(b=!1);return b}},Metro.Model.include(Metro.Model.Persistence),Metro.Model.include(Metro.Model.Scopes),Metro.Model.include(Metro.Model.Serialization),Metro.Model.include(Metro.Model.Associations),Metro.Model.include(Metro.Model.Validations),Metro.Model.include(Metro.Model.Attributes)})).call(this)