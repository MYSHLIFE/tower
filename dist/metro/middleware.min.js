Metro.Middleware={},Metro.Middleware.Location=function(a,b,c){return a.location||(a.location=new Metro.Net.Url(a.url.match(/^http/)?a.url:"http://"+a.headers.host+a.url)),c()},Metro.Middleware.Router=function(a,b,c){return Metro.Middleware.Router.find(a,b,function(c){return c?(b.writeHead(200,c.headers),b.write(c.body),b.end(),c.clear()):self.error(a,b)}),b},Metro.Support.Object.extend(Metro.Middleware.Router,{find:function(a,b,c){var d,e,f,g,h;f=Metro.Route.all(),this.processHost(a,b),this.processAgent(a,b);for(g=0,h=f.length;g<h;g++){e=f[g],d=this.processRoute(e,a,b);if(d)break}return d?d.call(a,b,function(){return c(d)}):c(null),d},processHost:function(a,b){return a.location||(a.location=new Metro.Net.Url(a.url))},processAgent:function(a,b){if(a.headers)return a.userAgent||(a.userAgent=a.headers["user-agent"])},processRoute:function(a,b,c){var d,e,f,g,h,i,j,k;h=a.match(b);if(!h)return null;i=b.method.toLowerCase(),g=a.keys,j=Metro.Support.Object.extend({},a.defaults,b.query||{},b.body||{}),h=h.slice(1);for(f=0,k=h.length;f<k;f++)d=h[f],j[g[f].name]=d?decodeURIComponent(d):null;return e=a.controller,e&&(j.action=e.action),b.params=j,e&&(e=new(Metro.constant(Metro.namespaced(a.controller.className)))),e},error:function(a,b){if(b)return b.statusCode=404,b.setHeader("Content-Type","text/plain"),b.end("No path matches "+a.url)}})