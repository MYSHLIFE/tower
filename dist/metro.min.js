((function(){var a=Array.prototype.slice;Metro.Model=function(){function a(a){var b,c,d,e,f,g;a==null&&(a={}),b={},d=this.constructor.keys();for(e in a)g=a[e],b[e]=g;for(f in d)c=d[f],a.hasOwnProperty(f)||b[f]||(b[f]=c.defaultValue(this));this.attributes=this.typeCastAttributes(b),this.changes={}}return a.initialize=function(){return Metro.Support.Dependencies.load(""+Metro.root+"/app/models")},a.teardown=function(){return delete this._store},a.store=function(){return this._store||(this._store=new Metro.Store.Memory)},a}(),Metro.Model.Scope=function(){function a(a){this.sourceClassName=a,this.conditions=[]}return a.prototype.where=function(){return this.conditions.push(["where",arguments]),this},a.prototype.order=function(){return this.conditions.push(["order",arguments]),this},a.prototype.limit=function(){return this.conditions.push(["limit",arguments]),this},a.prototype.select=function(){return this.conditions.push(["select",arguments]),this},a.prototype.joins=function(){return this.conditions.push(["joins",arguments]),this},a.prototype.includes=function(){return this.conditions.push(["includes",arguments]),this},a.prototype.within=function(){return this.conditions.push(["within",arguments]),this},a.prototype.all=function(a){return this.store().all(this.query(),a)},a.prototype.first=function(a){return this.store().first(this.query(),a)},a.prototype.last=function(a){return this.store().last(this.query(),a)},a.prototype.sourceClass=function(){return global[this.sourceClassName]},a.prototype.store=function(){return global[this.sourceClassName].store()},a.prototype.query=function(){var a,b,c,d,e,f,g,h;b=this.conditions,e={};for(g=0,h=b.length;g<h;g++){a=b[g];switch(a[0]){case"where":c=a[1][0];for(d in c)f=c[d],e[d]=f;break;case"order":e._sort=a[1][0]}}return e},a}(),Metro.Model.Association=function(){function a(a,b){this.owner=a,this.reflection=b}return a.include(Metro.Model.Scope),a.prototype.targetClass=function(){return global[this.reflection.targetClassName]},a.prototype.scoped=function(){return(new Metro.Model.Scope(this.reflection.targetClassName)).where(this.conditions())},a.prototype.conditions=function(){var a;return a={},this.owner.id&&this.reflection.foreignKey&&(a[this.reflection.foreignKey]=this.owner.id),a},a.delegates("where","find","all","first","last","store",{to:"scoped"}),a}(),Metro.Model.Associations=function(){function a(){}return a.hasOne=function(a,b){b==null&&(b={})},a.hasMany=function(a,b){var c;return b==null&&(b={}),b.foreignKey=""+Metro.Support.String.underscore(this.name)+"Id",this.reflections()[a]=c=new Metro.Model.Reflection("hasMany",this.name,a,b),Object.defineProperty(this.prototype,a,{enumerable:!0,configurable:!0,get:function(){return this._getHasManyAssociation(a)},set:function(b){return this._setHasManyAssociation(a,b)}}),c},a.belongsTo=function(a,b){var c;return b==null&&(b={}),this.reflections()[a]=c=new Metro.Model.Association("belongsTo",this.name,a,b),Object.defineProperty(this.prototype,a,{enumerable:!0,configurable:!0,get:function(){return this._getBelongsToAssocation(a)},set:function(b){return this._setBelongsToAssocation(a,b)}}),this.keys()[""+a+"Id"]=new Metro.Model.Attribute(""+a+"Id",b),Object.defineProperty(this.prototype,""+a+"Id",{enumerable:!0,configurable:!0,get:function(){return this._getBelongsToAssocationId(""+a+"Id")},set:function(b){return this._setBelongsToAssocationId(""+a+"Id",b)}}),c},a.reflections=function(){return this._reflections||(this._reflections={})},a.prototype._getHasManyAssociation=function(a){return this.constructor.reflections()[a].association(this.id)},a.prototype._setHasManyAssociation=function(a,b){return this.constructor.reflections()[a].association(this.id).destroyAll()},a.prototype._getBelongsToAssocationId=function(a){return this.attributes[a]},a.prototype._setBelongsToAssocationId=function(a,b){return this.attributes[a]=b},a.prototype._getBelongsToAssocation=function(a){var b;return b=this._getBelongsToAssocationId(a),b?global[this.reflections()[a].targetClassName].where({id:this.id}).first():null},a.prototype._setBelongsToAssocation=function(a,b){var c;return c=this._getBelongsToAssocationId(a),c?global[this.reflections()[a].targetClassName].where({id:this.id}).first():null},a}(),Metro.Model.Attribute=function(){function a(a,b){b==null&&(b={}),this.name=a,this.type=b.type||"string",this._default=b["default"],this.typecastMethod=function(){switch(this.type){case Array:case"array":return this._typecastArray;case Date:case"date":case"time":return this._typecastDate;case Number:case"number":case"integer":return this._typecastInteger;case"float":return this._typecastFloat;default:return this._typecastString}}.call(this)}return a.prototype.typecast=function(a){return this.typecastMethod.call(this,a)},a.prototype._typecastArray=function(a){return a},a.prototype._typecastString=function(a){return a},a.prototype._typecastDate=function(a){return a},a.prototype._typecastInteger=function(a){return a===null||a===void 0?null:parseInt(a)},a.prototype._typecastFloat=function(a){return a===null||a===void 0?null:parseFloat(a)},a.prototype.defaultValue=function(a){var b;b=this._default;switch(typeof b){case"function":return b.call(a);default:return b}},a}(),Metro.Model.Attributes=function(){function a(){}return a.key=function(a,b){return b==null&&(b={}),this.keys()[a]=new Metro.Model.Attribute(a,b),Object.defineProperty(this.prototype,a,{enumerable:!0,configurable:!0,get:function(){return this.getAttribute(a)},set:function(b){return this.setAttribute(a,b)}}),this},a.keys=function(){return this._keys||(this._keys={})},a.attributeDefinition=function(a){var b;b=this.keys()[a];if(!b)throw new Error("Attribute '"+a+"' does not exist on '"+this.name+"'");return b},a.prototype.typeCast=function(a,b){return this.constructor.attributeDefinition(a).typecast(b)},a.prototype.typeCastAttributes=function(a){var b,c;for(b in a)c=a[b],a[b]=this.typeCast(b,c);return a},a.prototype.getAttribute=function(a){var b;return(b=this.attributes)[a]||(b[a]=this.constructor.keys()[a].defaultValue(this))},a.hasOwnProperty("get")||a.alias("get","getAttribute"),a.prototype.setAttribute=function(a,b){var c;return c=this._trackChangedAttribute(a,b),this.attributes[a]=b},a.hasOwnProperty("set")||a.alias("set","setAttribute"),a}(),Metro.Model.Dirty=function(){function a(){}return a.prototype.isDirty=function(){var a,b;b=this.changes();for(a in b)return!0;return!1},a.prototype.changes=function(){return this._changes||(this._changes={})},a.prototype._trackChangedAttribute=function(a,b){var c,d,e;return c=(e=this.changes)[a]||(e[a]=[]),d=c[0]||(c[0]=this.attributes[a]),c[1]=b,c[0]===c[1]&&(c=null),c?this.changes[a]=c:delete this.changes[a],d},a}(),Metro.Model.Persistence=function(){function a(){}return a.create=function(a){var b;return b=new this(a),this.store().create(b),b},a.update=function(){},a.deleteAll=function(){return this.store().clear()},a.prototype.isNew=function(){return!attributes.id},a.prototype.save=function(a){return runCallbacks(function(){})},a.prototype.update=function(a){},a.prototype.reset=function(){},a.alias("reload","reset"),a.prototype.updateAttribute=function(a,b){},a.prototype.updateAttributes=function(a){},a.prototype.increment=function(a,b){b==null&&(b=1)},a.prototype.decrement=function(a,b){b==null&&(b=1)},a.prototype.reload=function(){},a.prototype["delete"]=function(){},a.prototype.destroy=function(){},a.prototype.createOrUpdate=function(){},a.prototype.isDestroyed=function(){},a.prototype.isPersisted=function(){},a}(),Metro.Model.Reflection=function(){function a(a,b,c,d){d==null&&(d={}),this.type=a,this.sourceClassName=b,this.targetClassName=d.className||Metro.Support.String.camelize(Metro.Support.String.singularize(c)),this.foreignKey=d.foreignKey}return a.prototype.targetClass=function(){return global[this.targetClassName]},a.prototype.association=function(a){return new Metro.Model.Association(a,this)},a}(),Metro.Model.Scopes=function(){function a(){}return a.scope=function(a,b){return this[a]=b instanceof Metro.Model.Scope?b:this.where(b)},a.where=function(){var a;return(a=this.scoped()).where.apply(a,arguments)},a.order=function(){var a;return(a=this.scoped()).order.apply(a,arguments)},a.limit=function(){var a;return(a=this.scoped()).limit.apply(a,arguments)},a.select=function(){var a;return(a=this.scoped()).select.apply(a,arguments)},a.joins=function(){var a;return(a=this.scoped()).joins.apply(a,arguments)},a.includes=function(){var a;return(a=this.scoped()).includes.apply(a,arguments)},a.within=function(){var a;return(a=this.scoped()).within.apply(a,arguments)},a.scoped=function(){return new Metro.Model.Scope(this.name)},a.all=function(a){return this.store().all(a)},a.first=function(a){return this.store().first(a)},a.last=function(a){return this.store().last(a)},a.find=function(a,b){return this.store().find(a,b)},a.count=function(a){return this.store().count(a)},a.exists=function(a){return this.store().exists(a)},a}(),Metro.Model.Serialization=function(){function a(){}return a.prototype.toXML=function(){},a.prototype.toJSON=function(){return JSON.stringify(this.attributes)},a.prototype.toObject=function(){},a.prototype.clone=function(){},a.fromJSON=function(a){var b,c,d,e;d=JSON.parse(a),d instanceof Array||(d=[d]);for(b=0,e=d.length;b<e;b++)c=d[b],d[b]=new this(c);return d},a}(),Metro.Model.Validation=function(){function a(a,b){this.name=a,this.value=b,this.attributes=Array.prototype.slice.call(arguments,2,arguments.length),this.validationMethod=function(){switch(a){case"presence":return this.validatePresence;case"min":return this.validateMinimum;case"max":return this.validateMaximum;case"count":case"length":return this.validateLength;case"format":return typeof this.value=="string"&&(this.value=new RegExp(this.value)),this.validateFormat}}.call(this)}return a.prototype.validate=function(a){var b,c,d,e,f;c=!0,f=this.attributes;for(d=0,e=f.length;d<e;d++)b=f[d],this.validationMethod(a,b)||(c=!1);return c},a.prototype.validatePresence=function(a,b){return a[b]?!0:(a.errors().push({attribute:b,message:Metro.Support.I18n.t("metro.model.errors.validation.presence",{attribute:b})}),!1)},a.prototype.validateMinimum=function(a,b){var c;return c=a[b],typeof c=="number"&&c>=this.value?!0:(a.errors().push({attribute:b,message:Metro.Support.I18n.t("metro.model.errors.validation.minimum",{attribute:b,value:c})}),!1)},a.prototype.validateMaximum=function(a,b){var c;return c=a[b],typeof c=="number"&&c<=this.value?!0:(a.errors().push({attribute:b,message:""+b+" must be a maximum of "+this.value}),!1)},a.prototype.validateLength=function(a,b){var c;return c=a[b],typeof c!="number"||c!==this.value?(a.errors().push({attribute:b,message:""+b+" must be equal to "+this.value}),!1):!0},a.prototype.validateFormat=function(a,b){var c;return c=a[b],this.value.exec(c)?!0:(a.errors().push({attribute:b,message:""+b+" must be match the format "+this.value.toString()}),!1)},a}(),Metro.Model.Validations=function(){function b(){b.__super__.constructor.apply(this,arguments)}return b.validates=function(){var b,c,d,e,f,g;b=Array.prototype.slice.call(arguments,0,arguments.length),d=b.pop(),typeof d!="object"&&Metro.throw_error("missing_options",""+this.name+".validates"),e=this.validators(),g=[];for(c in d)f=d[c],g.push(e.push(function(a,b,c){c.prototype=a.prototype;var d=new c,e=a.apply(d,b);return typeof e=="object"?e:d}(Metro.Model.Validation,[c,f].concat(a.call(b)),function(){})));return g},b.validators=function(){return this._validators||(this._validators=[])},b.prototype.validate=function(){var a,b,c,d,e,f;a=this,d=this.constructor.validators(),b=!0,this.errors().length=0;for(e=0,f=d.length;e<f;e++)c=d[e],c.validate(a)||(b=!1);return b},b.prototype.errors=function(){return this._errors||(this._errors=[])},b}(),Metro.Model.include(Metro.Model.Persistence),Metro.Model.include(Metro.Model.Scopes),Metro.Model.include(Metro.Model.Serialization),Metro.Model.include(Metro.Model.Associations),Metro.Model.include(Metro.Model.Validations),Metro.Model.include(Metro.Model.Dirty),Metro.Model.include(Metro.Model.Attributes),Metro.View=function(){function a(a){this.controller=a||new Metro.Controller}return a}(),Metro.View.Helpers=function(){function a(){}return a.prototype.stylesheetLinkTag=function(a){return'<link href="'+this.assetPath(a,{directory:Metro.Assets.stylesheetDirectory,ext:"css"})+'"></link>'},a.prototype.assetPath=function(a,b){return b==null&&(b={}),b.digest===void 0&&(b.digest=!!Metro.env.match(/(development|test)/)),Metro.Application.assets().computePublicPath(a,b)},a.prototype.javascriptIncludeTag=function(a){},a.prototype.titleTag=function(a){return"<title>"+a+"</title>"},a.prototype.metaTag=function(a,b){},a.prototype.tag=function(a,b){},a.prototype.linkTag=function(a,b,c){},a.prototype.imageTag=function(a,b){},a}(),Metro.View.Lookup=function(){function a(){}return a.initialize=function(){return this.resolveLoadPaths(),this.resolveTemplatePaths(),Metro.Support.Dependencies.load(""+Metro.root+"/app/helpers")},a.teardown=function(){},a.resolveLoadPaths=function(){var a;return a=Metro.Support.Path,this.loadPaths=_.map(this.loadPaths,function(b){return a.expandPath(b)})},a.lookup=function(a){var b,c,d,e,f,g,h;b=Metro.View.pathsByName,d=b[a];if(d)return d;f=Metro.View.paths,c=new RegExp(a+"$","i");for(g=0,h=f.length;g<h;g++){e=f[g];if(e.split(".")[0].match(c))return b[a]=e,e}return null},a.resolveTemplatePaths=function(){var a,b,c,d,e,f;a=require("file"),c=this.paths,f=Metro.View.loadPaths;for(d=0,e=f.length;d<e;d++)b=f[d],a.walkSync(b,function(a,b,d){var e,f,g,h,i;i=[];for(g=0,h=d.length;g<h;g++)f=d[g],e=[a,f].join("/"),i.push(c.indexOf(e)===-1?c.push(e):void 0);return i});return c},a.loadPaths=["./spec/spec-app/app/views"],a.paths=[],a.pathsByName={},a.engine="jade",a.prettyPrint=!1,a}(),Metro.View.Rendering=function(){function a(){}return a.prototype.render=function(){var a,b,c,d,e;a=Array.prototype.slice.call(arguments,0,arguments.length);if(a.length>=2&&typeof a[a.length-1]=="function")return b=a.pop(),a.length===1?typeof a[0]=="string"?c={template:a[0]}:c=a[0]:(e=a[0],c=a[1],c.template=e),c||(c={}),c.locals=this.context(c),c.type||(c.type=Metro.View.engine),c.engine=Metro.engine(c.type),c.hasOwnProperty("layout")&&c.layout===!1?c.layout=!1:c.layout=c.layout||this.controller.layout(),d=this,this._renderBody(c,function(a,e){return d._renderLayout(e,c,b)});throw new Error("You must pass a callback to the render method")},a.prototype._renderBody=function(a,b){var c;return a.text?b(null,a.text):a.json?b(null,typeof a.json=="string"?a.json:JSON.stringify(a.json)):(a.inline||(c=Metro.View.lookup(a.template),c=Metro.Support.Path.read(c)),a.engine.render(c,a.locals,b))},a.prototype._renderLayout=function(a,b,c){var d;return b.layout?(d=Metro.View.lookup("layouts/"+b.layout),d=Metro.Support.Path.read(d),b.locals.yield=a,b.engine.render(d,b.locals,c)):c(null,a)},a.prototype.context=function(a){var b,c,d;b=this.controller,d={};for(c in b)c!=="constructor"&&(d[c]=b[c]);return d=require("underscore").extend(d,this.locals||{},a.locals),Metro.View.prettyPrint&&(d.pretty=!0),d},a}(),Metro.View.include(Metro.View.Lookup),Metro.View.include(Metro.View.Rendering),Metro.Controller=function(){function a(){a.__super__.constructor.apply(this,arguments)}return a.initialize=function(){return Metro.Support.Dependencies.load(""+Metro.root+"/app/controllers")},a.teardown=function(){return delete this._helpers,delete this._layout,delete this._theme},a.reload=function(){return this.teardown(),this.initialize()},a.helper=function(a){return this._helpers||(this._helpers=[]),this._helpers.push(a)},a.layout=function(a){return this._layout=a},a.theme=function(a){return this._theme=a},a.prototype.layout=function(){var a;return a=this.constructor._layout,typeof a=="function"?a.apply(this):a},a.getter("controllerName",a,function(){return Metro.Support.String.camelize(this.name)}),a.getter("controllerName",a.prototype,function(){return this.constructor.controllerName}),a.prototype.clear=function(){return this.request=null,this.response=null,this.headers=null},a}(),Metro.Controller.Flash=function(){function a(){a.__super__.constructor.apply(this,arguments)}return a}(),Metro.Controller.Redirecting=function(){function a(){}return a.prototype.redirectTo=function(){},a}(),Metro.Controller.Rendering=function(){function a(){a.__super__.constructor.apply(this,arguments)}return a.prototype.render=function(){var a,b,c,d,e,f;return a=Array.prototype.slice.call(arguments,0,arguments.length),a.length>=2&&typeof a[a.length-1]=="function"&&(b=a.pop()),e=new Metro.View(this),(f=this.headers)["Content-Type"]||(f["Content-Type"]=this.contentType),d=this,a.push(c=function(a,c){return d.body=c,d.body||(d.body=a.toString()),b&&b(a,c),d.callback()}),e.render.apply(e,a)},a.prototype.renderToBody=function(a){return this._processOptions(a),this._renderTemplate(a)},a.prototype.renderToString=function(){var a;return a=this._normalizeRender.apply(this,arguments),this.renderToBody(a)},a.prototype._renderTemplate=function(a){return this.template.render(viewContext,a)},a}(),Metro.Controller.Responding=function(){function a(){this.headers={},this.status=200,this.request=null,this.response=null,this.contentType="text/html",this.params={},this.query={}}return a.respondTo=function(){return this._respondTo||(this._respondTo=[]),this._respondTo=this._respondTo.concat(arguments)},a.prototype.respondWith=function(){var a,b;b=arguments[0],arguments.length>1&&typeof arguments[arguments.length-1]=="function"&&(a=arguments[arguments.length-1]);switch(this.format){case"json":return this.render({json:b});case"xml":return this.render({xml:b});default:return this.render({action:this.action})}},a.prototype.call=function(a,b,c){return this.request=a,this.response=b,this.params=this.request.params||{},this.cookies=this.request.cookies||{},this.query=this.request.query||{},this.session=this.request.session||{},this.format=this.params.format,this.headers={},this.callback=c,this.format&&this.format!=="undefined"?this.contentType=Metro.Support.Path.contentType(this.format):this.contentType="text/html",this.process()},a.prototype.process=function(){return this.processQuery(),this[this.params.action]()},a.prototype.processQuery=function(){},a}(),Metro.Controller.include(Metro.Controller.Flash),Metro.Controller.include(Metro.Controller.Redirecting),Metro.Controller.include(Metro.Controller.Rendering),Metro.Controller.include(Metro.Controller.Responding),Metro.Route=function(){function a(a){a||(a=a),this.path=a.path,this.name=a.name,this.method=a.method,this.ip=a.ip,this.defaults=a.defaults||{},this.constraints=a.constraints,this.options=a,this.controller=a.controller,this.keys=[],this.pattern=this.extractPattern(this.path),this.id=this.path,this.controller&&(this.id+=this.controller.name+this.controller.action)}return a.include(Metro.Model.Scopes),a.store=function(){return this._store||(this._store=new Metro.Store.Memory)},a.create=function(a){return this.store().create(a)},a.normalizePath=function(a){return"/"+a.replace(/^\/|\/$/,"")},a.initialize=function(){return require(""+Metro.root+"/config/routes")},a.teardown=function(){return this.store().clear(),delete require.cache[require.resolve(""+Metro.root+"/config/routes")],delete this._store},a.reload=function(){return this.teardown(),this.initialize()},a.draw=function(a){return a.apply(new Metro.Route.DSL(this)),this},a.prototype.match=function(a){return this.pattern.exec(a)},a.prototype.extractPattern=function(a,b,c){var d,e;return a instanceof RegExp?a:(d=this,a==="/"?new RegExp("^"+a+"$"):(a=a.replace(/(\(?)(\/)?(\.)?([:\*])(\w+)(\))?(\?)?/g,function(a,b,c,e,f,g,h,i){var j,k;i=!!i||b+h==="()",k=f==="*",d.keys.push({name:g,optional:!!i,splat:k}),c||(c=""),j="";if(!i||!k)j+=c;return j+="(?:",e!=null?j+=k?"\\.([^.]+?)":"\\.([^/.]+?)":j+=k?"/?(.+)":"([^/\\.]+)",j+=")",i&&(j+="?"),j}),new RegExp("^"+a+"$",(e=!!b)!=null?e:{"":"i"})))},a}(),Metro.Route.DSL=function(){function b(){}return b.prototype.match=function(){return this.scope||(this.scope={}),Metro.Route.create(new Metro.Route(this._extractOptions.apply(this,arguments)))},b.prototype.get=function(){return this.matchMethod.apply(this,["get"].concat(a.call(arguments)))},b.prototype.post=function(){return this.matchMethod.apply(this,["post"].concat(a.call(arguments)))},b.prototype.put=function(){return this.matchMethod.apply(this,["put"].concat(a.call(arguments)))},b.prototype["delete"]=function(){return this.matchMethod.apply(this,["delete"].concat(a.call(arguments)))},b.prototype.matchMethod=function(a){var b;return b=arguments.pop(),b.via=a,arguments.push(b),this.match(b),this},b.prototype.scope=function(){},b.prototype.controller=function(a,b,c){return b.controller=a,this.scope(b,c)},b.prototype.namespace=function(a,b,c){return b=_.extend({path:a,as:a,module:a,shallowPath:a,shallowPrefix:a},b),this.scope(b,c)},b.prototype.constraints=function(a,b){return this.scope({constraints:a},b)},b.prototype.defaults=function(a,b){return this.scope({defaults:a},b)},b.prototype.resource=function(){},b.prototype.resources=function(){},b.prototype.collection=function(){},b.prototype.member=function(){},b.prototype.root=function(a){return this.match("/",_.extend({as:"root"},a))},b.prototype._extractOptions=function(){var a,b,c,d,e,f,g,h,i;return i=Metro.Route.normalizePath(arguments[0]),h=arguments[arguments.length-1]||{},h.path=i,e=this._extractFormat(h),h.path=this._extractPath(h),f=this._extractRequestMethod(h),b=this._extractConstraints(h),d=this._extractDefaults(h),c=this._extractController(h),a=this._extractAnchor(h),g=this._extractName(h),h=_.extend(h,{method:f,constraints:b,defaults:d,name:g,format:e,controller:c,anchor:a,ip:h.ip}),h},b.prototype._extractFormat=function(a){},b.prototype._extractName=function(a){return a.as},b.prototype._extractConstraints=function(a){return a.constraints||{}},b.prototype._extractDefaults=function(a){return a.defaults||{}},b.prototype._extractPath=function(a){return""+a.path+".:format?"},b.prototype._extractRequestMethod=function(a){return a.via||a.requestMethod},b.prototype._extractAnchor=function(a){return a.anchor},b.prototype._extractController=function(a){var b,c,d;return d=a.to.split("#"),d.length===1?b=d[0]:(c=d[0],b=d[1]),c||(c=a.controller||this.scope.controller),b||(b=a.action||this.scope.action),c=c.toLowerCase().replace(/(?:Controller)?$/,"Controller"),b=b.toLowerCase(),{name:c,action:b,className:_.camelize("_"+c)}},b}(),Metro.Store={defaultLimit:100,reservedOperators:{_sort:"_sort",_limit:"_limit"},queryOperators:{">=":"gte",gte:"gte",">":"gt",gt:"gt","<=":"lte",lte:"lte","<":"lt",lt:"lt","in":"in",nin:"nin",any:"any",all:"all","=~":"m",m:"m","!~":"nm",nm:"nm","=":"eq",eq:"eq","!=":"neq",neq:"neq","null":"null",notNull:"notNull"}},Metro.Store.Memory=function(){function a(){this.records={},this.lastId=0}return a.prototype.addIndex=function(){var a;return a=Array.prototype.slice.call(arguments,0,arguments.length),this.index[a]=key,this},a.prototype.removeIndex=function(){var a;return a=Array.prototype.slice.call(arguments,0,arguments.length),delete this.index[a],this},a.prototype.find=function(a,b){var c,d,e,f,g,h;g=[],f=this.records;if(Metro.Support.Object.isPresent(a)){h=a._sort,d=a._limit||Metro.Store.defaultLimit;for(c in f)e=f[c],this.matches(e,a)&&g.push(e);h&&(g=this.sort(g,a._sort)),d&&(g=g.slice(0,d-1+1||9e9))}else for(c in f)e=f[c],g.push(e);return b&&b(g),g},a.alias("select","find"),a.prototype.first=function(a,b){var c;return c=this.find(a,function(a){if(b)return b(a[0])}),c[0]},a.prototype.last=function(a,b){var c;return c=this.find(a,function(a){if(b)return b(a[a.length-1])}),c[c.length-1]},a.prototype.all=function(a,b){return this.find(a,b)},a.prototype.length=function(a,b){return this.find(a,function(a){if(b)return b(a.length)}).length},a.alias("count","length"),a.prototype.remove=function(a,b){var c;return c=this.records,this.select(a,function(a){var d,e,f;for(e=0,f=a.length;e<f;e++)d=a[e],c.splice(c.indexOf(d),1);if(b)return b(a)})},a.prototype.clear=function(){return this.records=[]},a.prototype.toArray=function(){return this.records},a.prototype.create=function(a){var b;return a.id||Metro.raise("errors.store.missingAttribute","id","Store#create",a),(b=a.id)==null&&(a.id=this.generateId()),this.records[a.id]=a},a.prototype.update=function(a){return a.id||Metro.raise("errors.store.missingAttribute","id","Store#update",a),this.records[a.id]=a},a.prototype.destroy=function(a){return this.find(id).destroy()},a.prototype.sort=function(){var a;return(a=Metro.Support.Array).sortBy.apply(a,arguments)},a.prototype.matches=function(a,b){var c,d,e,f,g;e=this,f=!0;for(c in b){g=b[c];if(!!Metro.Store.reservedOperators[c])continue;d=a[c],typeof g=="object"?f=e._matchesOperators(a,d,g):(typeof g=="function"&&(g=g.call(a)),f=d===g);if(!f)return!1}return!0},a.prototype.generateId=function(){return this.lastId++},a.prototype._matchesOperators=function(a,b,c){var d,e,f,g,h;g=!0,f=this;for(d in c){h=c[d];if(!(e=Metro.Store.queryOperators[d]))return b===c;typeof h=="function"&&(h=h.call(a));switch(e){case"gt":g=f._isGreaterThan(b,h);break;case"gte":g=f._isGreaterThanOrEqualTo(b,h);break;case"lt":g=f._isLessThan(b,h);break;case"lte":g=f._isLessThanOrEqualTo(b,h);break;case"eq":g=f._isEqualTo(b,h);break;case"neq":g=f._isNotEqualTo(b,h);break;case"m":g=f._isMatchOf(b,h);break;case"nm":g=f._isNotMatchOf(b,h);break;case"any":g=f._anyIn(b,h);break;case"all":g=f._allIn(b,h)}if(!g)return!1}return!0},a.prototype._isGreaterThan=function(a,b){return a&&a>b},a.prototype._isGreaterThanOrEqualTo=function(a,b){return a&&a>=b},a.prototype._isLessThan=function(a,b){return a&&a<b},a.prototype._isLessThanOrEqualTo=function(a,b){return a&&a<=b},a.prototype._isEqualTo=function(a,b){return a===b},a.prototype._isNotEqualTo=function(a,b){return a!==b},a.prototype._isMatchOf=function(a,b){return typeof a=="string"?!!a.match(b):!!a.exec(b)},a.prototype._isNotMatchOf=function(a,b){return typeof a=="string"?!a.match(b):!a.exec(b)},a.prototype._anyIn=function(a,b){var c,d,e;for(d=0,e=b.length;d<e;d++){c=b[d];if(a.indexOf(c)>-1)return!0}return!1},a.prototype._allIn=function(a,b){var c,d;for(c=0,d=array.length;c<d;c++){b=array[c];if(a.indexOf(b)===-1)return!1}return!0},a.prototype.toString=function(){return this.constructor.name},a}()})).call(this)