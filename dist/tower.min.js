((function(){var Tower,key,module,specialProperties,_fn,_fn2,_fn3,_i,_j,_k,_len,_len2,_len3,_ref,_ref2,_ref3,__slice=Array.prototype.slice,__hasProp=Object.prototype.hasOwnProperty,__indexOf=Array.prototype.indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(__hasProp.call(this,b)&&this[b]===a)return b;return-1},__extends=function(a,b){function d(){this.constructor=a}for(var c in b)__hasProp.call(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};window.global||(window.global=window),module=window.module||{},Tower=window.Tower=new(Tower=function(){function a(){}return a}()),window.Tower.logger=this._console?_console:console,Tower.Support={},Tower.Support.Array={extractOptions:function(a){return typeof a[a.length-1]=="object"?a.pop():{}},extractBlock:function(a){return typeof a[a.length-1]=="function"?a.pop():null},args:function(a,b,c,d){b==null&&(b=0),c==null&&(c=!1),d==null&&(d=!1),a=Array.prototype.slice.call(a,b,a.length);if(!c||a.length>=2&&typeof a[a.length-1]=="function")return a;throw new Error("You must pass a callback to the render method")},sortBy:function(a){var b,c,d,e;return d=this.args(arguments,1),c=d[d.length-1]instanceof Array?{}:d.pop(),e=function(a,b){return a>b?1:a<b?-1:0},b=function(a,b){var f,g;return f=[],g=[],d.forEach(function(d){var h,i,j,k;return i=d[0],k=d[1],h=a[i],j=b[i],typeof c[i]!="undefined"&&(h=c[i](h),j=c[i](j)),f.push(k*e(h,j)),g.push(k*e(j,h))}),f<g?-1:1},d=d.map(function(a){return a instanceof Array||(a=[a,"asc"]),a[1]==="desc"?a[1]=-1:a[1]=1,a}),a.sort(function(a,c){return b(a,c)})}},Tower.Support.Callbacks={ClassMethods:{before:function(){return this.appendCallback.apply(this,["before"].concat(__slice.call(arguments)))},after:function(){return this.appendCallback.apply(this,["after"].concat(__slice.call(arguments)))},callback:function(){return this.appendCallback.apply(this,arguments)},removeCallback:function(a,b,c){return this},appendCallback:function(a){var b,c,d,e,f,g,h,i;b=Tower.Support.Array.args(arguments,1),typeof b[b.length-1]!="object"&&(f=b.pop()),typeof b[b.length-1]=="object"&&(g=b.pop()),f||(f=b.pop()),g||(g={}),d=this.callbacks();for(h=0,i=b.length;h<i;h++)e=b[h],c=d[e]||(d[e]=new Tower.Support.Callbacks.Chain),c.push(a,f,g);return this},prependCallback:function(a,b,c,d){return d==null&&(d={}),this},callbacks:function(){return this._callbacks||(this._callbacks={})}},runCallbacks:function(a,b){var c;return c=this.constructor.callbacks()[a],c?c.run(this,b):b.call(this)}},Tower.Support.Callbacks.Chain=function(){function a(a){var b,c;a==null&&(a={});for(b in a)c=a[b],this[b]=c;this.before||(this.before=[]),this.after||(this.after=[])}return a.prototype.run=function(a,b){var c,d=this;return c=function(b,c){return b.run(a,c)},Tower.async(this.before,c,function(e){if(!e)switch(b.length){case 0:return b.call(a),Tower.async(d.after,c,function(b){return a});default:return b.call(a,function(b){if(!b)return Tower.async(d.after,c,function(b){return a})})}})},a.prototype.push=function(a,b,c,d){return this[a].push(new Tower.Support.Callback(b,c,d))},a}(),Tower.Support.Callback=function(){function a(a,b){b==null&&(b={}),this.method=a,this.options=b}return a.prototype.run=function(a,b){var c,d;c=this.method,typeof c=="string"&&(c=a[c]);switch(c.length){case 0:return d=c.call(a),b(d?null:new Error("Callback did not pass"));default:return c.call(a,b)}},a}(),specialProperties=["included","extended","prototype","ClassMethods","InstanceMethods"],Tower.Class=function(){function a(){this.initialize()}return a.alias=function(a,b){return Tower.Support.Object.alias(this.prototype,a,b)},a.accessor=function(a,b){return Tower.Support.Object.accessor(this.prototype,a,b),this},a.getter=function(a,b){return Tower.Support.Object.getter(this.prototype,a,b),this},a.setter=function(a){return Tower.Support.Object.setter(this.prototype,a),this},a.classAlias=function(a,b){return Tower.Support.Object.alias(this,a,b),this},a.classAccessor=function(a,b){return Tower.Support.Object.accessor(this,a,b),this},a.classGetter=function(a,b){return Tower.Support.Object.getter(this,a,b),this},a.classSetter=function(a){return Tower.Support.Object.setter(this,a),this},a.classEval=function(a){return a.call(this)},a.delegate=function(a,b){return b==null&&(b={}),Tower.Support.Object.delegate(this.prototype,a,b),this},a.mixin=function(a,b){var c,d;for(c in b)d=b[c],__indexOf.call(specialProperties,c)<0&&(a[c]=d);return b},a.extend=function(a){var b;return this.mixin(this,a),b=a.extended,b&&b.apply(a),a},a.self=function(a){return this.extend(a)},a.include=function(a){var b;return a.hasOwnProperty("ClassMethods")&&this.extend(a.ClassMethods),a.hasOwnProperty("InstanceMethods")&&this.include(a.InstanceMethods),this.mixin(this.prototype,a),b=a.included,b&&b.apply(a),a},a.className=function(){return Tower.Support.Object.functionName(this)},a.prototype.className=function(){return this.constructor.className()},a.prototype.initialize=function(){},a}(),Tower.Support.DescendentsTracker={},Tower.Support.EventEmitter={isEventEmitter:!0,events:function(){return this._events||(this._events={})},hasEventListener:function(a){return Tower.Support.Object.isPresent(this.events(),a)},event:function(a){var b;return(b=this.events())[a]||(b[a]=new Tower.Event(this,a))},on:function(){var a,b,c,d,e,f;a=Tower.Support.Array.args(arguments),typeof a[a.length-1]=="object"?(e=a.pop(),a.length===0&&(b=e,e={})):e={},typeof a[a.length-1]=="object"?b=a.pop():(b={},b[a.shift()]=a.shift()),f=[];for(c in b)d=b[c],f.push(this.addEventHandler(c,d,e));return f},addEventHandler:function(a,b,c){return this.event(a).addHandler(b)},mutation:function(a){return function(){var b;return b=a.apply(this,arguments),this.event("change").fire(this,this),b}},prevent:function(a){return this.event(a).prevent(),this},allow:function(a){return this.event(a).allow(),this},isPrevented:function(a){return this.event(a).isPrevented()},fire:function(a){var b;return b=this.event(a),b.fire.call(b,Tower.Support.Array.args(arguments,1))},allowAndFire:function(a){return this.event(a).allowAndFire(Tower.Support.Array.args(arguments,1))}},Tower.Support.I18n={PATTERN:/(?:%%|%\{(\w+)\}|%<(\w+)>(.*?\d*\.?\d*[bBdiouxXeEfgGcps]))/g,load:function(a,b){var c;return b==null&&(b=this.defaultLanguage),c=this.store(),b=c[b]||(c[b]={}),Tower.Support.Object.deepMerge(b,typeof a=="string"?require(a):a),this},defaultLanguage:"en",translate:function(a,b){b==null&&(b={}),b.hasOwnProperty("tense")&&(a+="."+b.tense);if(b.hasOwnProperty("count"))switch(b.count){case 0:a+=".none";break;case 1:a+=".one";break;default:a+=".other"}return this.interpolate(this.lookup(a,b.language),b)},localize:function(){return this.translate.apply(this,arguments)},lookup:function(a,b){var c,d,e,f,g;b==null&&(b=this.defaultLanguage),d=a.split("."),e=this.store()[b];try{for(f=0,g=d.length;f<g;f++)c=d[f],e=e[c]}catch(h){e=null}if(e==null)throw new Error("Translation doesn't exist for '"+a+"'");return e},store:function(){return this._store||(this._store={})},interpolate:function(a,b){return b==null&&(b={}),a.replace(this.PATTERN,function(a,c,d,e){var f,g;if(a==="%%")return"%";f=c||d;if(b.hasOwnProperty(f))g=b[f];else throw new Error("Missing interpolation argument "+f);return typeof g=="function"&&(g=g.call(b)),e?sprintf("%"+e,g):g})}},Tower.Support.I18n.t=Tower.Support.I18n.translate,Tower.Support.Number={isInt:function(a){return a===+a&&a===(a|0)},isFloat:function(a){return a===+a&&a!==(a|0)}},specialProperties=["included","extended","prototype","ClassMethods","InstanceMethods"],Tower.Support.Object={extend:function(a){var b,c,d,e,f,g;b=Tower.Support.Array.args(arguments,1);for(f=0,g=b.length;f<g;f++){d=b[f];for(c in d)e=d[c],__indexOf.call(specialProperties,c)<0&&(a[c]=e)}return a},cloneHash:function(a){var b,c,d;c={};for(b in a)d=a[b],this.isArray(d)?c[b]=this.cloneArray(d):this.isHash(d)?c[b]=this.cloneHash(d):c[b]=d;return c},cloneArray:function(a){var b,c,d,e;d=a.concat();for(b=0,e=d.length;b<e;b++)c=d[b],this.isArray(c)?d[b]=this.cloneArray(c):this.isHash(c)&&(d[b]=this.cloneHash(c));return d},deepMerge:function(a){var b,c,d,e,f,g;b=Tower.Support.Array.args(arguments,1);for(f=0,g=b.length;f<g;f++){d=b[f];for(c in d)e=d[c],__indexOf.call(specialProperties,c)<0&&(a[c]&&typeof e=="object"?a[c]=Tower.Support.Object.deepMerge(a[c],e):a[c]=e)}return a},deepMergeWithArrays:function(a){var b,c,d,e,f,g,h;b=Tower.Support.Array.args(arguments,1);for(g=0,h=b.length;g<h;g++){d=b[g];for(c in d){f=d[c];if(__indexOf.call(specialProperties,c)<0)e=a[c],e?this.isArray(e)?a[c]=e.concat(f):typeof e=="object"&&typeof f=="object"?a[c]=Tower.Support.Object.deepMergeWithArrays(a[c],f):a[c]=f:a[c]=f;else continue}}return a},defineProperty:function(a,b,c){return c==null&&(c={}),Object.defineProperty(a,b,c)},functionName:function(a){var b;return a.__name__?a.__name__:a.name?a.name:(b=a.toString().match(/\W*function\s+([\w\$]+)\(/))!=null?b[1]:void 0},alias:function(a,b,c){return a[b]=a[c]},accessor:function(a,b,c){return a._accessors||(a._accessors=[]),a._accessors.push(b),this.getter(b,a,c),this.setter(b,a),this},setter:function(a,b){return a.hasOwnProperty("_setAttribute")||this.defineProperty(a,"_setAttribute",{enumerable:!1,configurable:!0,value:function(a,b){return this["_"+a]=b}}),a._setters||(a._setters=[]),a._setters.push(b),this.defineProperty(a,b,{enumerable:!0,configurable:!0,set:function(a){return this._setAttribute(b,a)}}),this},getter:function(a,b,c){return a.hasOwnProperty("_getAttribute")||this.defineProperty(a,"_getAttribute",{enumerable:!1,configurable:!0,value:function(a){return this["_"+a]}}),a._getters||(a._getters=[]),a._getters.push(b),this.defineProperty(a,b,{enumerable:!0,configurable:!0,get:function(){return this._getAttribute(b)||(c?this["_"+b]=c.apply(this):void 0)}}),this},variables:function(a){},accessors:function(a){},methods:function(a){var b,c,d;c=[];for(b in a)d=a[b],this.isFunction(d)&&c.push(b);return c},delegate:function(){var a,b,c,d,e,f,g,h,i;d=arguments[0],c=3<=arguments.length?__slice.call(arguments,1,g=arguments.length-1):(g=1,[]),e=arguments[g++],e==null&&(e={}),f=e.to,a=this.isFunction(d);for(h=0,i=c.length;h<i;h++)b=c[h],a?d[b]=function(){var a;return(a=this[f]())[b].apply(a,arguments)}:this.defineProperty(d,b,{enumerable:!0,configurable:!0,get:function(){return this[f]()[b]}});return d},isFunction:function(a){return!!(a&&a.constructor&&a.call&&a.apply)},toArray:function(a){return this.isArray(a)?a:[a]},keys:function(a){return Object.keys(a)},isA:function(a,b){},isRegExp:function(a){return!(!(a&&a.test&&a.exec)||!a.ignoreCase&&a.ignoreCase!==!1)},isHash:function(a){return this.isObject(a)&&!this.isFunction(a)&&!this.isArray(a)},isArray:Array.isArray||function(a){return toString.call(a)==="[object Array]"},kind:function(a){return typeof a!="object"?typeof a:a===null?"null":a.constructor===(new Array).constructor?"array":a.constructor===(new Date).constructor?"date":a.constructor===(new RegExp).constructor?"regex":"object"},isObject:function(a){return a===Object(a)},isPresent:function(a){return!this.isBlank(a)},isBlank:function(a){var b,c;if(typeof a=="string")return a==="";for(b in a)return c=a[b],!1;return!0},has:function(a,b){return a.hasOwnProperty(b)}},Tower.Support.RegExp={regexpEscape:function(a){return a.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")}},Tower.Support.String={camelize_rx:/(?:^|_|\-)(.)/g,capitalize_rx:/(^|\s)([a-z])/g,underscore_rx1:/([A-Z]+)([A-Z][a-z])/g,underscore_rx2:/([a-z\d])([A-Z])/g,parameterize:function(a){return Tower.Support.String.underscore(a).replace("_","-")},constantize:function(a,b){return b==null&&(b=global),b[this.camelize(a)]},camelize:function(a,b){return a=a.replace(this.camelize_rx,function(a,b){return b.toUpperCase()}),b?a.substr(0,1).toLowerCase()+a.substr(1):a},underscore:function(a){return a.replace(this.underscore_rx1,"$1_$2").replace(this.underscore_rx2,"$1_$2").replace("-","_").toLowerCase()},singularize:function(a){var b;return b=a.length,a.substr(b-3)==="ies"?a.substr(0,b-3)+"y":a.substr(b-1)==="s"?a.substr(0,b-1):a},pluralize:function(a,b){var c,d;if(b){if(a===1)return b}else b=a;return d=b.length,c=b.substr(d-1),c==="y"?""+b.substr(0,d-1)+"ies":c==="s"?b:""+b+"s"},capitalize:function(a){return a.replace(this.capitalize_rx,function(a,b,c){return b+c.toUpperCase()})},trim:function(a){return a?a.trim():""},interpolate:function(a,b){var c,d,e;typeof a=="object"?(d=a[b.count],d||(d=a.other)):d=a;for(c in b)e=b[c],d=d.replace(new RegExp("%\\{"+c+"\\}","g"),e);return d}},Tower.Support.String.toQueryValue=function(a,b){var c,d,e,f,g;b==null&&(b="");if(Tower.Support.Object.isArray(a)){d=[];for(f=0,g=a.length;f<g;f++)c=a[f],e=b,e+=c,d.push(e);e=d.join(",")}else e=b,e+=a.toString();return e=e.replace(" ","+").replace(/[#%\"\|<>]/g,function(a){return encodeURIComponent(a)}),e},Tower.Support.String.toQuery=function(a,b){var c,d,e,f,g,h,i,j,k;b==null&&(b={}),h=[];for(d in a)k=a[d],f=""+d+"=",j=b[d]||"string",e=j==="string"?"-":"^",Tower.Support.Object.isHash(k)?(c={},k.hasOwnProperty(">=")&&(c.min=k[">="]),k.hasOwnProperty(">")&&(c.min=k[">"]),k.hasOwnProperty("<=")&&(c.max=k["<="]),k.hasOwnProperty("<")&&(c.max=k["<"]),k.hasOwnProperty("=~")&&(c.match=k["=~"]),k.hasOwnProperty("!~")&&(c.notMatch=k["!~"]),k.hasOwnProperty("==")&&(c.eq=k["=="]),k.hasOwnProperty("!=")&&(c.neq=k["!="]),c.range=c.hasOwnProperty("min")||c.hasOwnProperty("max"),i=[],c.range&&!c.hasOwnProperty("eq")&&!c.hasOwnProperty("match")&&(g="",c.hasOwnProperty("min")?g+=Tower.Support.String.toQueryValue(c.min):g+="n",g+="..",c.hasOwnProperty("max")?g+=Tower.Support.String.toQueryValue(c.max):g+="n",i.push(g)),c.hasOwnProperty("eq")&&i.push(Tower.Support.String.toQueryValue(c.eq)),c.hasOwnProperty("match")&&i.push(Tower.Support.String.toQueryValue(c.match)),c.hasOwnProperty("neq")&&i.push(Tower.Support.String.toQueryValue(c.neq,e)),c.hasOwnProperty("notMatch")&&i.push(Tower.Support.String.toQueryValue(c.notMatch,e)),f+=i.join(",")):f+=Tower.Support.String.toQueryValue(k),h.push(f);return h.sort().join("&")},Tower.Support.String.extractDomain=function(a,b){var c;return b==null&&(b=1),this.namedHost(a)?(c=a.split("."),c.slice(0,c.length-1-1+b+1||9e9).join(".")):null},Tower.Support.String.extractSubdomains=function(a,b){var c;return b==null&&(b=1),this.namedHost(a)?(c=a.split("."),c.slice(0,-(b+2)+1||9e9)):[]},Tower.Support.String.extractSubdomain=function(a,b){return b==null&&(b=1),this.extractSubdomains(a,b).join(".")},Tower.Support.String.namedHost=function(a){return a!==null&&!/\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/.exec(a)},Tower.Support.String.rewriteAuthentication=function(a){return a.user&&a.password?""+encodeURI(a.user)+":"+encodeURI(a.password)+"@":""},Tower.Support.String.hostOrSubdomainAndDomain=function(a){var b,c,d;return a.subdomain===null&&a.domain===null?a.host:(d=a.tldLength||1,b="",a.subdomain!==!1&&(c=a.subdomain||this.extractSubdomain(a.host,d),c&&(b+=""+c+".")),b+=a.domain||this.extractDomain(a.host,d),b)},Tower.Support.String.urlFor=function(a){var b,c,d,e,f;if(!a.host&&!a.onlyPath)throw new Error("Missing host to link to! Please provide the :host parameter, set defaultUrlOptions[:host], or set :onlyPath to true");return e="",b=a.params||{},c=(a.path||"").replace(/\/+/,"/"),f=a.schema||{},delete a.path,delete a.schema,a.onlyPath||(d=a.port,delete a.port,a.protocol!==!1&&(e+=a.protocol||"http",e.match(Tower.Support.RegExp.regexpEscape(":|//"))||(e+=":")),e.match("//")||(e+="//"),e+=this.rewriteAuthentication(a),e+=this.hostOrSubdomainAndDomain(a),d&&(e+=":"+d)),a.trailingSlash?e+=c.replace(/\/$/,"/"):e+=c,Tower.Support.Object.isBlank(b)||(e+="?"+Tower.Support.String.toQuery(b,f)),a.anchor&&(e+="#"+Tower.Support.String.toQuery(a.anchor)),e},Tower.urlFor=function(){var a,b,c,d,e,f,g,h;a=Tower.Support.Array.args(arguments);if(!a[0])return null;if(a[0]instanceof Tower.Model||(typeof a[0]).match(/(string|function)/))c=a[a.length-1],c instanceof Tower.Model||(typeof c).match(/(string|function)/)?d={}:d=a.pop();d||(d=a.pop()),e="";if(d.controller&&d.action)f=Tower.Route.find({name:d.controller.replace(/(Controller)?$/,"Controller"),action:d.action}),f&&(e="/"+Tower.Support.String.parameterize(d.controller));else for(g=0,h=a.length;g<h;g++)b=a[g],e+="/",typeof b=="string"?e+=b:b instanceof Tower.Model?e+=b.constructor.toParam()+"/"+b.toParam():typeof b=="function"&&(e+=b.toParam());return e+=function(){switch(d.action){case"new":return"/new";case"edit":return"/edit";default:return""}}(),d.path=e,Tower.Support.String.urlFor(d)},Tower.Support.String.parameterize=function(a){return Tower.Support.String.underscore(a).replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"-").replace(/^-+|-+$/g,"")},Tower.Support.I18n.load({date:{formats:{"default":"%Y-%m-%d","short":"%b %d","long":"%B %d, %Y"},dayNames:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],abbrDayNames:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],monthNames:[null,"January","February","March","April","May","June","July","August","September","October","November","December"],abbrMonthNames:[null,"Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],order:["year","month","day"]},time:{formats:{"default":"%a, %d %b %Y %H:%M:%S %z","short":"%d %b %H:%M","long":"%B %d, %Y %H:%M"},am:"am",pm:"pm"},support:{array:{wordsConnector:", ",twoWordsConnector:" and ",lastWordConnector:", and "}}}),Tower.Application=function(){function a(a){var b,c,d,e;a==null&&(a=[]);if(Tower.Application._instance)throw new Error("Already initialized application");Tower.Application._instance=this,(c=Tower.Application).middleware||(c.middleware=[]),this.io=global.io,this.History=global.History,this.stack=[];for(d=0,e=a.length;d<e;d++)b=a[d],this.use(b)}return __extends(a,Tower.Class),a.include(Tower.Support.Callbacks),a.configure=function(a){return this.initializers().push(a)},a.initializers=function(){return this._initializers||(this._initializers=[])},a.instance=function(){return this._instance},a.defaultStack=function(){return this.use(Tower.Middleware.Location),this.use(Tower.Middleware.Router),this.middleware},a.use=function(){return this.middleware||(this.middleware=[]),this.middleware.push(arguments)},a.prototype.use=function(){var a;return(a=this.constructor).use.apply(a,arguments)},a.prototype.initialize=function(){return this.extractAgent(),this.applyMiddleware(),this},a.prototype.applyMiddleware=function(){var a,b,c,d,e;b=this.constructor.middleware,b&&b.length>0||(b=this.constructor.defaultStack()),e=[];for(c=0,d=b.length;c<d;c++)a=b[c],e.push(this.middleware.apply(this,a));return e},a.prototype.middleware=function(){var a,b,c;return a=Tower.Support.Array.args(arguments),c="/",b=a.pop(),typeof c!="string"&&(b=c,c="/"),"/"===c[c.length-1]&&(c=c.substr(0,c.length-1)),this.stack.push({route:c,handle:b}),this},a.prototype.extractAgent=function(){return Tower.cookies=Tower.Net.Cookies.parse(),Tower.agent=new Tower.Net.Agent(JSON.parse(Tower.cookies["user-agent"]||"{}"))},a.prototype.listen=function(){var a;a=this;if(this.listening)return;return this.listening=!0,this.History&&this.History.enabled?this.History.Adapter.bind(global,"statechange",function(){var b,c,d,e;return e=History.getState(),b=new Tower.Net.Url(e.url),c=new Tower.Net.Request({url:e.url,location:b,params:Tower.Support.Object.extend({title:e.title},e.data||{})}),d=new Tower.Net.Response({url:e.url,location:b}),a.handle(c,d)}):_console.warn("History not enabled")},a.prototype.run=function(){return this.listen()},a.prototype.handle=function(a,b,c){var d,e,f,g,h,i;return d=Tower.env,f=function(g){var i,j,k,l,m,n;k=void 0,m=void 0,j=void 0,a.url=n+a.url,a.originalUrl=a.originalUrl||a.url,n="",k=h[e++];if(!k||b.headerSent){if(c)return c(g);if(g){l="production"===d?"Internal Server Error":g.stack||g.toString(),"test"!==d&&console.error(g.stack||g.toString());if(b.headerSent)return a.socket.destroy();b.statusCode=500,b.setHeader("Content-Type","text/plain"),b.end(l)}else b.statusCode=404,b.setHeader("Content-Type","text/plain"),b.end("Cannot "+a.method+" "+a.url);return}try{return m=a.location.path,undefined===m&&(m="/"),0!==m.indexOf(k.route)?f(g):(j=m[k.route.length],j&&"/"!==j&&"."!==j?f(g):(n=k.route,a.url=a.url.substr(n.length),"/"!==a.url[0]&&(a.url="/"+a.url),i=k.handle.length,g?i===4?k.handle(g,a,b,f):f(g):i<4?k.handle(a,b,f):f()))}catch(o){return f(o)}},i=b.writeHead,h=this.stack,g="",e=0,f()},a}(),Tower.Support.Object.extend(Tower,{env:"development",port:1597,version:"0.3.0",client:typeof window!="undefined",root:"/",publicPath:"/","case":"camelcase",namespace:null,accessors:typeof window=="undefined",logger:typeof _console!="undefined"?_console:console,config:{},get:function(){return Tower.request.apply(Tower,["get"].concat(__slice.call(arguments)))},post:function(){return Tower.request.apply(Tower,["post"].concat(__slice.call(arguments)))},put:function(){return Tower.request.apply(Tower,["put"].concat(__slice.call(arguments)))},destroy:function(){return Tower.request.apply(Tower,["delete"].concat(__slice.call(arguments)))},request:function(a,b,c,d){var e,f,g,h;return typeof c=="function"&&(d=c,c={}),c||(c={}),h=b,e=new Tower.Dispatch.Url(h),f=new Tower.Dispatch.Request({url:h,location:e,method:a}),g=new Tower.Dispatch.Response({url:h,location:e,method:a}),Tower.Application.instance().handle(f,g,function(){return d.call(this,this.response)})},raise:function(){throw new Error(Tower.t.apply(Tower,arguments))},t:function(){var a;return(a=Tower.Support.I18n).translate.apply(a,arguments)},l:function(){var a;return(a=Tower.Support.I18n).localize.apply(a,arguments)},stringify:function(){var a;a=Tower.Support.Array.args(arguments).join("_");switch(Tower["case"]){case"snakecase":return Tower.Support.String.underscore(a);default:return Tower.Support.String.camelcase(a)}},namespace:function(){return Tower.Application.instance().constructor.name},constant:function(a){var b,c,d,e,f,g;c=global,e=a.split(".");try{for(f=0,g=e.length;f<g;f++)d=e[f],c=c[d]}catch(h){b=Tower.namespace();if(b&&e[0]!==b)Tower.constant(""+b+"."+a);else throw new Error("Constant '"+a+"' wasn't found")}return c},namespaced:function(a){var b;return b=Tower.namespace(),b?""+b+"."+a:a},async:function(a,b,c){var d,e;return a.length?(d=0,e=function(){return b(a[d],function(b){return b?(c(b),c=function(){}):(d+=1,d===a.length?c():e())})},e()):c()}}),Tower.Store=function(){function a(a){a==null&&(a={}),this.name=a.name,this.className=a.type||Tower.namespaced(Tower.Support.String.camelize(Tower.Support.String.singularize(this.name)))}return __extends(a,Tower.Class),a.defaultLimit=100,a.atomicModifiers={$set:"$set",$unset:"$unset",$push:"$push",$pushAll:"$pushAll",$pull:"$pull",$pullAll:"$pullAll"},a.reservedOperators={_sort:"_sort",_limit:"_limit"},a.queryOperators={">=":"$gte",$gte:"$gte",">":"$gt",$gt:"$gt","<=":"$lte",$lte:"$lte","<":"$lt",$lt:"$lt",$in:"$in",$nin:"$nin",$any:"$any",$all:"$all","=~":"$regex",$m:"$regex",$regex:"$regex","!~":"$nm",$nm:"$nm","=":"$eq",$eq:"$eq","!=":"$neq",$neq:"$neq",$null:"$null",$notNull:"$notNull"},a.booleans={"true":!0,"true":!0,TRUE:!0,1:!0,1:!0,1:!0,"false":!1,"false":!1,FALSE:!1,0:!1,0:!1,0:!1},a.prototype.serialize=function(a){var b,c,d;for(b=0,d=a.length;b<d;b++)c=a[b],a[b]=this.serializeModel(c);return a},a.prototype.deserialize=function(a){var b,c,d;for(b=0,d=a.length;b<d;b++)c=a[b],a[b]=this.deserializeModel(c);return a},a.prototype.serializeModel=function(a){var b;return a instanceof Tower.Model?a:(b=Tower.constant(this.className),new b(a))},a.prototype.deserializeModel=function(a){return a.attributes},a.prototype["delete"]=function(a,b,c){return this.destroy.apply(this,arguments)},a.prototype.load=function(a){},a.prototype.schema=function(){return Tower.constant(this.className).fields()},a}(),Tower.Store.Memory=function(){function a(b){a.__super__.constructor.call(this,b),this.constructor.stores().push(this),this.records={},this.lastId=0}return __extends(a,Tower.Store),a.stores=function(){return this._stores||(this._stores=[])},a.clear=function(){var a,b,c,d;b=this.stores();for(c=0,d=b.length;c<d;c++)a=b[c],a.clear();return this._stores.length=0,this._stores},a}(),Tower.Store.Memory.Finders={find:function(a,b,c){var d,e,f,g,h,i;h=[],g=this.records;if(Tower.Support.Object.isPresent(a)){i=b.sort,e=b.limit||Tower.Store.defaultLimit;for(d in g)f=g[d],this.matches(f,a)&&h.push(f);i&&(h=this.sort(h,i)),e&&(h=h.slice(0,e-1+1||9e9))}else for(d in g)f=g[d],h.push(f);return c&&c.call(this,null,h),h},findOne:function(a,b,c){var d;return d=null,b.limit=1,this.find(a,b,function(a,b){d=b[0];if(c)return c.call(this,a,d)}),d},count:function(a,b,c){var d;return d=0,this.find(a,b,function(a,b){d=b.length;if(c)return c.call(this,a,d)}),d},sort:function(a,b){var c;return(c=Tower.Support.Array).sortBy.apply(c,[a].concat(__slice.call(b)))}},Tower.Store.Memory.Persistence={load:function(a){var b,c,d;a=Tower.Support.Object.toArray(a);for(c=0,d=a.length;c<d;c++)b=a[c],b=this.serializeModel(b),this.records[b.get("id")]=b;return a},create:function(a,b,c){var d,e,f,g,h,i;e=null;if(Tower.Support.Object.isArray(a)){e=[];for(f=0,g=a.length;f<g;f++)d=a[f],(h=d.id)==null&&(d.id=this.generateId()),e.push(d);e}else(i=a.id)==null&&(a.id=this.generateId()),e=a;return c&&c.call(this,null,e),e},update:function(a,b,c,d){var e=this;return this.find(b,c,function(b,c){var f,g,h,i,j;if(b)return d(b);for(f=0,j=c.length;f<j;f++){h=c[f];for(g in a)i=a[g],e._updateAttribute(h.attributes,g,i)}return d&&d.call(e,b,c),c})},destroy:function(a,b,c){var d;return Tower.Support.Object.isBlank(a)?(this.records={},c&&c.call(this,null),null):(d=this.records,this.find(a,b,function(a,b){var e,f,g;if(a)return c(a);for(f=0,g=b.length;f<g;f++)e=b[f],delete d[e.id];return c&&c.call(this,a,b),b}))}},Tower.Store.Memory.Serialization={matches:function(a,b){var c,d,e,f,g,h;f=this,g=!0,e=this.schema();for(c in b){h=b[c];if(!!Tower.Store.reservedOperators[c])continue;d=a[c],Tower.Support.Object.isRegExp(h)?g=d.match(h):typeof h=="object"?g=f._matchesOperators(a,d,h):(typeof h=="function"&&(h=h.call(a)),g=d===h);if(!g)return!1}return!0},generateId:function(){return this.lastId++},_updateAttribute:function(a,b,c){var d;return d=this.schema()[b],d&&d.type==="Array"&&!Tower.Support.Object.isArray(c)?(a[b]||(a[b]=[]),a[b].push(c)):this._atomicModifier(b)?this["_"+b.replace("$","")+"AtomicUpdate"](a,c):a[b]=c},_atomicModifier:function(a){return!!this.constructor.atomicModifiers[a]},_pushAtomicUpdate:function(a,b){var c,d;for(c in b)d=b[c],a[c]||(a[c]=[]),a[c].push(d);return a},_pullAtomicUpdate:function(a,b){var c,d,e,f,g,h;for(f in b){h=b[f],d=a[f];if(d)for(e=0,g=h.length;e<g;e++)c=h[e],d.splice(d.indexOf(c),1)}return a},_matchesOperators:function(a,b,c){var d,e,f,g,h;g=!0,f=this;for(d in c){h=c[d];if(!(e=Tower.Store.queryOperators[d]))return b===c;typeof h=="function"&&(h=h.call(a));switch(e){case"$in":case"$any":g=f._anyIn(b,h);break;case"$gt":g=f._isGreaterThan(b,h);break;case"$gte":g=f._isGreaterThanOrEqualTo(b,h);break;case"$lt":g=f._isLessThan(b,h);break;case"$lte":g=f._isLessThanOrEqualTo(b,h);break;case"$eq":g=f._isEqualTo(b,h);break;case"$neq":g=f._isNotEqualTo(b,h);break;case"$regex":g=f._isMatchOf(b,h);break;case"$nm":g=f._isNotMatchOf(b,h);break;case"$all":g=f._allIn(b,h)}if(!g)return!1}return!0},_isGreaterThan:function(a,b){return a&&a>b},_isGreaterThanOrEqualTo:function(a,b){return a&&a>=b},_isLessThan:function(a,b){return a&&a<b},_isLessThanOrEqualTo:function(a,b){return a&&a<=b},_isEqualTo:function(a,b){return a===b},_isNotEqualTo:function(a,b){return a!==b},_isMatchOf:function(a,b){return typeof a=="string"?!!a.match(b):!!a.exec(b)},_isNotMatchOf:function(a,b){return typeof a=="string"?!a.match(b):!a.exec(b)},_anyIn:function(a,b){var c,d,e,f,g;if(_.isArray(a))for(d=0,f=b.length;d<f;d++){c=b[d];if(a.indexOf(c)>-1)return!0}else for(e=0,g=b.length;e<g;e++){c=b[e];if(a===c)return!0}return!1},_allIn:function(a,b){var c,d;for(c=0,d=array.length;c<d;c++){b=array[c];if(a.indexOf(b)===-1)return!1}return!0}},Tower.Store.Memory.include(Tower.Store.Memory.Finders),Tower.Store.Memory.include(Tower.Store.Memory.Persistence),Tower.Store.Memory.include(Tower.Store.Memory.Serialization),Tower.Model=function(){function a(a,b){var c,d,e,f,g,h;a==null&&(a={}),b==null&&(b={}),e=this.constructor.fields(),c={};for(g in e)d=e[g],a.hasOwnProperty(g)||(c[g]=d.defaultValue(this));this.attributes=c,this.changes={},this.errors={},this.readOnly=b.hasOwnProperty("readOnly")?b.readOnly:!1,this.persistent=b.hasOwnProperty("persistent")?b.persisted:!1;for(f in a)h=a[f],this.set(f,h)}return __extends(a,Tower.Class),a}(),Tower.Model.Scope=function(){function g(a){a==null&&(a={}),this.model=a.model,this.criteria=a.criteria||new Tower.Model.Criteria,this.store=this.model.store()}var a,b,c,d,e,f=this;__extends(g,Tower.Class),g.scopes=["where","order","asc","desc","limit","offset","select","joins","includes","excludes","paginate","within","allIn","allOf","alsoIn","anyIn","anyOf","near","notIn"],g.finders=["find","all","first","last","count"],g.builders=["create","update","delete","destroy"],e=g.scopes,b=function(a){return g.prototype[a]=function(){var b,c;return b=this.clone(),(c=b.criteria)[a].apply(c,arguments),b}};for(c=0,d=e.length;c<d;c++)a=e[c],b(a);return g.prototype.find=function(){var a,b,c,d,e;return e=this._extractArgs(arguments,{ids:!0}),b=e.criteria,a=e.callback,d=b.query,c=b.options,d.id&&d.id.hasOwnProperty("$in")&&d.id.$in.length===1?this.store.findOne(d,c,a):this.store.find(d,c,a)},g.prototype.first=function(a){var b;return b=this.toCriteria("asc"),this.store.findOne(b.query,b.options,a)},g.prototype.last=function(a){var b;return b=this.toCriteria("desc"),this.store.findOne(b.query,b.options,a)},g.prototype.all=function(a){var b;return b=this.toCriteria(),this.store.find(b.query,b.options,a)},g.prototype.count=function(a){var b;return b=this.criteria,this.store.count(b.query,b.options,a)},g.prototype.batch=function(){},g.prototype.build=function(a,b){var c,d,e,f;if(Tower.Support.Object.isArray(a)){d=[];for(e=0,f=a.length;e<f;e++)c=a[e],d.push(this.store.serializeModel(c));return d}return this.store.serializeModel(a)},g.prototype.create=function(){var a,b,c,d,e,f,g,h,i,j=this;return i=this._extractArgs(arguments,{updates:!0,options:!0,ids:!1}),c=i.criteria,h=i.updates,f=i.options,b=i.callback,a=Tower.Support.Object.extend({},c.query,h),f.instantiate?(d=Tower.Support.Object.isArray(a),g=Tower.Support.Object.toArray(this.build(a,f)),e=function(a,b){return a?a.save(b):b()},Tower.async(g,e,function(a){if(!!b)return a?b(a):d?b(a,g):b(a,g[0]);if(a)throw a})):this.store.create(a,f,b)},g.prototype.update=function(){var a,b,c,d,e,f;return f=this._extractArgs(arguments,{ids:!0,updates:!0,options:!0}),b=f.criteria,e=f.updates,d=f.options,a=f.callback,d.instantiate?(c=function(a,b){return a.updateAttributes(e,b)},this._each(b.query,b.options,c,a)):this.store.update(e,b.query,b.options,a)},g.prototype.destroy=function(){var a,b,c,d,e;return e=this._extractArgs(arguments,{ids:!0,options:!0}),b=e.criteria,d=e.options,a=e.callback,d.instantiate?(c=function(a,b){return a.destroy(b)},this._each(b.query,b.options,c,a)):this.store.destroy(b.query,b.options,a)},g.prototype["delete"]=function(){return this.destroy.apply(this,arguments)},g.prototype.toCriteria=function(a){var b,c;b=this.criteria;if(a||!b.options.hasOwnProperty("sort"))b=b.clone(),c=this.model.defaultSort(),c&&b[a||c.direction](c.name);return b},g.prototype.merge=function(a){return this.criteria.merge(a.criteria)},g.prototype.clone=function(){return new this.constructor({model:this.model,criteria:this.criteria.clone()})},g.prototype._each=function(a,b,c,d){var e=this;return this.store.find(a,b,function(a,b){return a?d.call(e,a,b):Tower.async(b,c,function(a){if(!d){if(a)throw a}else if(d)return d.call(e,a,b)})})},g.prototype._extractArgs=function(a,b){var c,d,e,f,g;return b==null&&(b={}),a=Tower.Support.Array.args(a),typeof a[a.length-1]=="function"?c=a.pop():c=void 0,b.updates&&Tower.Support.Object.isHash(a[a.length-1])&&(g=a.pop()),Tower.Support.Object.isHash(a[a.length-1])&&(g?(f=g,g=a.pop()):f=a.pop()),b.updates||(g={}),g||(g={}),d=this.criteria.clone(),f||(f={}),f.hasOwnProperty("instantiate")||(f.instantiate=!0),b.ids&&a.length>0&&(e=_.flatten(a)),e&&e.length>0&&(delete d.query.id,d.where({id:{$in:e}})),{criteria:d,updates:g,callback:c,options:f}},g}.call(this),Tower.Model.Criteria=function(){function a(a,b){a==null&&(a={}),b==null&&(b={}),this.query=a,this.options=b}return a.prototype.where=function(a){return this._mergeQuery(a)},a.prototype.order=function(a,b){return b==null&&(b="asc"),this._mergeOptions({sort:[[a,b]]})},a.prototype.asc=function(){var a,b,c,d,e;b=1<=arguments.length?__slice.call(arguments,0):[],e=[];for(c=0,d=b.length;c<d;c++)a=b[c],e.push(this.order(a));return e},a.prototype.desc=function(){var a,b,c,d,e;b=1<=arguments.length?__slice.call(arguments,0):[],e=[];for(c=0,d=b.length;c<d;c++)a=b[c],e.push(this.order(a,"desc"));return e},a.prototype.offset=function(a){return this._mergeOptions({offset:a})},a.prototype.limit=function(a){return this._mergeOptions({limit:a})},a.prototype.select=function(){return this._mergeOptions({fields:Tower.Support.Array.args(arguments)})},a.prototype.joins=function(){return this._mergeOptions({joins:Tower.Support.Array.args(arguments)})},a.prototype.includes=function(){return this._mergeOptions({includes:Tower.Support.Array.args(arguments)})},a.prototype.page=function(a){return this.offset(a)},a.prototype.paginate=function(a){var b,c;return b=a.perPage||a.limit,c=a.page||1,this.limit(b),this.offset((c-1)*b)},a.prototype.within=function(a){return this},a.prototype.clone=function(){return new this.constructor(Tower.Support.Object.cloneHash(this.query),Tower.Support.Object.cloneHash(this.options))},a.prototype.merge=function(a){return this._mergeQuery(a.query),this._mergeOptions(a.options)},a.prototype._mergeQuery=function(a){return a==null&&(a={}),Tower.Support.Object.deepMergeWithArrays(this.query,a)},a.prototype._mergeOptions=function(a){return a==null&&(a={}),Tower.Support.Object.deepMergeWithArrays(this.options,a)},a}(),Tower.Model.Dirty={isDirty:function(){return Tower.Support.Object.isPresent(this.changes)},attributeChanged:function(a){var b;return b=this.changes[a],b?b[0]!==b[1]:!1},attributeChange:function(a){var b;b=this.changes[a];if(!b)return;return b[1]},attributeWas:function(a){var b;b=this.changes[a];if(!b)return;return b[0]},resetAttribute:function(a){},toUpdates:function(){var a,b,c,d,e;d={},b=this.attributes,e=this.changes;for(c in e)a=e[c],d[c]=b[c];return d.updatedAt||(d.updatedAt=new Date),d},_attributeChange:function(a,b){var c,d,e;return c=(e=this.changes)[a]||(e[a]=[]),d=c[0]||(c[0]=this.attributes[a]),c[1]=b,c[0]===c[1]&&(c=null),c?this.changes[a]=c:delete this.changes[a],d}},Tower.Model.Metadata={ClassMethods:{baseClass:function(){return this.__super__&&this.__super__.constructor.baseClass&&this.__super__.constructor!==Tower.Model?this.__super__.constructor.baseClass():this},stiName:function(){},toParam:function(){return Tower.Support.String.pluralize(Tower.Support.String.parameterize(this.name))}},toLabel:function(){return this.className()},toPath:function(){return this.constructor.toParam()+"/"+this.toParam()},toParam:function(){return String(this.get("id"))}},Tower.Model.Inheritance={_computeType:function(){}},Tower.Model.Relation=function(){function a(a,b,c,d){var e,f;c==null&&(c={});for(e in c)f=c[e],this[e]=f;this.owner=a,this.name=b,this.targetClassName=this.type=Tower.namespaced(c.type||c.className||Tower.Support.String.camelize(Tower.Support.String.singularize(b))),this.dependent||(this.dependent=!1),this.counterCache||(this.counterCache=!1),this.hasOwnProperty("cache")||(this.cache=!1),this.hasOwnProperty("readOnly")||(this.readOnly=!1),this.hasOwnProperty("validate")||(this.validate=!1),this.hasOwnProperty("autoSave")||(this.autoSave=!1),this.hasOwnProperty("touch")||(this.touch=!1),this.inverseOf||(this.inverseOf=void 0),this.hasOwnProperty("polymorphic")||(this.polymorphic=!1),this.hasOwnProperty("default")||(this["default"]=!1)}return __extends(a,Tower.Class),a.prototype.scoped=function(a){return new this.constructor.Scope({model:Tower.constant(this.targetClassName),owner:a,relation:this})},a.Scope=function(){function a(b){b==null&&(b={}),a.__super__.constructor.call(this,b),this.owner=b.owner,this.relation=b.relation,this.foreignKey=this.relation.foreignKey}return __extends(a,Tower.Model.Scope),a.prototype.constructable=function(){return!this.relation.polymorphic},a.prototype.clone=function(){return new this.constructor({model:this.model,criteria:this.criteria.clone(),owner:this.owner,relation:this.relation})},a.prototype.setInverseInstance=function(a){var b;if(a&&this.invertibleFor(a))return b=a.relation(this.inverseReflectionFor(a).name),b.target=owner},a.prototype.invertibleFor=function(a){return!0},a}(),a}(),Tower.Model.Relation.BelongsTo=function(){function a(b,c,d){var e;d==null&&(d={}),a.__super__.constructor.call(this,b,c,d),this.foreignKey=""+c+"Id",b.field(this.foreignKey,{type:"Id"}),this.polymorphic&&(this.foreignType=""+c+"Type",b.field(this.foreignType,{type:"String"})),b.prototype[c]=function(a){return this.relation(c).first(a)},e=this,b.prototype["build"+Tower.Support.String.camelize(c)]=function(a,b){return this.buildRelation(c,a,b)},b.prototype["create"+Tower.Support.String.camelize(c)]=function(a,b){return this.createRelation(c,a,b)}}return __extends(a,Tower.Model.Relation),a.Scope=function(){function b(){b.__super__.constructor.apply(this,arguments)}return __extends(b,a.Scope),b}(),a}(),Tower.Model.Relation.HasMany=function(){function a(b,c,d){d==null&&(d={}),a.__super__.constructor.call(this,b,c,d),this.polymorphic=d.hasOwnProperty("as"),b.prototype[c]=function(){return this.relation(c)},d.foreignKey?this.foreignKey=d.foreignKey:this.as?this.foreignKey=""+this.as+"Id":this.foreignKey=Tower.Support.String.camelize(""+b.name+"Id",!0),this.polymorphic&&(this.foreignType||(this.foreignType=""+this.as+"Type")),this.cache&&(typeof this.cache=="string"?(this.cache=!0,this.cacheKey=this.cacheKey):this.cacheKey=Tower.Support.String.singularize(c)+"Ids",this.owner.field(this.cacheKey,{type:"Array","default":[]}))}return __extends(a,Tower.Model.Relation),a.Scope=function(){function b(a){var c,d;a==null&&(a={}),b.__super__.constructor.call(this,a),d=this.owner.get("id"),this.foreignKey&&(c={},d!==void 0&&(c[this.foreignKey]=d),this.relation.foreignType&&(c[this.relation.foreignType]=this.owner.constructor.name),this.criteria.where(c))}return __extends(b,a.Scope),b.prototype.create=function(a,b){var c,d;return d=this,c=this.relation,a=this._serializeAttributes(a),this.store.create(Tower.Support.Object.extend(this.criteria.query,a),this.criteria.options,function(a,e){var f;if(!a){if(c&&c.cache)return f={},f[c.cacheKey]=e.get("id"),d.owner.updateAttributes({$push:f},b);if(b)return b.call(this,a,e)}else if(b)return b.call(this,a,e)})},b.prototype._serializeAttributes=function(a){var b,c,d,e,f;a==null&&(a={}),d=Tower.constant(this.relation.targetClassName),f=d.relations();for(b in f)c=f[b],a.hasOwnProperty(b)&&(e=a[b],delete a[b],c instanceof Tower.Model.Relation.BelongsTo&&(a[c.foreignKey]=e.id,c.polymorphic&&(a[c.foreignType]=e.type)));return a},b.prototype.hasCachedCounter=function(){},b}(),a}(),Tower.Model.Relation.HasManyThrough=function(){function a(b,c,d){d==null&&(d={}),a.__super__.constructor.call(this,b,c,d)}return __extends(a,Tower.Model.Relation.HasMany),a.Scope=function(){function b(a){a==null&&(a={}),b.__super__.constructor.call(this,a)}return __extends(b,a.Scope),b}(),a}(),Tower.Model.Relation.HasOne=function(){function a(){a.__super__.constructor.apply(this,arguments)}return __extends(a,Tower.Model.Relation),a}(),Tower.Model.Relation.HasOneThrough=function(){function a(){a.__super__.constructor.apply(this,arguments)}return __extends(a,Tower.Model.Relation.HasOne),a}(),Tower.Model.Relations={ClassMethods:{hasOne:function(a,b){var c;return b==null&&(b={}),b.hasOwnProperty("through")?c=Tower.Model.Relation.HasOneThrough:c=Tower.Model.Relation.HasOne,this.relations()[a]=new c(this,a,b)},hasMany:function(a,b){var c;return b==null&&(b={}),b.hasOwnProperty("through")?c=Tower.Model.Relation.HasManyThrough:c=Tower.Model.Relation.HasMany,this.relations()[a]=new c(this,a,b)},belongsTo:function(a,b){return this.relations()[a]=new Tower.Model.Relation.BelongsTo(this,a,b)},relations:function(){return this._relations||(this._relations={})},relation:function(a){var b;b=this.relations()[a];if(!b)throw new Error("Relation '"+a+"' does not exist on '"+this.name+"'");return b}},InstanceMethods:{relation:function(a){return this.constructor.relation(a).scoped(this)},buildRelation:function(a,b,c){return this.relation(a).build(b,c)},createRelation:function(a,b,c){return this.relation(a).create(b,c)},destroyRelations:function(){}}},Tower.Model.Field=function(){function a(a,b,c){var d;c==null&&(c={}),this.owner=a,this.name=d=b,this.type=c.type||"string",this._default=c["default"],this._encode=c.encode,this._decode=c.decode,Tower.accessors&&Object.defineProperty(this.owner.prototype,b,{enumerable:!0,configurable:!0,get:function(){return this.get(d)},set:function(a){return this.set(d,a)}})}return a.prototype.defaultValue=function(a){var b;return b=this._default,Tower.Support.Object.isArray(b)?b.concat():Tower.Support.Object.isHash(b)?Tower.Support.Object.extend({},b):typeof b=="function"?b.call(a):b},a.prototype.encode=function(a,b){return this.code(this._encode,a,b)},a.prototype.decode=function(a,b){return this.code(this._decode,a,b)},a.prototype.code=function(a,b,c){switch(a){case"string":return c[a].call(c[a],b);case"function":return a.call(_encode,b);default:return b}},a}(),Tower.Model.Fields={ClassMethods:{field:function(a,b){return this.fields()[a]=new Tower.Model.Field(this,a,b)},fields:function(){return this._fields||(this._fields={})}},get:function(a){var b;return this.has(a)||(b=this.constructor.fields()[a],b&&(this.attributes[a]=b.defaultValue(this))),this.attributes[a]},set:function(a,b){var c;return c=this._attributeChange(a,b),this.attributes[a]=b,b},has:function(a){return this.attributes.hasOwnProperty(a)}},Tower.Model.Persistence={ClassMethods:{defaultStore:Tower.Store.Memory,store:function(a){return!a&&this._store?this._store:(typeof a=="object"?(this._store||(this._store=new this.defaultStore({name:this.collectionName(),className:Tower.namespaced(this.name)})),Tower.Support.Object.extend(this._store,a)):a&&(this._store=a),this._store||(this._store=new this.defaultStore({name:this.collectionName(),className:Tower.namespaced(this.name)})),this._store)},load:function(a){return this.store().load(a)},collectionName:function(){return Tower.Support.String.camelize(Tower.Support.String.pluralize(this.name),!0)},resourceName:function(){return Tower.Support.String.camelize(this.name,!0)}},InstanceMethods:{save:function(a,b){var c=this;if(this.readOnly)throw new Error("Record is read only");return typeof a=="function"&&(b=a,a={}),a||(a={}),a.validate!==!1?this.validate(function(a,d){if(d)return c._save(b);if(b)return b.call(c,null,!1)}):this._save(b),this},updateAttributes:function(a,b){return this._update(a,b)},destroy:function(a){var b=this;return this.isNew()?a&&a.call(this,null):this.runCallbacks("destroy",function(){return b.constructor.destroy(b.id,{instantiate:!1},function(c){if(c&&!a)throw c;b.persistent=!1,c||delete b.attributes.id;if(a)return a.call(b,c)})}),this},"delete":function(a){return this.destroy(a)},isPersisted:function(){return!!this.persistent},isNew:function(){return!this.isPersisted()},reload:function(){},store:function(){return this.constructor.store()},_save:function(a){var b=this;return this.runCallbacks("save",function(){return b.isNew()?b._create(a):b._update(b.toUpdates(),a)})},_update:function(a,b){var c=this;return this.runCallbacks("update",function(){return c.constructor.update(c.id,a,{instantiate:!1},function(a){if(a&&!b)throw a;a||(c.changes={}),c.persistent=!0;if(b)return b.call(c,a)})}),this},_create:function(a){var b=this;return this.runCallbacks("create",function(){return b.constructor.create(b.attributes,{instantiate:!1},function(c,d){if(c&&!a)throw c;c||(_.extend(b.attributes,d),b.changes={},b.persistent=!0,b.store().load(b));if(a)return a.call(b,c)})}),this}}},Tower.Model.Scopes={ClassMethods:{scope:function(a,b){return this[a]=b instanceof Tower.Model.Scope?b:this.where(b)},scoped:function(){var a;return a=new Tower.Model.Scope({model:this}),this.baseClass().name!==this.name&&a.where({type:this.name}),a},defaultSort:function(a){return a&&(this._defaultSort=a),this._defaultSort||(this._defaultSort={name:"createdAt",direction:"desc"})}}},_ref=Tower.Model.Scope.scopes,_fn=function(a){return Tower.Model.Scopes.ClassMethods[a]=function(){var b;return(b=this.scoped())[a].apply(b,arguments)}};for(_i=0,_len=_ref.length;_i<_len;_i++)key=_ref[_i],_fn(key);_ref2=Tower.Model.Scope.finders,_fn2=function(a){return Tower.Model.Scopes.ClassMethods[a]=function(){var b;return(b=this.scoped())[a].apply(b,arguments)}};for(_j=0,_len2=_ref2.length;_j<_len2;_j++)key=_ref2[_j],_fn2(key);_ref3=Tower.Model.Scope.builders,_fn3=function(a){return Tower.Model.Scopes.ClassMethods[a]=function(){var b;return(b=this.scoped())[a].apply(b,arguments)}};for(_k=0,_len3=_ref3.length;_k<_len3;_k++)key=_ref3[_k],_fn3(key);Tower.Model.Serialization={ClassMethods:{fromJSON:function(a){var b,c,d,e;d=JSON.parse(a),d instanceof Array||(d=[d]);for(b=0,e=d.length;b<e;b++)c=d[b],d[b]=new this(c);return d},toJSON:function(a,b){var c,d,e,f;b==null&&(b={}),d=[];for(e=0,f=a.length;e<f;e++)c=a[e],d.push(c.toJSON());return d}},toJSON:function(a){return this._serializableHash(a)},clone:function(){return new this.constructor(Tower.Support.Object.clone(this.attributes))},_serializableHash:function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v;a==null&&(a={}),n={},b=Tower.Support.Object.keys(this.attributes);if(j=a.only)b=_.union(Tower.Support.Object.toArray(j),b);else if(c=a.except)b=_.difference(Tower.Support.Object.toArray(c),b);for(p=0,q=b.length;p<q;p++)i=b[p],n[i]=this._readAttributeForSerialization(i);if(h=a.methods){g=Tower.Support.Object.toArray(h);for(u=0,r=h.length;u<r;u++)i=h[u],n[i]=this[i]()}if(f=a.include){f=Tower.Support.Object.toArray(f);for(v=0,s=f.length;v<s;v++){e=f[v],Tower.Support.Object.isHash(e)||(o={},o[e]={},e=o,o=void 0);for(i in e){k=e[i],m=this[i]().all();for(d=0,t=m.length;d<t;d++)l=m[d],m[d]=l._serializableHash(k);n[i]=m}}}return n},_readAttributeForSerialization:function(a,b){return b==null&&(b="json"),this.attributes[a]}},Tower.Model.Validator=function(){function a(a,b,c){this.name=a,this.value=b,this.attributes=c}return a.create=function(a,b,c){switch(a){case"presence":return new this.Presence(a,b,c);case"count":case"length":case"min":case"max":return new this.Length(a,b,c);case"format":return new this.Format(a,b,c)}},a.prototype.validateEach=function(a,b){var c,d,e,f,g;d=!0,g=this.attributes;for(e=0,f=g.length;e<f;e++)c=g[e],this.validate(a,c,b)||(d=!1);return d},a.prototype.error=function(a,b,c,d){return c[b]||(c[b]=[]),c[b].push(d),!1},a}(),Tower.Model.Validator.Format=function(){function a(b,c){a.__super__.constructor.call(this,b,c),this.value=typeof b=="string"?new RegExp(b):b}return a.prototype.validate=function(a,b,c){var d;return d=a[b],this.value.exec(d)?!0:(c[b]||(c[b]=[]),c[b].push(Tower.t("model.errors.format",{attribute:b,value:this.value.toString()})),!1)},a}(),Tower.Model.Validator.Length=function(){function a(b,c,d){a.__super__.constructor.apply(this,arguments),this.validate=function(){switch(b){case"min":return this.validateMinimum;case"max":return this.validateMaximum;default:return this.validateLength}}.call(this)}return __extends(a,Tower.Model.Validator),a.prototype.validateMinimum=function(a,b,c){var d;return d=a[b],typeof d=="number"&&d>=this.value?!0:this.error(a,b,c,Tower.t("model.errors.minimum",{attribute:b,value:this.value}))},a.prototype.validateMaximum=function(a,b,c){var d;return d=a[b],typeof d=="number"&&d<=this.value?!0:(c[b]||(c[b]=[]),c[b].push(Tower.t("model.errors.maximum",{attribute:b,value:this.value})),!1)},a.prototype.validateLength=function(a,b,c){var d;return d=a[b],typeof d!="number"||d!==this.value?(c[b]||(c[b]=[]),c[b].push(Tower.t("model.errors.length",{attribute:b,value:this.value})),!1):!0},a}(),Tower.Model.Validator.Presence=function(){function a(){a.__super__.constructor.apply(this,arguments)}return __extends(a,Tower.Model.Validator),a.prototype.validate=function(a,b,c){return Tower.Support.Object.isPresent(a[b])?!0:(c[b]||(c[b]=[]),c[b].push(Tower.t("model.errors.presence",{attribute:b})),!1)},a}(),Tower.Model.Validator.Uniqueness=function(){function a(){a.__super__.constructor.apply(this,arguments)}return __extends(a,Tower.Model.Validator),a.prototype.validate=function(a,b,c){return!0},a}(),Tower.Model.Validations={ClassMethods:{validates:function(){var a,b,c,d,e,f;a=Tower.Support.Array.args(arguments),c=a.pop(),d=this.validators(),f=[];for(b in c)e=c[b],f.push(d.push(Tower.Model.Validator.create(b,e,a)));return f},validators:function(){return this._validators||(this._validators=[])}},validate:function(a){var b=this;return this.runCallbacks("validate",function(){var c,d,e,f,g,h;f=b.constructor.validators(),d=!0,c=b.errors={};for(g=0,h=f.length;g<h;g++)e=f[g],e.validateEach(b,c)||(d=!1);return a&&a.call(b,null,d),d})}},Tower.Model.Timestamp={ClassMethods:{timestamps:function(){return this.include(Tower.Model.Timestamp.CreatedAt),this.include(Tower.Model.Timestamp.UpdatedAt),this.field("createdAt",{type:"Date"}),this.field("updatedAt",{type:"Date"}),this.before("create","setCreatedAt"),this.before("save","setUpdatedAt")}},CreatedAt:{ClassMethods:{},setCreatedAt:function(){return this.set("createdAt",new Date)}},UpdatedAt:{ClassMethods:{},setUpdatedAt:function(){return this.set("updatedAt",new Date)}}},Tower.Support.I18n.load({model:{errors:{presence:"%{attribute} can't be blank",minimum:"%{attribute} must be a minimum of %{value}",maximum:"%{attribute} must be a maximum of %{value}",length:"%{attribute} must be equal to %{value}",format:"%{attribute} must be match the format %{value}",inclusion:"%{attribute} is not included in the list",exclusion:"%{attribute} is reserved",invalid:"%{attribute} is invalid",confirmation:"%{attribute} doesn't match confirmation",accepted:"%{attribute} must be accepted",empty:"%{attribute} can't be empty",blank:"%{attribute} can't be blank",tooLong:"%{attribute} is too long (maximum is %{count} characters)",tooShort:"%{attribute} is too short (minimum is %{count} characters)",wrongLength:"%{attribute} is the wrong length (should be %{count} characters)",taken:"%{attribute} has already been taken",notANumber:"%{attribute} is not a number",greaterThan:"%{attribute} must be greater than %{count}",greaterThanOrEqualTo:"%{attribute} must be greater than or equal to %{count}",equalTo:"%{attribute} must be equal to %{count}",lessThan:"%{attribute} must be less than %{count}",lessThanOrEqualTo:"%{attribute} must be less than or equal to %{count}",odd:"%{attribute} must be odd",even:"%{attribute} must be even",recordInvalid:"Validation failed: %{errors}"},fullMessages:{format:"%{message}"}}}),Tower.Model.include(Tower.Support.Callbacks),Tower.Model.include(Tower.Model.Metadata),Tower.Model.include(Tower.Model.Dirty),Tower.Model.include(Tower.Model.Criteria),Tower.Model.include(Tower.Model.Scopes),Tower.Model.include(Tower.Model.Persistence),Tower.Model.include(Tower.Model.Inheritance),Tower.Model.include(Tower.Model.Serialization),Tower.Model.include(Tower.Model.Relations),Tower.Model.include(Tower.Model.Validations),Tower.Model.include(Tower.Model.Fields),Tower.Model.include(Tower.Model.Timestamp),Tower.View=function(){function a(a){a==null&&(a={}),this._context=a}return __extends(a,Tower.Class),a.extend({engine:"coffee",prettyPrint:!1,loadPaths:["app/views"],componentSuffix:"widget",hintClass:"hint",hintTag:"figure",labelClass:"label",requiredClass:"required",requiredAbbr:"*",requiredTitle:"Required",errorClass:"error",errorTag:"output",validClass:null,optionalClass:"optional",optionalAbbr:"",optionalTitle:"Optional",labelMethod:"humanize",labelAttribute:"toLabel",validationMaxLimit:255,defaultTextFieldSize:null,defaultTextAreaWidth:300,allFieldsRequiredByDefault:!0,fieldListTag:"ol",fieldListClass:"field-list",fieldTag:"li",separator:"-",breadcrumb:" - ",includeBlankForSelectByDefault:!0,collectionLabelMethods:["toLabel","displayName","fullName","name","title","toString"],i18nLookupsByDefault:!0,escapeHtmlEntitiesInHintsAndLabels:!1,renameNestedAttributes:!0,inlineValidations:!0,autoIdForm:!0,fieldsetClass:"fieldset",fieldClass:"field",validateClass:"validate",legendClass:"legend",formClass:"form",idEnabledOn:["input"],widgetsPath:"shared/widgets",navClass:"list-item",includeAria:!0,activeClass:"active",navTag:"li",termsTag:"dl",termClass:"term",termKeyClass:"key",termValueClass:"value",hintIsPopup:!1,listTag:"ul",pageHeaderId:"header",pageTitleId:"title",autoIdNav:!1,pageSubtitleId:"subtitle",widgetClass:"widget",headerClass:"header",titleClass:"title",subtitleClass:"subtitle",contentClass:"content",defaultHeaderLevel:3,termSeparator:":",richInput:!1,submitFieldsetClass:"submit-fieldset",addLabel:"+",removeLabel:"-",cycleFields:!1,alwaysIncludeHintTag:!1,alwaysIncludeErrorTag:!0,requireIfValidatesPresence:!0,localizeWithNamespace:!1,localizeWithNestedModel:!1,localizeWithInheritance:!0,defaultComponentHeaderLevel:3,metaTags:["description","keywords","author","copyright","category","robots"],store:function(a){return a&&(this._store=a),this._store||(this._store=new Tower.Store.Memory({name:"view"}))}}),a}(),Tower.View.Helpers={titleTag:function(a){return"<title>"+a+"</title>"},metaTag:function(a,b){return'<meta name="'+a+'" content="'+b+'"/>'},tag:function(a,b){},linkTag:function(a,b,c){},imageTag:function(a,b){},csrfMetaTag:function(){return this.metaTag("csrf-token",this.request.session._csrf)},contentTypeTag:function(a){return a==null&&(a="UTF-8"),'<meta charset="'+a+'" />'},javascriptTag:function(a){return'<script type="text/javascript" src="'+a+'" ></script>'},stylesheetTag:function(a){return'<link href="'+a+'" media="screen" rel="stylesheet" type="text/css"/>'},mobileTags:function(){return"<meta content='yes' name='apple-mobile-web-app-capable'>\n<meta content='yes' name='apple-touch-fullscreen'>\n<meta content='initial-scale = 1.0, maximum-scale = 1.0, user-scalable = no, width = device-width' name='viewport'>"}},Tower.View.Rendering={render:function(a,b){var c;return a.type||(a.type=this.constructor.engine),!a.hasOwnProperty("layout")&&this._context.layout&&(a.layout=this._context.layout()),a.locals=this._renderingContext(a),c=this,this._renderBody(a,function(d,e){return d?b(d,e):c._renderLayout(e,a,b)})},partial:function(a,b,c){var d,e;return typeof b=="function"&&(c=b,b={}),b||(b={}),d=b.prefixes,this._context&&(d||(d=[this._context.collectionName])),e=this._readTemplate(a,d,b.type||Tower.View.engine),this._renderString(e,b,c)},_renderBody:function(a,b){return a.text?b(null,a.text):a.json?b(null,typeof a.json=="string"?a.json:JSON.stringify(a.json)):(a.inline||(a.template=this._readTemplate(a.template,a.prefixes,a.type)),this._renderString(a.template,a,b))},_renderLayout:function(a,b,c){var d;return b.layout?(d=this._readTemplate("layouts/"+b.layout,[],b.type),b.locals.body=a,this._renderString(d,b,c)):c(null,a)},_renderString:function(a,b,c){var d,e,f,g;b==null&&(b={});if(!b.type.match(/coffee/))return b.type?(e=require("shift").engine(b.type),e.render(a,b.locals,c)):(e=require("shift"),b.locals.string=a,e.render(b.locals,c));d=null,g=null;try{f=b.locals,f.renderWithEngine=this.renderWithEngine,f.cache=Tower.env!=="development",f.format=!0,f.hardcode=_.extend({},Tower.View.ComponentHelper,Tower.View.AssetHelper,Tower.View.HeadHelper,Tower.View.RenderingHelper,Tower.View.StringHelper,{tags:require("coffeekup").tags}),f._=_,g=require("coffeekup").render(a,f)}catch(h){d=h}return c(d,g)},_renderingContext:function(a){var b,c,d,e;c=this,e=this._context;for(b in e)d=e[b],b.match(/^(constructor)/)||(this[b]=d);return c=Tower.Support.Object.extend(c,a.locals),this.constructor.prettyPrint&&(c.pretty=!0),c},_readTemplate:function(a,b,c){var d;if(typeof a!="string")return a;d=this.constructor.store().find({path:a,ext:c,prefixes:b});if(!d)throw new Error("Template '"+a+"' was not found.");return d},renderWithEngine:function(a,b){return require("shift").engine(b||"coffee").render(a)}},Tower.View.Component=function(){function a(a,b){var c,d;for(c in b)d=b[c],this[c]=d}return a.render=function(){var a,b,c,d;return a=Tower.Support.Array.args(arguments),d=a.shift(),b=Tower.Support.Array.extractBlock(a),c=Tower.Support.Array.extractOptions(a),c.template=d,(new this(a,c)).render(b)},a.prototype.tag=function(){var a,b;return b=arguments[0],a=2<=arguments.length?__slice.call(arguments,1):[],this.template.tag(b,a)},a}(),Tower.View.Table=function(){function a(b,c){var d,e,f;a.__super__.constructor.apply(this,arguments),f=b.shift(),this.key=this.recordKey(f),this.rowIndex=0,this.cellIndex=0,this.scope="table",this.headers=[],c.summary||(c.summary="Table for "+_.titleize(this.key)),c.role="grid",e=c.data||(c.data={}),c.hasOwnProperty("total")&&(e.total=c.total),c.hasOwnProperty("page")&&(e.page=c.page),c.hasOwnProperty("count")&&(e.count=c.count),d=c.aria||{},delete c.aria,!d.hasOwnProperty("aria-multiselectable")&&c.multiselect!==!0&&(d["aria-multiselectable"]=!1),c.id||(c.id=""+f+"-table"),this.options=c}return __extends(a,Tower.View.Component),a.prototype.render=function(a){return table(this.options,function(){return a(this)})},a.prototype.tableQueryRowClass=function(){return["search-row",queryParams.except("page","sort").blank!=null?null:"search-results"].compact.join(" ")},a.prototype.linkToSort=function(a,b,c){var d;return c==null&&(c={}),d=sortValue(b,oppositeSortDirection(b)),linkTo(a,withParams(request.path,{sort:d}),c)},a.prototype.nextPagePath=function(a){return withParams(request.path,{page:a.nextPage})},a.prototype.prevPagePath=function(a){return withParams(request.path,{page:a.prevPage})},a.prototype.firstPagePath=function(a){return withParams(request.path,{page:1})},a.prototype.lastPagePath=function(a){return withParams(request.path,{page:a.lastPage})},a.prototype.currentPageNum=function(){var a;return a=params.page?params.page:1,a<1&&(a=1),a},a.prototype.caption=function(){},a.prototype.head=function(a,b){return a==null&&(a={}),this.hideHeader=a.visible===!1,delete a.visible,this._section("head",a,b)},a.prototype.body=function(a,b){return a==null&&(a={}),this._section("body",a,b)},a.prototype.foot=function(a,b){return a==null&&(a={}),this._section("foot",a,b)},a.prototype._section=function(a,b,c){return this.rowIndex=0,this.scope=a,tag("t"+a,b,c),this.rowIndex=0,this.scope="table"},a.prototype.row=function(){var a,b,c,d;return a=2<=arguments.length?__slice.call(arguments,0,d=arguments.length-1):(d=0,[]),c=arguments[d++],b=Tower.Support.Array.extractOptions(a),b.scope="row",this.scope==="body"&&(b["class"]=[template.cycle("odd","even"),b["class"]].compact.uniq.join(" "),b.role="row"),this.rowIndex+=1,this.cellIndex=0,tag("tr",b,c),this.cellIndex=0},a.prototype.column=function(){var a,b,c,d,e,f;a=2<=arguments.length?__slice.call(arguments,0,f=arguments.length-1):(f=0,[]),c=arguments[f++],b=Tower.Support.Array.extractOptions(a),d=a.shift();if(typeof (e=config.idEnabledOn).include=="function"?e.include("table"):void 0)b.id||(b.id=this.idFor("header",key,d,this.rowIndex,this.cellIndex));return b.hasOwnProperty("width")&&(b.width=this.pixelate(b.width)),b.hasOwnProperty("height")&&(b.height=this.pixelate(b.height)),this.headers.push(b.id),tag("col",b),this.cellIndex+=1},a.prototype.header=function(){var a,b,c,d,e,f,g,h,i;a=2<=arguments.length?__slice.call(arguments,0,i=arguments.length-1):(i=0,[]),c=arguments[i++],b=Tower.Support.Array.extractOptions(a),g=a.shift(),b.abbr||(b.abbr=g),b.role="columnheader";if(typeof (h=config.idEnabledOn).include=="function"?h.include("table"):void 0)b.id||(b.id=this.idFor("header",key,g,this.rowIndex,this.cellIndex));return b.scope="col",b.hasOwnProperty("for")&&(b.abbr||(b.abbr=b["for"])),b.abbr||(b.abbr=g),delete b["for"],b.hasOwnProperty("width")&&(b.width=this.pixelate(b.width)),b.hasOwnProperty("height")&&(b.height=this.pixelate(b.height)),f=b.sort===!0,delete b.sort,f&&(b["class"]=[b["class"],b.sortClass||"sortable"].compact.uniq.join(" "),b.direction||(b.direction=template.sortClass(g))),delete b.sortClass,e=b.label||_.titleize(g.toString()),delete b.label,d=b.direction,delete b.direction,d?(b["aria-sort"]=d,b["class"]=[b["class"],d].join(" "),b["aria-selected"]=!0):(b["aria-sort"]="none",b["aria-selected"]=!1),this.headers.push(b.id),c?tag("th",b,c):f?tag("th",b(function(){return linkToSort(e,g)})):tag("th",b(function(){return tag("span",e)})),this.cellIndex+=1},a.prototype.cell=function(){var a,b,c,d,e,f;a=2<=arguments.length?__slice.call(arguments,0,f=arguments.length-1):(f=0,[]),c=arguments[f++],b=Tower.Support.Array.extractOptions(a),d=a.shift(),b.role="gridcell";if(typeof (e=config.idEnabledOn).include=="function"?e.include("table"):void 0)b.id||(b.id=this.idFor("cell",key,d,this.rowIndex,this.cellIndex));return b.headers=this.headers[this.cellIndex],b.hasOwnProperty("width")&&(b.width=this.pixelate(b.width)),b.hasOwnProperty("height")&&(b.height=this.pixelate(b.height)),c?tag("td",b,c):tag("td",d,b),this.cellIndex+=1},a.prototype.recordKey=function(a){return typeof a=="string"?a:a.constructor.name},a.prototype.idFor=function(a,b,c,d,e){return d==null&&(d=this.row_index),e==null&&(e=this.column_index),[b,a,d,e].compact.map(function(a){return a.replace(/[\s_]/,"-")}),end.join("-")},a.prototype.pixelate=function(a){return typeof a=="string"?a:""+a+"px"},a}(),Tower.View.Form=function(){function a(b,c){var d;a.__super__.constructor.apply(this,arguments),this.model=b.shift(),typeof this.model=="string"&&(d=Tower.constant(Tower.Support.String.camelize(this.model)),this.model=d?new d:null),this.attributes=this._extractAttributes(b.pop())}return __extends(a,Tower.View.Component),a.prototype.render=function(a){var b=this;return this.tag("form",this.attributes,function(){var c;b.tag("input",{type:"hidden",name:"_method",value:b.attributes["data-method"]});if(a)return c=new Tower.View.Form.Builder({template:b.template,tabindex:1,accessKeys:{},model:b.model}),c.render(a)})},a.prototype._extractAttributes=function(a){var b,c;a==null&&(a={}),b=a.html||{},b.action=a.url,a.hasOwnProperty("class")&&(b["class"]=a["class"]),a.hasOwnProperty("id")&&(b.id=a.id);if(a.multipart||b.multipart===!0)b.enctype="multipart/form-data";b.role="form",b.novalidate="true",a.hasOwnProperty("validate")&&(b["data-validate"]=a.validate.toString()),c=b.method||a.method;if(!c||c==="")this.model&&this.model.isNew()?c="post":c="post";return b["data-method"]=c,b.method=c==="get"?"get":"post"},a}(),Tower.View.Form.Builder=function(){function a(a,b){b==null&&(b={}),this.template=b.template,this.model=b.model,this.attribute=b.attribute,this.parentIndex=b.parentIndex,this.index=b.index,this.tabindex=b.tabindex,this.accessKeys=b.accessKeys}return __extends(a,Tower.View.Component),a.prototype.defaultOptions=function(a){return a==null&&(a={}),a.model||(a.model=this.model),a.index||(a.index=this.index),a.attribute||(a.attribute=this.attribute),a.template||(a.template=this.template),a},a.prototype.fieldset=function(){var a,b,c;return a=1<=arguments.length?__slice.call(arguments,0):[],b=a.pop(),c=this.defaultOptions(Tower.Support.Array.extractOptions(a)),c.label||(c.label=a.shift()),(new Tower.View.Form.Fieldset(c)).render(b)},a.prototype.fields=function(){var a,b;return b=args.extractOptions,b.as="fields",b.label||(b.label=!1),a=args.shift()||attribute.name,template.captureHaml(function(){var c;return c=field(a,b(function(a){return template.hamlConcat(fieldset(block).gsub(/\n$/,""))})),template.hamlConcat(c.gsub(/\n$/,""))})},a.prototype.fieldsFor=function(){var a,b,c,d,e,f,g,h;f=args.extractOptions,b=args.shift,e=model.macroFor(b),a=nil,f.as==="object"?a=b.toS:a=config.renameNestedAttributes?""+b+"_attributes":b.toS,h=model.object,g=args.shift,c=f["delete"]("index");if(c.present==null||typeof c!="string")g.blank!=null&&c.present!=null?g=h.send(b)[c]:c.blank!=null&&g.present!=null&&e==="hasMany"&&(c=h.send(b).index(g));return g||(g=model["default"](b)||model.toS.camelize.constantize["new"]),d=[model.keys,a],f.merge({template:template,model:model,parentIndex:c,accessKeys:accessKeys,tabindex:tabindex}),(new Tower.View.Form.Builder(f)).render(block)},a.prototype.field=function(){var a,b,c,d,e;return a=Tower.Support.Array.args(arguments),c=Tower.Support.Array.extractBlock(a),e=Tower.Support.Array.extractOptions(a),b=a.shift()||"attribute.name",d={template:this.template,model:this.model,parentIndex:this.parentIndex,index:this.index,fieldHtml:e.fieldHtml||{},inputHtml:e.inputHtml||{},labelHtml:e.labelHtml||{},errorHtml:e.errorHtml||{},hintHtml:e.hintHtml||{}},(new Tower.View.Form.Field(_.extend(d,e))).render(c)},a.prototype.button=function(){var a;return a=args.extractOptions,a.reverseMerge({as:"submit"}),a.value=args.shift||"Submit",field(a.value,a,block)},a.prototype.submit=function(){return template.captureHaml(function(){var a;return a=fieldset({"class":config.submitFieldsetClass(function(a){template.hamlConcat(a.button.apply(a,args).gsub(/\n$/,""));if(block)return yield(a)})}),template.hamlConcat(a.gsub(/\n$/,""))})},a.prototype.partial=function(a,b){return b==null&&(b={}),this.template.render({partial:a,locals:b.merge({fields:self})})},a.prototype.tag=function(){var a,b;return b=arguments[0],a=2<=arguments.length?__slice.call(arguments,1):[],this.template.tag(b,a)},a.prototype.render=function(a){return a(this)},a}(),Tower.View.Form.Fieldset=function(){function a(b,c){var d;a.__super__.constructor.apply(this,arguments),this.attributes=d={},delete d.index,delete d.parentIndex,delete d.label,this.builder=new Tower.View.Form.Builder({template:this.template,model:this.model,attribute:this.attribute,index:this.index,parentIndex:this.parentIndex})}return __extends(a,Tower.View.Component),a.prototype.render=function(a){var b=this;return this.tag("fieldset",this.attributes,function(){return b.label&&b.tag("legend",{"class":Tower.View.legendClass},function(){return b.tag("span",b.label)}),b.tag(Tower.View.fieldListTag,{"class":Tower.View.fieldListClass},function(){return b.builder.render(a)})})},a}(),Tower.View.Form.Field=function(){function a(b,c){a.__super__.constructor.apply(this,arguments),this.inputType=c.as,this.inputs=[],this.attributes={}}return __extends(a,Tower.View.Component),a.prototype.input=function(){var a,b;return a=1<=arguments.length?__slice.call(arguments,0):[],b=a.extractOptions,key=a.shift||attribute.name,this.inputs.push(inputFor(inputType,key,b))},a.prototype.render=function(a){var b=this;return this.tag(Tower.View.fieldTag,this.attributes,function(){return b.tag("input",{type:"email"})})},a.prototype.inputFor=function(a,b,c){return c==null&&(c={}),Tower.View.Form.Input.find(a)["new"](this.inputAttributes.merge(c))},a.prototype.extractElements=function(a){var b,c;return a==null&&(a={}),b=[],(typeof (c=["hidden","submit"]).include=="function"?c.include(inputType):void 0)?b.push("inputs"):(this.label.present!=null&&this.label.value!=null&&b.push("label"),b=b.concat(["inputs","hints","errors"])),b},a}(),Tower.View.AssetHelper={javascripts:function(){var a,b,c,d,e,f;d=1<=arguments.length?__slice.call(arguments,0):[],a=Tower.Support.Array.extractOptions(d),a.namespace="javascripts",a.extension="js",c=this._extractAssetPaths(d,a);for(e=0,f=c.length;e<f;e++)b=c[e],javascriptTag(b);return null},javascript:function(){return javascript.apply(this,arguments)},stylesheets:function(){var a,b,c,d,e,f;d=1<=arguments.length?__slice.call(arguments,0):[],a=Tower.Support.Array.extractOptions(d),a.namespace="stylesheets",a.extension="css",c=this._extractAssetPaths(d,a);for(e=0,f=c.length;e<f;e++)b=c[e],stylesheetTag(b);return null},stylesheet:function(){return stylesheets.apply(this,arguments)},_extractAssetPaths:function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o;b==null&&(b={}),e=b.namespace,c=b.extension,h=[];if(Tower.env==="production"){d=Tower.assetManifest;for(j=0,k=a.length;j<k;j++)i=a[j],i.match(/^(http|\/{2})/)||(i=""+i+"."+c,d[i]&&(i=d[i]),i="/assets/"+i,Tower.assetHost&&(i=""+Tower.assetHost+i)),h.push(i)}else for(n=0,l=a.length;n<l;n++){i=a[n];if(!i.match(/^(http|\/{2})/)){g=Tower.config.assets[e][i];if(g)for(o=0,m=g.length;o<m;o++)f=g[o],h.push("/"+e+f+"."+c)}else h.push(i)}return h},stylesheetTag:function(a){return link({rel:"stylesheet",href:a})},javascriptTag:function(a){return script({src:a})}},Tower.View.ComponentHelper={formFor:function(){var a;return(a=Tower.View.Form).render.apply(a,[__ck].concat(__slice.call(arguments)))},tableFor:function(){var a;return(a=Tower.View.Table).render.apply(a,[__ck].concat(__slice.call(arguments)))},widget:function(){},linkTo:function(b,c,d){return d==null&&(d={}),a(_.extend(d,{href:c,title:b}),b)}},Tower.View.DateHelper={},Tower.View.ElementHelper={elementId:function(){return"#"+this.elementKey.apply(this,arguments)},elementClass:function(){return"."+this.elementKey.apply(this,arguments)},elementKey:function(){return Tower.Support.String.parameterize(this.elementNameComponents.apply(this,arguments).join("-"))},elementName:function(){var a,b,c,d;c=this.elementNameComponents.apply(this,arguments),a=1;for(a=0,d=c.length;a<d;a++)b=c[a],c[a]="["+b+"]";return Tower.Support.String.parameterize(c.join(""))},elementNameComponents:function(){var a,b,c,d,e;a=Tower.Support.Array.args(arguments),c=[];for(d=0,e=a.length;d<e;d++){b=a[d];switch(typeof b){case"function":c.push(b.constructor.name);break;case"string":c.push(b);break;default:c.push(b.toString())}}return c}},Tower.View.HeadHelper={metaTag:function(a,b){return meta({name:a,content:b})},snapshotLinkTag:function(a){return linkTag({rel:"imageSrc",href:a})},html4ContentTypeTag:function(a,b){return a==null&&(a="UTF-8"),b==null&&(b="text/html"),httpMetaTag("Content-Type",""+b+"; charset="+a)},chromeFrameTag:function(){return html4ContentTypeTag(),meta({"http-equiv":"X-UA-Compatible",content:"IE=Edge,chrome=1"})},html5ContentTypeTag:function(a){return a==null&&(a="UTF-8"),meta({charset:a})},contentTypeTag:function(a){return html5ContentTypeTag(a)},csrfMetaTag:function(){return metaTag("csrf-token",this.request.session._csrf)},searchLinkTag:function(a,b){return linkTag({rel:"search",type:"application/opensearchdescription+xml",href:a,title:b})},faviconLinkTag:function(a){return a==null&&(a="/favicon.ico"),linkTag({rel:"shortcut icon",href:a,type:"image/x-icon"})},linkTag:function(a){return a==null&&(a={}),link(a)},ieApplicationMetaTags:function(a,b){var c;return b==null&&(b={}),c=[],c.push(metaTag("application-name",a)),b.hasOwnProperty("tooltip")&&c.push(metaTag("msapplication-tooltip",b.tooltip)),b.hasOwnProperty("url")&&c.push(metaTag("msapplication-starturl",b.url)),b.hasOwnProperty("width")&&b.hasOwnProperty("height")&&(c.push(metaTag("msapplication-window","width="+b.width+";height="+b.height)),b.hasOwnProperty("color")&&c.push(metaTag("msapplication-navbutton-color",b.color))),c.join("\n")},ieTaskMetaTag:function(a,b,c){var d;return c==null&&(c=null),d=[],d.push("name="+a),d.push("uri="+b),c&&d.push("icon-uri="+c),this.metaTag("msapplication-task",d.join(";"))},appleMetaTags:function(a){var b;return a==null&&(a={}),b=[],b.push(appleViewportMetaTag(a)),a.hasOwnProperty("fullScreen")&&b.push(appleFullScreenMetaTag(a.fullScreen)),a.hasOwnProperty("mobile")&&b.push(appleMobileCompatibleMetaTag(a.mobile)),b.join()},appleViewportMetaTag:function(a){var b;return a==null&&(a={}),b=[],a.hasOwnProperty("width")&&b.push("width="+a.width),a.hasOwnProperty("height")&&b.push("height="+a.height),b.push("initial-scale="+(a.scale||1)),a.hasOwnProperty("min")&&b.push("minimum-scale="+a.min),a.hasOwnProperty("max")&&b.push("maximum-scale="+a.max),a.hasOwnProperty("scalable")&&b.push("user-scalable="+boolean(a.scalable)),metaTag("viewport",b.join(", "))},appleFullScreenMetaTag:function(a){return metaTag("apple-touch-fullscreen",boolean(a))},appleMobileCompatibleMetaTag:function(a){return metaTag("apple-mobile-web-app-capable",boolean(a))},appleTouchIconLinkTag:function(a,b){var c;return b==null&&(b={}),c=["apple-touch-icon"],b.hasOwnProperty("size")&&c.push(""+b.size+"x"+b.size),b.precomposed&&c.push("precomposed"),linkTag({rel:c.join("-"),href:a})},appleTouchIconLinkTags:function(){var a,b,c,d,e,f,g;b=arguments[0],e=2<=arguments.length?__slice.call(arguments,1):[],typeof e[e.length-1]=="object"?a=e.pop():a={},c=[];for(f=0,g=e.length;f<g;f++)d=e[f],c.push(appleTouchIconLinkTag(b,_.extend({size:d},a)));return c.join()},openGraphMetaTags:function(a){var b;return a==null&&(a={}),b=[],a.title&&b.push(openGraphMetaTag("og:title",a.title)),a.type&&b.push(openGraphMetaTag("og:type",a.type)),a.image&&b.push(openGraphMetaTag("og:image",a.image)),a.site&&b.push(openGraphMetaTag("og:siteName",a.site)),a.description&&b.push(openGraphMetaTag("og:description",a.description)),a.email&&b.push(openGraphMetaTag("og:email",a.email)),a.phone&&b.push(openGraphMetaTag("og:phoneNumber",a.phone)),a.fax&&b.push(openGraphMetaTag("og:faxNumber",a.fax)),a.lat&&b.push(openGraphMetaTag("og:latitude",a.lat)),a.lng&&b.push(openGraphMetaTag("og:longitude",a.lng)),a.street&&b.push(openGraphMetaTag("og:street-address",a.street)),a.city&&b.push(openGraphMetaTag("og:locality",a.city)),a.state&&b.push(openGraphMetaTag("og:region",a.state)),a.zip&&b.push(openGraphMetaTag("og:postal-code",a.zip)),a.country&&b.push(openGraphMetaTag("og:country-name",a.country)),b.join("\n")},openGraphMetaTag:function(a,b){return meta({property:a,content:b})}},Tower.View.NumberHelper={},Tower.View.RenderingHelper={partial:function(path,options,callback){var item,name,prefixes,template,tmpl,_l,_len4,_ref4;typeof options=="function"&&(callback=options,options={}),options||(options={}),path=path.split("/"),path[path.length-1]="_"+path[path.length-1],path=path.join("/"),prefixes=options.prefixes,this._context&&(prefixes||(prefixes=[this._context.collectionName])),template=this._readTemplate(path,prefixes,options.type||Tower.View.engine),template=this.renderWithEngine(String(template)),tmpl="(function() {"+String(template)+"})";if(options.collection){name=options.as||Tower.Support.String.camelize(options.collection[0].constructor.name,!0),_ref4=options.collection;for(_l=0,_len4=_ref4.length;_l<_len4;_l++)item=_ref4[_l],this[name]=item,eval(tmpl).call(this),delete this[name]}else eval(tmpl).call(this);return null},page:function(){var a,b,c;return a=Tower.Support.Array.args(arguments),c=Tower.Support.Array.extractOptions(a),b=a.shift()||c.title,this.contentFor("title",function(){return title(b)})},yields:function(key){var ending,value;return value=this[key],typeof value=="function"?eval("("+String(value)+")()"):(ending=value.match(/\n$/)?"\n":"",text(value.replace(/\n$/,"").replace(/^(?!\s+$)/mg,__ck.repeat("  ",__ck.tabs))+ending)),null},hasContentFor:function(a){return!!this.hasOwnProperty(a)&&!!this[a]&&this[a]!==""},contentFor:function(a,b){return this[a]=b,null}},Tower.View.StringHelper={t:function(a){return Tower.Support.I18n.translate(a)},l:function(a){return Tower.Support.I18n.localize(string)},"boolean":function(a){return a?"yes":"no"}},Tower.View.include(Tower.View.Rendering),Tower.View.include(Tower.View.Helpers),Tower.View.include(Tower.View.AssetHelper),Tower.View.include(Tower.View.ComponentHelper),Tower.View.include(Tower.View.DateHelper),Tower.View.include(Tower.View.HeadHelper),Tower.View.include(Tower.View.NumberHelper),Tower.View.include(Tower.View.RenderingHelper),Tower.View.include(Tower.View.StringHelper),Tower.Controller=function(){function a(){this.constructor.instance=this,this.headers={},this.status=200,this.request=null,this.response=null,this.contentType=null,this.params={},this.query={},this.resourceName=this.constructor.resourceName(),this.resourceType=this.constructor.resourceType(),this.collectionName=this.constructor.collectionName(),this.formats=_.keys(this.constructor.mimes()),this.constructor._belongsTo?this.hasParent=!0:this.hasParent=!1}return __extends(a,Tower.Class),a.extend(Tower.Support.EventEmitter),a.include(Tower.Support.EventEmitter),a}(),Tower.Controller.Caching={freshWhen:function(){},stale:function(){},expiresIn:function(){}},Tower.Controller.Callbacks={ClassMethods:{beforeAction:function(){return this.before.apply(this,["action"].concat(__slice.call(arguments)))},beforeFilter:function(){return this.before.apply(this,["action"].concat(__slice.call(arguments)))},afterAction:function(){return this.after.apply(this,["action"].concat(__slice.call(arguments)))},afterFilter:function(){return this.after.apply(this,["action"].concat(__slice.call(arguments)))}}},Tower.Controller.Helpers={ClassMethods:{helper:function(a){return this._helpers||(this._helpers=[]),this._helpers.push(a)},layout:function(a){return this._layout=a},theme:function(a){return this._theme=a}},layout:function(){var a;return a=this.constructor._layout,typeof a=="function"?a.apply(this):a},urlFor:function(){return Tower.urlFor.apply(Tower,arguments)}},Tower.Controller.HTTP={head:function(a,b){var c;return b==null&&(b={}),typeof a=="object"&&(b=a,a=null),a||(a=b.status||"ok"),c=b.location,delete b.status,delete b.location,this.status=a,c&&(this.location=urlFor(c)),formats&&(this.contentType=Mime[formats.first]),this.body=" "}},Tower.Controller.Instrumentation={call:function(a,b,c){return this.request=a,this.response=b,this.params=this.request.params||{},this.cookies=this.request.cookies||{},this.query=this.request.query||{},this.session=this.request.session||{},this.format=this.params.format||"html",this.action=this.params.action,this.headers={},this.callback=c,this.process()},process:function(){var a=this;return this.processQuery(),this.runCallbacks("action",function(b){return a[a.action].call(a,b)})},processQuery:function(){},clear:function(){return this.request=null,this.response=null,this.headers=null}},Tower.Controller.Params={ClassMethods:{params:function(a,b){return typeof a=="function"&&(b=a,a={}),a&&(this._paramsOptions=Tower.Support.Object.extend(this._paramsOptions||{},a),b.call(this)),this._params||(this._params={})},param:function(a,b){return b==null&&(b={}),this._params||(this._params={}),this._params[a]=Tower.Dispatch.Param.create(a,Tower.Support.Object.extend({},this._paramsOptions||{},b))}},criteria:function(){var a,b,c,d,e;if(this._criteria)return this._criteria;this._criteria=a=new Tower.Model.Criteria,e=this.constructor.params(),c=this.params;for(b in e)d=e[b],c.hasOwnProperty(b)&&a.where(d.toCriteria(c[b]));return a},withParams:function(a,b){var c,d;return b==null&&(b={}),c=Tower.Support.Object.extend(this.query,b),Tower.Support.Object.blank(c)?a:(d=this.queryFor(c),""+a+"?"+query_string)},queryFor:function(a){a==null&&(a={})},paramOperators:function(a){}},Tower.Controller.Redirecting={redirectTo:function(){return this.redirect.apply(this,arguments)},redirect:function(){var a;return(a=this.response).redirect.apply(a,arguments)}},Tower.Controller.Rendering={ClassMethods:{addRenderer:function(a,b){return this.renderers()[a]=b},addRenderers:function(a){var b,c;a==null&&(a={});for(c in a)b=a[c],this.addRenderer(c,b);return this},renderers:function(){return this._renderers||(this._renderers={})}},render:function(){return this.renderToBody(this._normalizeRender.apply(this,arguments))},renderToBody:function(a){return this._processRenderOptions(a),this._renderTemplate(a)},renderToString:function(){return this.renderToBody(this._normalizeRender.apply(this,arguments))},sendFile:function(a,b){b==null&&(b={})},sendData:function(a,b){b==null&&(b={})},_renderTemplate:function(a){var b,c,d=this;b=function(a,b){a?(d.status||(d.status=404),d.body=a.stack):(d.status||(d.status=200),d.body=b);if(d.callback)return d.callback()};if(this._handleRenderers(a,b))return;this.contentType||(this.contentType="text/html"),this.headers["Content-Type"]=this.contentType,c=new Tower.View(this);try{return c.render.call(c,a,b)}catch(e){return b(e)}},_handleRenderers:function(a,b){var c,d,e;e=Tower.Controller.renderers();for(c in e){d=e[c];if(a.hasOwnProperty(c))return d.call(this,a[c],a,b),!0}return!1},_processRenderOptions:function(a){return a==null&&(a={}),a.status&&(this.status=a.status),a.contentType&&(this.contentType=a.contentType),a.location&&(this.headers.Location=this.urlFor(a.location)),this},_normalizeRender:function(){return this._normalizeOptions(this._normalizeArgs.apply(this,arguments))},_normalizeArgs:function(a,b){b==null&&(b={});switch(typeof a){case"undefined":case"object":b=a||{};break;case"string":key=a.match(/\//)?"file":"action",b[key]=a;break;default:b.partial=a}return b},_normalizeOptions:function(a){return a==null&&(a={}),a.partial===!0&&(a.partial=this.action),a.prefixes||(a.prefixes=[]),a.prefixes.push(this.collectionName),a.template||(a.template=a.file||a.action||this.action),a}},Tower.Controller.Resourceful={ClassMethods:{resource:function(a){return a.hasOwnProperty("name")&&(this._resourceName=a.name),a.hasOwnProperty("type")&&(this._resourceType=a.type),a.hasOwnProperty("collectionName")&&(this._collectionName=a.collectionName),this},resourceType:function(){return this._resourceType||(this._resourceType=Tower.Support.String.singularize(this.name.replace(/(Controller)$/,"")))},resourceName:function(){var a;return this._resourceName?this._resourceName:(a=this.resourceType().split("."),this._resourceName=Tower.Support.String.camelize(a[a.length-1],!0))},collectionName:function(){return this._collectionName||(this._collectionName=Tower.Support.String.camelize(this.name.replace(/(Controller)$/,""),!0))},belongsTo:function(a,b){return b==null&&(b={}),b.key=a,b.type||(b.type=Tower.Support.String.camelize(b.key)),this._belongsTo=b},actions:function(){var a,b,c,d,e,f,g;d=Tower.Support.Array.args(arguments),typeof d[d.length-1]=="object"?e=d.pop():e={},b=["index","new","create","show","edit","update","destroy"],c=_.difference(b,d,e.except||[]);for(f=0,g=c.length;f<g;f++)a=c[f],this[a]=null,delete this[a];return this}},index:function(){return this._index.apply(this,arguments)},"new":function(){return this._new.apply(this,arguments)},create:function(){return this._create.apply(this,arguments)},show:function(){return this._show.apply(this,arguments)},edit:function(){return this._edit.apply(this,arguments)},update:function(){return this._update.apply(this,arguments)},destroy:function(){return this._destroy.apply(this,arguments)},_index:function(a){return this.respondWithScoped(a)},_new:function(a){var b=this;return this.buildResource(function(c,d){return d?b.respondWith(d,a):b.failure(c)})},_create:function(a){var b=this;return this.buildResource(function(a,c){return c?c.save(function(a,c){return b.respondWithStatus(c,function(a){return a.html(function(){return b.redirectTo("/")}),a.json(function(){return b.render({text:"success",status:200})})})}):b.failure(a)})},_show:function(a){var b=this;return this.findResource(function(c,d){return b.respondWith(d,a)})},_update:function(a){var b=this;return this.findResource(function(c,d){return d?d.updateAttribute(b.params[b.resourceName],function(c,d){return b.respondWithStatus(d,a)}):b.failure(c)})},_destroy:function(a){var b=this;return this.findResource(function(c,d){return d?d.destroy(function(c,d){return b.respondWithStatus(d,a)}):b.failure(c)})},respondWithScoped:function(a){var b=this;return this.scoped(function(c,d){return c?b.failure(c):b.respondWith(d.build(),a)})},respondWithStatus:function(a,b){var c,d,e;return d={records:this.resource},b&&b.length>1?(e=new Tower.Controller.Responder(this,d),c=new Tower.Controller.Responder(this,d),b.call(this,e,c),a?e[format].call(this):c[format].call(this,error)):Tower.Controller.Responder.respond(this,d,b)},buildResource:function(a){var b=this;return this.scoped(function(c,d){var e;return c?a.call(b,c,null):(b[b.resourceName]=b.resource=e=d.build(b.params[b.resourceName]),a&&a.call(b,null,e),e)})},findResource:function(a){var b=this;return this.scoped(function(c,d){return c?a.call(b,c,null):d.find(b.params.id,function(c,d){return b[b.resourceName]=b.resource=d,a.call(b,c,d)})})},findParent:function(a){var b,c,d,e=this;return b=this.constructor._belongsTo,b?(c=b.param||""+b.key+"Id",d=Tower.constant(b.type),d.find(this.params[c],function(a,c){return e.parent=e[b.key]=c})):(a&&a.call(this,null,!1),!1)},scoped:function(a){var b,c=this;return b=function(b,d){return a.call(c,b,d.where(c.criteria().query))},this.hasParent?this.findParent(function(a,d){return b(a,d[c.collectionName])}):b(null,Tower.constant(this.resourceType))}},Tower.Controller.Responder=function(){function a(a,b){var c,d,e,f;b==null&&(b={}),this.controller=a,this.options=b,f=this.controller.formats;for(d=0,e=f.length;d<e;d++)c=f[d],this.accept(c)}return a.respond=function(a,b,c){var d;return d=new this(a,b),d.respond(c)},a.prototype.accept=function(a){return this[a]=function(b){return this["_"+a]=b}},a.prototype.respond=function(a){var b;return a&&a.call(this.controller,this),b=this["_"+this.controller.format],b?b.call(this):this.toFormat()},a.prototype._html=function(){return this.controller.render({action:this.controller.action})},a.prototype._json=function(){return this.controller.render({json:_.flatten(this.options.records)[0]})},a.prototype.toFormat=function(){try{return typeof get!="undefined"&&get!==null||typeof hasErrors=="undefined"||hasErrors===null?this.defaultRender():this.displayErrors()}catch(a){return this._apiBehavior(a)}},a.prototype._navigationBehavior=function(a){if(typeof get!="undefined"&&get!==null)throw a;return typeof hasErrors!="undefined"&&hasErrors!==null&&defaultAction?this.render({action:this.defaultAction}):this.redirectTo(this.navigationLocation)},a.prototype._apiBehavior=function(a){return typeof get!="undefined"&&get!==null?this.display(resource):typeof post!="undefined"&&post!==null?this.display(resource,{status:"created",location:this.apiLocation}):this.head("noContent")},a.prototype.isResourceful=function(){return this.resource.hasOwnProperty("to"+this.format.toUpperCase())},a.prototype.resourceLocation=function(){return this.options.location||this.resources},a.prototype.defaultRender=function(){return this.defaultResponse.call(options)},a.prototype.display=function(a,b){return b==null&&(b={}),this.controller.render(_.extend(b,this.options,{format:this.resource}))},a.prototype.displayErrors=function(){return this.controller.render({format:this.resourceErrors,status:"unprocessableEntity"})},a.prototype.hasErrors=function(){var a;return(typeof (a=this.resource).respondTo=="function"?a.respondTo("errors"):void 0)&&this.resource.errors.empty==null},a.prototype.defaultAction=function(){return this.action||(this.action=ACTIONS_FOR_VERBS[request.requestMethodSymbol])},a.prototype.resourceErrors=function(){return this.hasOwnProperty(""+format+"ResourceErrors")?this[""+format+"RresourceErrors"]:this.resource.errors},a.prototype.jsonResourceErrors=function(){return{errors:this.resource.errors}},a}(),Tower.Controller.Responding={ClassMethods:{respondTo:function(){var a,b,c,d,e,f,g,h;c=this.mimes(),a=Tower.Support.Array.args(arguments),typeof a[a.length-1]=="object"?f=a.pop():f={},f.only&&(e=Tower.Support.Object.toArray(f.only)),f.except&&(b=Tower.Support.Object.toArray(f.except));for(g=0,h=a.length;g<h;g++)d=a[g],c[d]={},e&&(c[d].only=e),b&&(c[d].except=b);return this},mimes:function(){return this._mimes||(this._mimes={})}},respondTo:function(a){return Tower.Controller.Responder.respond(this,{},a)},respondWith:function(){var a,b,c;return a=Tower.Support.Array.args(arguments),b=null,typeof a[a.length-1]=="function"&&(b=a.pop()),typeof a[a.length-1]!="object"||a[a.length-1]instanceof Tower.Model?c={}:c=a.pop(),c.records=a,Tower.Controller.Responder.respond(this,c,b)},_mimesForAction:function(){var a,b,c,d,e,f;a=this.action,e=[],d=this.constructor.mimes();for(c in d)b=d[c],f=!1,b.except?f=!_.include(b.except,a):b.only?f=_.include(b.only,a):f=!0,f&&e.push(c);return e}},Tower.Controller.Sockets={broadcast:function(){},emit:function(){},connect:function(){}},Tower.Controller.include(Tower.Support.Callbacks),Tower.Controller.include(Tower.Controller.Caching),Tower.Controller.include(Tower.Controller.Callbacks),Tower.Controller.include(Tower.Controller.Helpers),Tower.Controller.include(Tower.Controller.HTTP),Tower.Controller.include(Tower.Controller.Instrumentation),Tower.Controller.include(Tower.Controller.Params),Tower.Controller.include(Tower.Controller.Redirecting),Tower.Controller.include(Tower.Controller.Rendering),Tower.Controller.include(Tower.Controller.Resourceful),Tower.Controller.include(Tower.Controller.Responding),Tower.Controller.include(Tower.Controller.Sockets),Tower.Controller.addRenderers({json:function(a,b,c){return typeof a!="string"&&(a=JSON.stringify(a)),b.callback&&(a=""+b.callback+"("+a+")"),this.contentType||(this.contentType=require("mime").lookup("json")),c&&c(null,a),a}}),Tower.Controller.Elements={extractElements:function(a,b){var c,d,e,f,g;b==null&&(b={}),e={};for(d in b){g=b[d];for(c in g)f=g[c],e[c]=a[d](f)}return e},processElements:function(a,b){return b==null&&(b={}),this.elements=this.extractElements(a,b)},clickHandler:function(a,b,c){var d=this;return $(this.dispatcher).on(a,function(a){})},submitHandler:function(a,b,c){var d=this;return $(this.dispatcher).on(a,function(a){var e,f,g,h,i,j;return j=$(a.target),g=j.closest("form"),e=g.attr("action"),h=(g.attr("data-method")||g.attr("method")).toUpperCase(),i=g.serializeParams(),i.method=h,i.action=e,f=_.extend({target:j,form:g},d.extractElements(j,c)),d._dispatch(a,b,{elements:f,params:i})})},invalidForm:function(){var a,b,c,d,e,f;b=$("#"+this.resourceName+"-"+this.elementName),e=this.resource.errors,f=[];for(a in e)c=e[a],d=$("#"+this.resourceName+"-"+a+"-field"),d.length?(d.css("background","yellow"),f.push($("input",d).after("<output class='error'>"+c.join("\n")+"</output>"))):f.push(void 0);return f}},Tower.Controller.Events={ClassMethods:{DOM_EVENTS:["click","dblclick","blur","error","focus","focusIn","focusOut","hover","keydown","keypress","keyup","load","mousedown","mouseenter","mouseleave","mousemove","mouseout","mouseover","mouseup","mousewheel","ready","resize","scroll","select","submit","tap","taphold","swipe","swipeleft","swiperight"],dispatcher:global,addEventHandler:function(a,b,c){return c.type==="socket"||!eventType.match(this.DOM_EVENT_PATTERN)?this.addSocketEventHandler(a,b,c):this.addDomEventHandler(a,b,c)},socketNamespace:function(){return Tower.Support.String.pluralize(Tower.Support.String.camelize(this.name.replace(/(Controller)$/,""),!1))},addSocketEventHandler:function(a,b,c){var d=this;return this.io||(this.io=Tower.Application.instance().io.connect(this.socketNamespace())),this.io.on(a,function(a){return d._dispatch(void 0,b,a)})},addDomEventHandler:function(a,b,c){var d,e,f,g,h=this;return f=a.split(/\ +/),a=f.shift(),g=f.join(" "),g&&g!==""&&(c.target=g),c.target||(c.target="body"),d=a.split(/[\.:]/)[0],e=this[""+d+"Handler"],e?e.call(this,a,b,c):$(this.dispatcher).on(a,c.target,function(a){return h._dispatch(b,c)}),this},_dispatch:function(a,b){var c;return b==null&&(b={}),c=this.instance(),c.elements||(c.elements={}),c.params||(c.params={}),b.params&&_.extend(c.params,b.params),b.elements&&_.extend(c.elements,b.elements),typeof a=="string"?c[a].call(c,event):a.call(c,event)}}},Tower.Controller.Events.ClassMethods.DOM_EVENT_PATTERN=new RegExp("^("+Tower.Controller.Events.ClassMethods.DOM_EVENTS.join("|")+")"),Tower.Controller.include(Tower.Controller.Elements),Tower.Controller.include(Tower.Controller.Events),Tower.Dispatch={},Tower.Dispatch.Agent=function(){function a(a){a==null&&(a={}),_.extend(this,a)}return a.prototype.toJSON=function(){return{family:this.family,major:this.major,minor:this.minor,patch:this.patch,version:this.version,os:this.os,name:this.name}},a}(),Tower.Dispatch.Cookies=function(){function a(a){var b,c;a==null&&(a={});for(b in a)c=a[b],this[b]=c}return a.parse=function(a){var b,c,d,e,f,g,h;a==null&&(a=document.cookie),e={},d=a.split(/[;,] */);for(g=0,h=d.length;g<h;g++){c=d[g],b=c.indexOf("="),key=c.substring(0,b).trim().toLowerCase(),f=c.substring(++b,c.length).trim(),'"'===f[0]&&(f=f.slice(1,-1));if(e[key]===void 0){f=f.replace(/\+/g," ");try{e[key]=decodeURIComponent(f)}catch(i){if(i instanceof URIError)e[key]=f;else throw err}}}return new this(e)},a}(),Tower.Dispatch.Param=function(){function a(a,b){b==null&&(b={}),this.controller=b.controller,this.key=a,this.attribute=b.as||this.key,this.modelName=b.modelName,typeof modelName!="undefined"&&modelName!==null&&(this.namespace=Tower.Support.String.pluralize(this.modelName)),this.exact=b.exact||!1,this["default"]=b["default"]}return a.perPage=20,a.sortDirection="ASC",a.sortKey="sort",a.limitKey="limit",a.pageKey="page",a.separator="_",a.create=function(a,b){return b.type||(b.type="String"),new Tower.Dispatch.Param[b.type](a,b)},a.prototype.parse=function(a){return a},a.prototype.render=function(a){return a},a.prototype.toCriteria=function(a){var b,c,d,e,f,g,h,i,j,k,l;e=this.parse(a),c=new Tower.Model.Criteria;for(i=0,j=e.length;i<j;i++){h=e[i];for(l=0,k=h.length;l<k;l++)d=h[l],b=d.attribute,f=d.operators[0],g={},f==="$eq"?g[b]=d.value:(g[b]={},g[b][f]=d.value),c.where(g)}return c},a.prototype.parseValue=function(a,b){return{namespace:this.namespace,key:this.key,operators:b,value:a,attribute:this.attribute}},a.prototype._clean=function(a){return a.replace(/^-/,"").replace(/^\+-/,"").replace(/^'|'$/,"").replace("+"," ").replace(/^\^/,"").replace(/\$$/,"").replace(/^\s+|\s+$/,"")},a}(),Tower.Dispatch.Param.Array=function(){function a(){a.__super__.constructor.apply(this,arguments)}return __extends(a,Tower.Dispatch.Param),a.prototype.parse=function(a){var b,c,d,e,f,g,h,i=this;f=[],b=a.toString().split(/[,\|]/);for(g=0,h=b.length;g<h;g++)e=b[g],c=!1,d=!!e.match(/^\^/),e=e.replace(/^\^/,""),e.replace(/([^\.]+)?(\.{2})([^\.]+)?/,function(a,b,d,e){var g;return c=!0,g=[],!!b&&!!b.match(/^\d/)&&g.push(i.parseValue(b,["$gte"])),!!e&&!!e.match(/^\d/)&&g.push(i.parseValue(e,["$lte"])),f.push(g)}),c||f.push([this.parseValue(e,["$eq"])]);return f},a}(),Tower.Dispatch.Param.Date=function(){function a(){a.__super__.constructor.apply(this,arguments)}return __extends(a,Tower.Dispatch.Param),a.prototype.parse=function(a){var b,c,d,e,f,g,h=this;e=[],b=a.toString().split(/[\s,\+]/);for(f=0,g=b.length;f<g;f++)d=b[f],c=!1,d.replace(/([^\.]+)?(\.\.)([^\.]+)?/,function(a,b,d,f){var g;return c=!0,g=[],!!b&&!!b.match(/^\d/)&&g.push(h.parseValue(b,["$gte"])),!!f&&!!f.match(/^\d/)&&g.push(h.parseValue(f,["$lte"])),e.push(g)}),c||e.push([this.parseValue(d,["$eq"])]);return e},a.prototype.parseValue=function(b,c){return a.__super__.parseValue.call(this,Tower.date(b),c)},a}(),Tower.Dispatch.Param.Number=function(){function a(){a.__super__.constructor.apply(this,arguments)}return __extends(a,Tower.Dispatch.Param),a.prototype.parse=function(a){var b,c,d,e,f,g,h,i=this;f=[],b=a.toString().split(/[,\|]/);for(g=0,h=b.length;g<h;g++)e=b[g],c=!1,d=!!e.match(/^\^/),e=e.replace(/^\^/,""),e.replace(/([^\.]+)?(\.{2})([^\.]+)?/,function(a,b,d,e){var g;return c=!0,g=[],!!b&&!!b.match(/^\d/)&&g.push(i.parseValue(b,["$gte"])),!!e&&!!e.match(/^\d/)&&g.push(i.parseValue(e,["$lte"])),f.push(g)}),c||f.push([this.parseValue(e,["$eq"])]);return f},a.prototype.parseValue=function(b,c){return a.__super__.parseValue.call(this,parseFloat(b),c)},a}(),Tower.Dispatch.Param.String=function(){function a(){a.__super__.constructor.apply(this,arguments)}return __extends(a,Tower.Dispatch.Param),a.prototype.parse=function(a){var b,c,d,e,f,g=this;b=a.split(/(?:[\s|\+]OR[\s|\+]|\||,)/);for(c=0,f=b.length;c<f;c++)d=b[c],e=[],d.replace(/([\+\-\^]?[\w@_\s\d\.\$]+|-?\'[\w@-_\s\d\+\.\$]+\')/g,function(a,b){var c,d,f;return d=!1,c=!1,b=b.replace(/^(\+?-+)/,function(a,b){return d=b&&b.length>0,""}),b=b.replace(/^\'(.+)\'$/,function(a,b){return c=b&&b.length>0,b}),d?f=[c?"$neq":"$notMatch"]:f=[c?"$eq":"$match"],!b.match(/^\+?\-?\^/)||f.push("^"),!b.match(/\$$/)||f.push("$"),e.push(g.parseValue(g._clean(b),f)),a}),b[c]=e;return b},a}(),Tower.Dispatch.Route=function(){function a(a){a||(a=a),this.path=a.path,this.name=a.name,this.method=(a.method||"GET").toUpperCase(),this.ip=a.ip,this.defaults=a.defaults||{},this.constraints=a.constraints,this.options=a,this.controller=a.controller,this.keys=[],this.pattern=this.extractPattern(this.path),this.id=this.path,this.controller&&(this.id+=this.controller.name+this.controller.action)}return __extends(a,Tower.Class),a.store=function(){return this._store||(this._store=[])},a.create=function(a){return this.store().push(a)},a.all=function(){return this.store()},a.clear=function(){return this._store=[]},a.draw=function(a){return a.apply(new Tower.Dispatch.Route.DSL(this))},a.findController=function(a,b,c){var d,e,f,g,h;f=Tower.Route.all();for(g=0,h=f.length;g<h;g++){e=f[g],d=e.toController(a);if(d)break}return d?d.call(a,b,function(){return c(d)}):c(null),d},a.prototype.toController=function(a){var b,c,d,e,f,g,h,i;f=this.match(a);if(!f)return null;g=a.method.toLowerCase(),e=this.keys,h=Tower.Support.Object.extend({},this.defaults,a.query||{},a.body||{}),f=f.slice(1);for(d=0,i=f.length;d<i;d++)b=f[d],h[e[d].name]=b?decodeURIComponent(b):null;return c=this.controller,c&&(h.action=c.action),a.params=h,c&&(c=new(Tower.constant(Tower.namespaced(this.controller.className)))),c},a.prototype.match=function(a){var b,c;return typeof a=="string"?this.pattern.exec(a):(c=a.location.path,a.method.toUpperCase()!==this.method?null:(b=this.pattern.exec(c),b?this.matchConstraints(a)?b:null:null))},a.prototype.matchConstraints=function(a){var b,c,d,e;b=this.constraints;switch(typeof b){case"object":e=[];for(c in b){d=b[c];switch(typeof d){case"string":case"number":if(a[c]!==d)return!1;e.push(void 0);break;case"function":case"object":if(!a.location[c].match(d))return!1;e.push(void 0);break;default:e.push(void 0)}}return e;case"function":return b.call(a,a);default:return!1}},a.prototype.urlFor=function(a){var b,c,d;a==null&&(a={}),c=this.path;for(b in a)d=a[b],c=c.replace(new RegExp(":"+b+"\\??","g"),d);return c=c.replace(new RegExp("\\.?:\\w+\\??","g"),""),c},a.prototype.extractPattern=function(a,b,c){var d;return a instanceof RegExp?a:(d=this,a==="/"?new RegExp("^"+a+"$"):(a=a.replace(/(\(?)(\/)?(\.)?([:\*])(\w+)(\))?(\?)?/g,function(a,b,c,e,f,g,h,i){var j,k;i=!!i||b+h==="()",k=f==="*",d.keys.push({name:g,optional:!!i,splat:k}),c||(c=""),j="";if(!i||!k)j+=c;return j+="(?:",e!=null?j+=k?"\\.([^.]+?)":"\\.([^/.]+?)":j+=k?"/?(.+)":"([^/\\.]+)",j+=")",i&&(j+="?"),j}),new RegExp("^"+a+"$",b?"":"i")))},a}(),Tower.Route=Tower.Dispatch.Route,Tower.Dispatch.Route.DSL=function(){function a(){this._scope={}}return a.prototype.match=function(){return this.scope||(this.scope={}),Tower.Dispatch.Route.create(new Tower.Dispatch.Route(this._extractOptions.apply(this,arguments)))},a.prototype.get=function(){return this.matchMethod("get",Tower.Support.Array.args(arguments))},a.prototype.post=function(){return this.matchMethod("post",Tower.Support.Array.args(arguments))},a.prototype.put=function(){return this.matchMethod("put",Tower.Support.Array.args(arguments))},a.prototype["delete"]=function(){return this.matchMethod("delete",Tower.Support.Array.args(arguments))},a.prototype.matchMethod=function(a,b){var c,d,e;return typeof b[b.length-1]=="object"?d=b.pop():d={},c=b.shift(),d.method=a,d.action=c,d.name=c,this._scope.name&&(d.name=this._scope.name+Tower.Support.String.camelize(d.name)),e="/"+c,this._scope.path&&(e=this._scope.path+e),this.match(e,d),this},a.prototype.scope=function(a,b){var c;return a==null&&(a={}),c=this._scope||(this._scope={}),this._scope=Tower.Support.Object.extend({},c,a),b.call(this),this._scope=c,this},a.prototype.controller=function(a,b,c){return b.controller=a,this.scope(b,c)},a.prototype.namespace=function(a,b,c){return typeof b=="function"?(c=b,b={}):b={},b=Tower.Support.Object.extend({name:a,path:a,as:a,module:a,shallowPath:a,shallowPrefix:a},b),b.name&&this._scope.name&&(b.name=this._scope.name+Tower.Support.String.camelize(b.name)),this.scope(b,c)},a.prototype.constraints=function(a,b){return this.scope({constraints:a},b)},a.prototype.defaults=function(a,b){return this.scope({defaults:a},b)},a.prototype.resource=function(a,b){return b==null&&(b={}),b.controller=a,this.match(""+a+"/new",Tower.Support.Object.extend({action:"new"},b)),this.match(""+a,Tower.Support.Object.extend({action:"create",method:"POST"},b)),this.match(""+a+"/",Tower.Support.Object.extend({action:"show"},b)),this.match(""+a+"/edit",Tower.Support.Object.extend({action:"edit"},b)),this.match(""+a,Tower.Support.Object.extend({action:"update",method:"PUT"},b)),this.match(""+a,Tower.Support.Object.extend({action:"destroy",method:"DELETE"},b))},a.prototype.resources=function(a,b,c){var d,e,f;return typeof b=="function"?(c=b,b={}):b={},b.controller||(b.controller=a),f="/"+a,this._scope.path&&(f=this._scope.path+f),this._scope.name?d=this._scope.name+Tower.Support.String.camelize(a):d=a,e=Tower.Support.String.singularize(d),this.match(""+f,Tower.Support.Object.extend({name:""+d,action:"index"},b)),this.match(""+f+"/new",Tower.Support.Object.extend({name:"new"+Tower.Support.String.camelize(e),action:"new"},b)),this.match(""+f,Tower.Support.Object.extend({action:"create",method:"POST"},b)),this.match(""+f+"/:id",Tower.Support.Object.extend({name:""+e,action:"show"},b)),this.match(""+f+"/:id/edit",Tower.Support.Object.extend({name:"edit"+Tower.Support.String.camelize(e),action:"edit"},b)),this.match(""+f+"/:id",Tower.Support.Object.extend({action:"update",method:"PUT"},b)),this.match(""+f+"/:id",Tower.Support.Object.extend({action:"destroy",method:"DELETE"},b)),c&&this.scope(Tower.Support.Object.extend({path:""+f+"/:"+Tower.Support.String.singularize(a)+"Id",name:e},b),c),this},a.prototype.collection=function(){},a.prototype.member=function(){},a.prototype.root=function(a){return this.match("/",Tower.Support.Object.extend({as:"root"},a))},a.prototype._extractOptions=function(){var a,b,c,d,e,f,g,h,i,j;return b=Tower.Support.Array.args(arguments),j="/"+b.shift().replace(/^\/|\/$/,""),typeof b[b.length-1]=="object"?i=b.pop():i={},b.length>0&&(i.to||(i.to=b.shift())),i.path=j,f=this._extractFormat(i),i.path=this._extractPath(i),g=this._extractRequestMethod(i),c=this._extractConstraints(i),e=this._extractDefaults(i),d=this._extractController(i),a=this._extractAnchor(i),h=this._extractName(i),i=Tower.Support.Object.extend(i,{method:g,constraints:c,defaults:e,name:h,format:f,controller:d,anchor:a,ip:i.ip}),i},a.prototype._extractFormat=function(a){},a.prototype._extractName=function(a){return a.as||a.name},a.prototype._extractConstraints=function(a){return Tower.Support.Object.extend(this._scope.constraints||{},a.constraints||{})},a.prototype._extractDefaults=function(a){return a.defaults||{}},a.prototype._extractPath=function(a){return""+a.path+".:format?"},a.prototype._extractRequestMethod=function(a){return(a.method||a.via||"GET").toUpperCase()},a.prototype._extractAnchor=function(a){return a.anchor},a.prototype._extractController=function(a){var b,c,d;a==null&&(a={}),d=a.to,d&&(d=d.split("#"),d.length===1?b=d[0]:(c=d[0],b=d[1])),c||(c=a.controller||this._scope.controller),b||(b=a.action);if(!c)throw new Error("No controller was specified for the route "+a.path);return c=c.toLowerCase().replace(/(?:[cC]ontroller)?$/,"Controller"),{name:c,action:b,className:Tower.Support.String.camelize(""+c)}},a}(),Tower.Dispatch.Route.Urls={ClassMethods:{urlFor:function(a){var b,c,d,e,f;switch(typeof a){case"string":return a;default:return d=a.controller,b=a.action,e=a.host,f=a.port,c=a.anchor,a}}}},Tower.Dispatch.Route.PolymorphicUrls={ClassMethods:{polymorphicUrl:function(){}}},Tower.Dispatch.Route.include(Tower.Dispatch.Route.Urls),Tower.Dispatch.Route.include(Tower.Dispatch.Route.PolymorphicUrls),Tower.Dispatch.Request=function(){function a(a){a==null&&(a={}),this.url=a.url,this.location=a.location,this.pathname=this.location.path,this.query=this.location.query,this.title=a.title,this.title||(this.title=typeof document!="undefined"&&document!==null?document.title:void 0),this.body=a.body||{},this.headers=a.headers||{},this.method=a.method||"GET"}return a}(),Tower.Dispatch.Response=function(){function a(a){a==null&&(a={}),this.url=a.url,this.location=a.location,this.pathname=this.location.path,this.query=this.location.query,this.title=a.title,this.title||(this.title=typeof document!="undefined"&&document!==null?document.title:void 0),this.body=a.body||{},this.headers=a.headers||{},this.headerSent=!1,this.statusCode=200,this.body=""}return a.prototype.writeHead=function(a,b){return this.statusCode=a,this.headers=b},a.prototype.setHeader=function(a,b){if(this.headerSent)throw new Error("Headers already sent");return this.headers[a]=b},a.prototype.write=function(a){return a==null&&(a=""),this.body+=a},a.prototype.end=function(a){return a==null&&(a=""),this.body+=a,this.sent=!0,this.headerSent=!0},a}(),Tower.Dispatch.Url=function(){function a(a,b,c){b==null&&(b=1),this.strictMode=c||!1,this.depth=b||1,typeof window!="undefined"&&window!==null&&(this.url=a||(a=window.location.toString())),this.parse(a)}return a.key=["source","protocol","host","userInfo","user","password","hostname","port","relative","path","directory","file","query","fragment"],a.aliases={anchor:"fragment"},a.parser={strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/},a.querystringParser=/(?:^|&|;)([^&=;]*)=?([^&;]*)/g,a.fragmentParser=/(?:^|&|;)([^&=;]*)=?([^&;]*)/g,a.typeParser=/(youtube|vimeo|eventbrite)/,a.prototype.parse=function(a){var b,c,d,e,f,g,h,i;f=this.constructor.key,a=decodeURI(a),h=this.constructor.parser[this.strictMode||!1?"strict":"loose"].exec(a),b={},this.params=g={},this.fragment=d={params:{}},e=14;while(e--)b[f[e]]=h[e]||"";b.query.replace(this.constructor.querystringParser,function(a,b,c){if(b)return g[b]=c}),b.fragment.replace(this.constructor.fragmentParser,function(a,b,c){if(b)return d.params[b]=c}),this.segments=b.path.replace(/^\/+|\/+$/g,"").split("/"),d.segments=b.fragment.replace(/^\/+|\/+$/g,"").split("/");for(f in b)i=b[f],this[f]||(this[f]=i);this.root=b.host?b.protocol+"://"+b.hostname+(b.port?":"+b.port:""):"",c=this.hostname.split("."),this.domain=c.slice(c.length-1-this.depth,c.length-1+1||9e9).join("."),this.subdomains=c.slice(0,c.length-2-this.depth+1||9e9),this.subdomain=this.subdomains.join(".");if(this.port!=null)return this.port=parseInt(this.port)},a}(),Tower.Middleware={},Tower.Middleware.Location=function(a,b,c){var d;return a.location||(a.url.match(/^http/)?d=a.url:d="http://"+a.headers.host+a.url,a.location=new Tower.Dispatch.Url(d)),c()},Tower.Middleware.Router=function(a,b,c){return Tower.Middleware.Router.find(a,b,function(c){return c?(b.controller=c,b.writeHead(c.status,c.headers),b.write(c.body),b.end(),c.clear()):Tower.Middleware.Router.error(a,b)}),b},Tower.Support.Object.extend(Tower.Middleware.Router,{find:function(a,b,c){return this.processHost(a,b),this.processAgent(a,b),Tower.Dispatch.Route.findController(a,b,c)},processHost:function(a,b){return a.location||(a.location=new Tower.Dispatch.Url(a.url))},processAgent:function(a,b){if(a.headers)return a.userAgent||(a.userAgent=a.headers["user-agent"])},error:function(a,b){if(b)return b.statusCode=404,b.setHeader("Content-Type","text/plain"),b.end("No path matches "+a.url)}})})).call(this)